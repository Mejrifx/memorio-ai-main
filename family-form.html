<!DOCTYPE html><!--  Last Published: Sun Oct 05 2025 01:03:38 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="683b63acf5908465c8825cb3" data-wf-site="683b63acf5908465c8825ca8">
<head>
  <meta charset="utf-8">
  <title>MEMORIO FORMS</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Preload Dosis font to prevent FOUC -->
  <link rel="preload" href="fonts/Dosis-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/memorio-forms.webflow.css" rel="stylesheet" type="text/css">
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.png" rel="apple-touch-icon">
  <link href="https://www.memorio.ai" rel="canonical">
  <script src="https://cdn.prod.website-files.com/683b63acf5908465c8825ca8%2F685146e1d8a68f749232b664%2F68ae0b3dfa796259386da2c8%2Fimportucanddefinelocales-1.1.1.js" type="text/javascript"></script>
  <script src="https://cdn.prod.website-files.com/683b63acf5908465c8825ca8%2F685146e1d8a68f749232b664%2F68ae0b3ee913e1d7f8841a9b%2Fcssimporter-0.0.1.js" type="text/javascript"></script>
  
  <!-- Supabase Client for Authentication and Database -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Hide form content initially to prevent flashing -->
  <style>
    .form-container, .form-wrapper, .w-form {
      display: none !important;
    }
    .form-container.show, .form-wrapper.show, .w-form.show {
      display: block !important;
    }
    
    /* Hide Webflow nav button (4-square grid icon) */
    .w-nav-button {
      display: none !important;
    }
    
    /* Don't hide accordion bodies by default - let existing functionality work */
    /* Accordion bodies will be controlled by JavaScript */
    
    /* Responsive sign-out button for mobile */
    @media (max-width: 768px) {
      #signOutBtn {
        position: absolute !important;
        right: 10px !important;
        top: 10px !important;
        transform: none !important;
        width: 40px !important;
        height: 40px !important;
        padding: 8px !important;
        border-radius: 50% !important;
        font-size: 0 !important; /* Hide text */
        display: flex !important;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      
      /* Show icon only on mobile */
      #signOutBtn::before {
        content: '';
        display: block;
        width: 20px;
        height: 20px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        font-size: 20px;
      }
      
      .nav {
        position: relative !important;
        padding: 0 !important;
        margin: 0 !important;
        min-height: auto !important;
        padding-top: 10px !important;
      }
      
      .logo-wrapper {
        margin: 0 auto !important;
        margin-top: -45px !important;
        text-align: center !important;
        padding: 0 !important;
        display: block !important;
      }
      
      /* Push form content back down to original position */
      .form-slider-padding {
        margin-top: 45px !important;
      }
    }
    
    /* Modal styles matching Director portal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .modal-content {
      background-color: #fff3e9;
      border: 3px solid #436481;
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      animation: modalFadeIn 0.3s ease;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #436481;
    }
    
    .modal-title {
      color: #32343a;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    
    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #32343a;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .form-input {
      padding: 12px 16px;
      border: 1.5px solid #436481;
      border-radius: 8px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      font-size: 15px;
      background-color: #f2eadd;
      color: #32343a;
      transition: all 0.2s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #6ca7d3;
      background-color: #ffffff;
    }
    
    .form-input::placeholder {
      color: #32343a;
      opacity: 0.4;
    }
    
    .btn-primary {
      background-color: #32343a;
      color: #f2eadd;
      border: 1.5px solid #32343a;
      border-radius: 60px;
      padding: 14px 32px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: #6ca7d3;
      border-color: #6ca7d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108, 167, 211, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .error-box {
      background-color: #ffebee;
      border: 2px solid #ef5350;
      border-radius: 12px;
      padding: 15px;
      color: #c62828;
      margin-bottom: 16px;
      display: none;
      font-weight: 500;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Password change success modal button hover effect */
    #passwordChangeProceedBtn:hover {
      background-color: #355a6f !important;
    }
    
    #passwordChangeProceedBtn:active {
      background-color: #2a4758 !important;
      transform: scale(0.98);
    }
  </style>
</head>
<body class="body">
  <!-- Login Modal -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background-color: #fff3e9; border: 3px solid #436481; border-radius: 20px; padding: 48px; max-width: 500px; width: 90%; box-shadow: 0 2px 8px -2px rgba(0,0,0,0.2);">
      <h1 style="color: #32343a; text-align: center; font-size: 32px; font-weight: 600; margin-bottom: 10px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">Family Portal</h1>
      <p style="color: #32343a; text-align: center; font-size: 16px; margin-bottom: 30px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">Sign in to complete your obituary form</p>
      
      <div id="loginError" style="display: none; background-color: #ffebee; border: 1px solid #ef5350; color: #c62828; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;"></div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #32343a; font-size: 14px; font-weight: 600; margin-bottom: 8px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">Email Address</label>
          <input type="email" 
                 id="loginEmail" 
                 style="width: 100%; padding: 12px; border: 2px solid #436481; border-radius: 8px; font-size: 16px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif; background-color: #ffffff; box-sizing: border-box;"
                 placeholder="Enter your email"
                 required>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #32343a; font-size: 14px; font-weight: 600; margin-bottom: 8px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">Password</label>
          <input type="password" 
                 id="loginPassword" 
                 style="width: 100%; padding: 12px; border: 2px solid #436481; border-radius: 8px; font-size: 16px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif; background-color: #ffffff; box-sizing: border-box;"
                 placeholder="Enter your password"
                 required>
        </div>
        
        <button type="submit" 
                id="loginBtn"
                style="width: 100%; padding: 14px; background-color: #436481; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Dosis Variablefont Wght', Arial, sans-serif; transition: background-color 0.2s;">
          Sign In
        </button>
      </form>
      
      <p style="text-align: center; color: #666; font-size: 14px; margin-top: 20px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">
        Don't have login credentials?<br>
        Contact your funeral director for access.
      </p>
    </div>
  </div>

  <!-- ============================================================================
       PASSWORD CHANGE MODAL (First Login) - Matches Director Portal
       ============================================================================ -->
  <div id="passwordChangeModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">üîí Change Your Password</h2>
      </div>
      
      <div style="padding: 0 8px;">
        <p style="margin-bottom: 20px; color: #32343a; font-size: 15px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">
          For security reasons, you must change your temporary password before accessing your account.
        </p>
        
        <form id="passwordChangeForm" onsubmit="handlePasswordChange(event)">
          <div class="form-group">
            <label for="newPassword" class="form-label">New Password*</label>
            <input 
              class="form-input" 
              type="password" 
              id="newPassword" 
              placeholder="Enter new password" 
              minlength="8"
              required>
            <small style="color: rgba(50, 52, 58, 0.6); font-size: 12px; display: block; margin-top: 4px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">
              Must be at least 8 characters
            </small>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword" class="form-label">Confirm New Password*</label>
            <input 
              class="form-input" 
              type="password" 
              id="confirmPassword" 
              placeholder="Confirm new password" 
              minlength="8"
              required>
          </div>
          
          <div id="passwordChangeError" class="error-box" style="display: none;"></div>
          
          <button type="submit" class="btn-primary" id="passwordChangeBtn" style="width: 100%;">
            CHANGE PASSWORD
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Password Change Success Modal -->
  <div id="passwordChangeSuccessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10001; justify-content: center; align-items: center;">
    <div style="background-color: #fff3e9; border: 3px solid #436481; border-radius: 20px; padding: 48px; max-width: 500px; width: 90%; box-shadow: 0 2px 8px -2px rgba(0,0,0,0.2); text-align: center;">
      <!-- Success Icon -->
      <div style="width: 80px; height: 80px; margin: 0 auto 24px; background-color: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <svg style="width: 48px; height: 48px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      
      <h1 style="color: #32343a; text-align: center; font-size: 32px; font-weight: 600; margin-bottom: 10px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">Password Updated!</h1>
      <p style="color: #32343a; text-align: center; font-size: 16px; margin-bottom: 30px; font-family: 'Dosis Variablefont Wght', Arial, sans-serif;">Your password has been successfully changed. You can now proceed with the form.</p>
      
      <button type="button" 
              id="passwordChangeProceedBtn"
              onclick="hidePasswordChangeSuccessModal()"
              style="width: 100%; padding: 14px; background-color: #436481; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Dosis Variablefont Wght', Arial, sans-serif; transition: background-color 0.2s;">
        Proceed
      </button>
    </div>
  </div>

  <div class="nav" style="position: relative; padding: 0 20px;">
    <div class="logo-wrapper"><img src="images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png" loading="lazy" width="166" sizes="166px" alt="The Memorio Logo" srcset="images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview-p-500.png 500w, images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview-p-800.png 800w, images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png 838w"></div>
    <button id="signOutBtn" onclick="handleSignOut()" title="Sign Out" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); padding: 10px 24px; background-color: #436481; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Dosis Variablefont Wght', Arial, sans-serif; transition: background-color 0.2s; display: none;" onmouseover="this.style.backgroundColor='#1e3a52'" onmouseout="this.style.backgroundColor='#436481'">Sign Out</button>
  </div>
  <div class="form-slider-padding">
    <div class="w-form">
      <form id="wf-form-memorio_obituary_form" name="wf-form-memorio_obituary_form" data-name="memorio_obituary_form" method="get" class="form-2" data-wf-page-id="683b63acf5908465c8825cb3" data-wf-element-id="faaf2315-7be8-4814-9169-c55030b0674d">
        <!-- Step 1 removed: customer name/email (collected by director) -->
        <div data-w-id="d026be39-46e7-e794-7d04-b04fb7e8fd1c" class="form-slider-step-1">
          <div class="form-title">
            <div class="text-block">Memorios Obituary Writer</div>
            <h1 class="heading-2" id="welcome-heading">Lets begin!</h1>
          </div>
          <div class="form-bubbles">
            <div class="bubble-container">
              <p class="paragraph">Take your time, each question helps us gently piece together a heartfelt memory. There's no rush, and you can always go back.</p>
            </div>
          </div>
          <div class="form-questions">
            <div class="form-box">
              <div class="form-fields">
                <!-- Hidden fields for n8n (auto-populated from director's input) -->
                <input type="hidden" id="loved_ones_name" name="loved_ones_name" value="">
                <input type="hidden" id="loved_ones_last_name" name="loved_ones_last_name" value="">
                <input type="hidden" id="loved_ones_gender" name="loved_ones_gender" value="">
                <input type="hidden" id="funeral_home" name="funeral_home" value="">
                
                <!-- Hidden date/city fields (auto-populated from director's input) -->
                <input type="hidden" id="month_of_birth" name="month_of_birth" value="">
                <input type="hidden" id="day_of_birth" name="day_of_birth" value="">
                <input type="hidden" id="year_of_birth" name="year_of_birth" value="">
                <input type="hidden" id="date_of_birth" name="date_of_birth" value="">
                <input type="hidden" id="city_of_birth" name="city_of_birth" value="">
                <input type="hidden" id="state_of_birth" name="state_of_birth" value="">
                <input type="hidden" id="country_of_birth" name="country_of_birth" value="United States">
                
                <input type="hidden" id="month_of_passing" name="month_of_passing" value="">
                <input type="hidden" id="day_of_passing" name="day_of_passing" value="">
                <input type="hidden" id="year_of_passing" name="year_of_passing" value="">
                <input type="hidden" id="date_of_passing" name="date_of_passing" value="">
                <input type="hidden" id="city_of_passing" name="city_of_passing" value="">
                <input type="hidden" id="state_of_passing" name="state_of_passing" value="">
                <input type="hidden" id="country_of_passing" name="country_of_passing" value="United States">
                
                <!-- Loved one's name/gender removed from UI: collected by director in case creation -->
                <label for="loved_ones_salutation" class="field-label loved-ones-name other-names">Any other names you&#x27;d like to include for <span id="deceased-name-display"></span>?</label><input class="text-field loved-ones-first-name salutation w-input" maxlength="256" name="loved_ones_salutation" data-name="loved_ones_salutation" placeholder="Salutation" type="text" id="loved_ones_salutation"><input class="text-field loved-ones-first-name middle-name w-input" maxlength="256" name="loved_ones_middle_name" data-name="loved_ones_middle_name" placeholder="Middle Name" type="text" id="loved_ones_middle_name"><input class="text-field loved-ones-first-name nickname w-input" maxlength="256" name="loved_ones_nickname" data-name="loved_ones_nickname" placeholder="Nickname" type="text" id="loved_ones_nickname"><input class="text-field loved-ones-first-name maiden-name w-input" maxlength="256" name="loved_ones_maiden_name" data-name="loved_ones_maiden_name" placeholder="Maiden Name" type="text" id="loved_ones_maiden_name"><select id="loved_ones_suffix" name="loved_ones_suffix" data-name="loved_ones_suffix" class="select-field suffix w-select">
                  <option value="Another option">Suffix (Jr, Sr, etc.)</option>
                  <option value="Junior">Jr.</option>
                  <option value="Senior">Sr.</option>
                  <option value="The second">II</option>
                  <option value="The third">III</option>
                </select>
                <div class="text-block-2">*Required Fields</div>
              </div>
              <div class="form-button">
                <a href="#" class="button-primary get-started next w-button">NEXT</a>
                <div data-w-id="4d498b7d-9bc8-ceed-117d-c4aa28126788" class="div-block back">ÔÅ†</div>
                <div data-w-id="793327fe-8485-9407-6612-d7d9119ceaf3" class="div-block">NEXT</div><input type="submit" data-wait="Please wait..." class="submit-button w-button" value="SUBMIT">
              </div>
            </div>
          </div>
        </div>
        <div data-w-id="fc0a8b98-fbbd-79d8-65f0-f4ae52dcb201" class="form-slider-step-1 upload">
          <div class="form-title">
            <div class="text-block">Memorios Obituary Writer</div>
            <h1 class="heading-2" id="visualize-story-heading">Visualize Your Loved Ones Story</h1>
          </div>
          <div class="form-bubbles">
            <div class="bubble-container">
              <p class="paragraph"><em class="italic-text">Every life is a collection of beautiful moments. Upload photos to help us honor your loved one‚Äôs journey.</em></p>
            </div>
          </div>
          <div class="form-questions">
            <div class="form-box optionals">
              <div class="form-fields">
                <label for="photo_upload" class="field-label" id="upload-images-label">Upload your images below</label>
                <div style="margin-bottom: 20px;">
                  <input 
                    type="file" 
                    id="photo_upload" 
                    name="photo_upload" 
                    accept="image/*" 
                    multiple 
                    style="display: none;">
                  <button 
                    type="button" 
                    onclick="document.getElementById('photo_upload').click()" 
                    class="button" 
                    style="padding: 12px 24px; margin-bottom: 10px;">
                    üì∑ Select Photos
                  </button>
                  <div id="photo-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;"></div>
                </div>
                <label for="tribute_quote" class="field-label quote">Is there a favorite quote, verse, or saying you&#x27;d like us to include in the tribute video?</label>
                <textarea placeholder="Something they always said or something that reminds you of them and captures their spirit." maxlength="5000" id="tribute_quote" name="tribute_quote" data-name="tribute_quote" class="textarea tribute w-input"></textarea>
                <div class="text-block-2">*Required Fields</div>
              </div>
              <div class="form-button">
                <a href="#" class="button-primary get-started next w-button">NEXT</a>
                <div data-w-id="fc0a8b98-fbbd-79d8-65f0-f4ae52dcb217" class="div-block back">ÔÅ†</div><input type="submit" data-wait="Please wait..." class="submit-button w-button" value="SUBMIT">
                <div data-w-id="fc0a8b98-fbbd-79d8-65f0-f4ae52dcb219" class="div-block">Next</div>
              </div>
            </div>
          </div>
        </div>
        <div data-w-id="fe767c75-255d-9930-5bf8-034b8f1e0a31" class="form-slider-step-1 finalcheck-step7">
          <div class="form-title">
            <div class="text-block">Memorios Obituary Writer</div>
            <h1 class="heading-2">Would You Like to Add Any Special Details?</h1>
          </div>
          <div class="form-bubbles">
            <div class="bubble-container">
              <p class="paragraph">Almost done, just review the information and add any final details of your choice. Once you submit your obituary will be created.</p>
            </div>
          </div>
          <div class="form-questions">
            <div class="form-box optional">
              <div class="form-fields"><label for="final_details" class="field-label final">Is there anything else you want to include in the Obituary?</label>
                <div class="faq-container form-accordion">
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3"><strong>Family Members</strong></div><img data-w-id="355de858-8660-8848-d84b-14932cd1c054" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="5291f307-65ce-4239-023b-a9d65d8512ce" class="div-block accordion save">Save</div>
                      <div data-w-id="e3e1811b-d293-684d-c4c9-f12023ec2623" class="div-block accordion _1">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="family_members" class="field-label accordion">Who were the important people in their life?</label><textarea id="family_members" name="family_members" maxlength="5000" data-name="family_members" placeholder="Please share the names of parents, siblings, children, close relatives, or dear friends who were important in their life." class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3">Personal Details</div><img data-w-id="4f9a1331-d813-e52d-e502-604643707e72" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="4f9a1331-d813-e52d-e502-604643707e73" class="div-block accordion save">Save</div>
                      <div data-w-id="4f9a1331-d813-e52d-e502-604643707e75" class="div-block accordion _1">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="loved_ones_age" class="field-label accordion">How old were they?</label><input class="text-field w-input" maxlength="256" name="loved_ones_age" data-name="loved_ones_age" placeholder="Age" type="text" id="loved_ones_age"><label for="loved_ones_description" class="field-label accordion">Describe them as a person</label><textarea id="loved_ones_description" name="loved_ones_description" maxlength="5000" data-name="loved_ones_description" placeholder="What were they known for by loved ones?" class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3">Education</div><img data-w-id="355de858-8660-8848-d84b-14932cd1c05d" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="19bacba2-bf89-2428-730e-a4fe87d1a4f8" class="div-block accordion save">Save</div>
                      <div data-w-id="a6781175-ee91-77bb-6574-ac8127e6a6c2" class="div-block accordion _2">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="loved_ones_achievements" class="field-label accordion">What were their achievements?</label><textarea id="loved_ones_achievements" name="loved_ones_achievements" maxlength="5000" data-name="loved_ones_achievements" placeholder="List the name and location of schools they attended. Include degrees, certificates, or special honors they received. " class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3">Hobbies / Interests</div><img data-w-id="355de858-8660-8848-d84b-14932cd1c066" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="fdde6dd8-6663-9c97-df3e-2be9edee57b3" class="div-block accordion save">Save</div>
                      <div data-w-id="b9d1a5dc-e3a8-3583-4591-caffaec5cecc" class="div-block accordion _3">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="loved_ones_hobbies" class="field-label accordion">What stood out to them?</label><textarea id="loved_ones_hobbies" name="loved_ones_hobbies" maxlength="5000" data-name="loved_ones_hobbies" placeholder="List activities that or interests that were important to your loved one." class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3">Career Highlights</div><img data-w-id="355de858-8660-8848-d84b-14932cd1c06f" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="e450d333-1505-1d82-8d8e-da1ac73ca050" class="div-block accordion save">Save</div>
                      <div data-w-id="64dc0735-4929-d17f-182d-2f9100c58609" class="div-block accordion _4">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="loved_ones_career" class="field-label accordion">Tell us about their career highlights</label><textarea id="loved_ones_career" name="loved_ones_career" maxlength="5000" data-name="loved_ones_career" placeholder="List work experience and any related accomplishments. Feel free to include dates and proud moments." class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3">Religion / Spirituality</div><img data-w-id="355de858-8660-8848-d84b-14932cd1c078" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="44d8c571-cad4-6b83-7a3d-2f27a98fd88d" class="div-block accordion save">Save</div>
                      <div data-w-id="da074825-a62f-729f-cc75-75370d9dd7b8" class="div-block accordion _5">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="loved_ones_spiritual_beliefs" class="field-label accordion">What role did religion or spirituality have in their life?</label><textarea id="loved_ones_spiritual_beliefs" name="loved_ones_spiritual_beliefs" maxlength="5000" data-name="loved_ones_spiritual_beliefs" placeholder="List places of worship, acts of service, faith related travel, or important values your loved one held." class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                  <div class="faq-item">
                    <div class="faq-title">
                      <div class="text-block-3">Military Service</div><img data-w-id="355de858-8660-8848-d84b-14932cd1c081" loading="lazy" alt="" src="images/chevron-down-solid-full.svg" class="faq-item-icon">
                      <div data-w-id="ad3b1aa2-21b3-5e5c-62ac-a000c09d3126" class="div-block accordion save">Save</div>
                      <div data-w-id="1390af09-89b7-9820-63d1-fa3d873fbed0" class="div-block accordion _6">Add</div>
                    </div>
                    <div class="faq-body">
                      <div class="faq-body-inner">
                        <div class="form-fields"><label for="loved_ones_military_service" class="field-label accordion">Tell us about their military service</label><textarea id="loved_ones_military_service" name="loved_ones_military_service" maxlength="5000" data-name="loved_ones_military_service" placeholder="If they were a veteran, list the branch, rank, and time served, along with location." class="textarea w-input"></textarea></div>
                      </div>
                    </div>
                  </div>
                </div><label for="final_details" class="field-label finaldetails">Would you like to include any service or event information?</label><textarea placeholder="Add info about upcoming services: time, place, dress code, or anything guests should know." maxlength="5000" id="final_details" name="final_details" data-name="final_details" class="textarea w-input"></textarea>
              </div>
              <div class="form-button">
                <a href="#" class="button-primary get-started next w-button">NEXT</a>
                <div data-w-id="fe767c75-255d-9930-5bf8-034b8f1e0a46" class="div-block back">ÔÅ†</div>
                <div class="div-block finaldetails">NEXT</div><input type="submit" data-wait="Please wait..." class="submit-button last-finaldetails w-button" value="SUBMIT">
              </div>
            </div>
          </div>
        </div>
      </form>
      <div class="success-message w-form-done">
        <div id="memorio-success-container">
          <!-- Success content will be injected here by JavaScript -->
        </div>
      </div>
      <div class="w-form-fail">
        <div>Oops! Something went wrong while submitting the form.</div>
      </div>
    </div>
  </div>
  <style id="memorio-styles">
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Dosis', sans-serif;
            background-color: #f4e8de;
            color: #32343a;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        /* Header is present in the DOM but fully hidden (kills black title/tagline) */
        .header { display: none !important; }
        .writing-status {
            background-color: #fff3e9;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 2px 8px -2px rgba(0,0,0,0.2);
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .writing-status.fade-out {
            opacity: 0;
        }
        .status-text { font-size: 18px; margin-bottom: 15px; color: #436481; }
        .loading-dots { display: inline-flex; gap: 5px; }
        .dot { width: 8px; height: 8px; background-color: #436481; border-radius: 50%; animation: pulse 1.5s infinite; }
        .dot:nth-child(2) { animation-delay: .3s; }
        .dot:nth-child(3) { animation-delay: .6s; }
        @keyframes pulse { 0%,100%{opacity:.3} 50%{opacity:1} }
        .obituary-card { 
            background-color:#fff3e9; 
            border-radius:20px; 
            padding:25px; 
            margin-bottom:30px; 
            box-shadow:0 2px 8px -2px rgba(0,0,0,.2); 
        }
        .obituary-title { font-size:18px; color:#436481; margin-bottom:20px; font-weight:500; border:none; }
        .edit-hint { 
            font-size: 13px; 
            color: #7a8592; 
            text-align: center; 
            margin-top: 15px; 
            margin-bottom: 15px;
            font-style: italic; 
            opacity: 0.7;
            transition: opacity 0.3s ease;
            cursor: default;
        }
        .edit-hint:hover { 
            opacity: 0.9; 
        }
        .obituary-content {
            font-size: 18px; line-height: 1.8; color: #32343a; min-height: 200px; cursor: text;
            background-color: #fff3e9; border-radius: 20px; padding: 25px; box-shadow: 0 2px 8px -2px rgba(0,0,0,.2);
            border: none; outline: none; margin-top: 15px; font-weight: 400; word-wrap: break-word; white-space: pre-wrap;
        }
        .obituary-content:focus { outline:none; border:none; box-shadow:0 2px 8px -2px rgba(0,0,0,.2); }
        .obituary-content::selection { background-color: rgba(67,100,129,.2); }
        .obituary-content p { margin-bottom:20px; font-size:18px; line-height:1.8; color:#32343a; font-weight:400; }
        .obituary-content p:last-child { margin-bottom:0; }
        .obituary-content[contenteditable="true"] { box-shadow: 0 2px 8px -2px rgba(67,100,129,.3); }
        .typewriter-cursor { display:inline-block; width:2px; height:22px; background:#32343a; animation: blink 1s infinite; vertical-align:text-top; margin-left:2px; }
        @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:0} }
        .action-buttons { display:flex; justify-content:center; margin-top:30px; }
        .btn { background:#32343a; color:#fff; border:none; padding:15px 30px; font-size:16px; border-radius:60px; cursor:pointer; transition: all .3s ease; font-weight:500; }
        .btn:hover { background:#436481; transform: translateY(-2px); }
        .btn:disabled { background:#9ca3af; cursor: not-allowed; transform: none; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn .5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
        .memorial-info { background:#fff3e9; border-radius:20px; padding:25px; margin-bottom:20px; font-size:16px; color:#32343a; text-align:center; box-shadow:0 2px 8px -2px rgba(0,0,0,.2); }
        .memorio-container { max-width: 800px; margin: 0 auto; }
    </style>
            <script>
        // Production endpoints - will work when deployed to memorio.ai domain
        const ENDPOINT = "https://memorioo.app.n8n.cloud/webhook/memorio-intake";
        const EMAIL_ENDPOINT = "https://memorioo.app.n8n.cloud/webhook/send-email";
        
        // For local development, uncomment these lines and comment out the above:
        // const ENDPOINT = "http://localhost:3001/webhook/memorio-intake";
        // const EMAIL_ENDPOINT = "http://localhost:3001/webhook/send-email";
        
        // ============================================================================
        // SUPABASE CONFIGURATION
        // ============================================================================
        const SUPABASE_URL = 'https://gkabtvqwwuvigcdubwyv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrYWJ0dnF3d3V2aWdjZHVid3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDE5MjUsImV4cCI6MjA3NTQ3NzkyNX0.O1DfOR5FBm6r3Pg-tjEE5CkzRr3WlWqGU1xUYKrhtnU';
        const { createClient } = supabase;
        
        // Initialize Supabase client with proper session persistence (matching dashboard)
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                storage: window.localStorage,
                storageKey: 'memorio-family-auth', // Must match dashboard storage key
            }
        });
        
        // Global variables for authenticated user and case
        let currentUser = null;
        let currentCase = null;
        let selectedPhotos = []; // Store selected photo files
        
        // Redirect lock to prevent infinite loops between index.html and dashboard.html
        const REDIRECT_LOCK_KEY = 'memorio-family-redirect-lock';
        const REDIRECT_LOCK_DURATION = 3000; // 3 seconds
        
        function canRedirect() {
            const lastRedirect = sessionStorage.getItem(REDIRECT_LOCK_KEY);
            if (lastRedirect) {
                const timeSinceRedirect = Date.now() - parseInt(lastRedirect);
                if (timeSinceRedirect < REDIRECT_LOCK_DURATION) {
                    console.warn('‚ö†Ô∏è Redirect blocked - too soon since last redirect');
                    return false;
                }
            }
            return true;
        }
        
        function setRedirectLock() {
            sessionStorage.setItem(REDIRECT_LOCK_KEY, Date.now().toString());
        }
        
        // ============================================================================
        // LOGIN MODAL FUNCTIONS
        // ============================================================================
        
        /**
         * Show login modal overlay
         */
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'flex';
                // Hide the form while modal is showing
                const formSlider = document.querySelector('.form-slider-padding');
                if (formSlider) formSlider.style.display = 'none';
            }
        }
        
        /**
         * Hide login modal and show form
         */
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
                // Show the form after successful login
                const formSlider = document.querySelector('.form-slider-padding');
                if (formSlider) formSlider.style.display = 'block';
            }
        }
        
        /**
         * Show password change modal (first-time login)
         */
        function showPasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            if (modal) {
                modal.style.display = 'flex';
                // Hide both login modal and form
                hideLoginModal();
                const formSlider = document.querySelector('.form-slider-padding');
                if (formSlider) formSlider.style.display = 'none';
            }
        }
        
        /**
         * Hide password change modal
         */
        function hidePasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Restore form visibility (it was hidden when modal was shown)
            const formSlider = document.querySelector('.form-slider-padding');
            if (formSlider) {
                formSlider.style.display = 'block';
            }
        }
        
        /**
         * Show password change success modal
         */
        function showPasswordChangeSuccessModal() {
            const modal = document.getElementById('passwordChangeSuccessModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        /**
         * Hide password change success modal and proceed with form
         */
        async function hidePasswordChangeSuccessModal() {
            const modal = document.getElementById('passwordChangeSuccessModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Proceed with authentication and form loading
            const authSuccess = await checkAuthentication();
            
            if (authSuccess) {
                console.log('‚úÖ Authentication successful after password change, form should now be visible');
                // Ensure form is visible
                const formSlider = document.querySelector('.form-slider-padding');
                if (formSlider) {
                    formSlider.style.display = 'block';
                    console.log('‚úÖ Form visibility explicitly set to block');
                }
            }
        }
        
        /**
         * Handle password change form submission (Same logic as Director Portal)
         */
        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const changeBtn = document.getElementById('passwordChangeBtn');
            const errorMessage = document.getElementById('passwordChangeError');
            
            // Hide previous errors
            errorMessage.style.display = 'none';
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match. Please try again.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Validate password strength
            if (newPassword.length < 8) {
                errorMessage.textContent = 'Password must be at least 8 characters long.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            changeBtn.disabled = true;
            changeBtn.textContent = 'Updating Password...';
            
            try {
                // Update password in Supabase Auth
                const { error: passwordError } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });
                
                if (passwordError) throw passwordError;
                
                // Clear the requires_password_change flag in user metadata (EXACT same as Director Portal)
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error('Session expired');
                
                // Fetch current user metadata to preserve other fields
                const { data: currentUserData } = await supabaseClient
                    .from('users')
                    .select('metadata')
                    .eq('id', session.user.id)
                    .single();
                
                const { error: metadataError } = await supabaseClient
                    .from('users')
                    .update({
                        metadata: {
                            ...(currentUserData?.metadata || {}),
                            requires_password_change: false,
                            password_changed_at: new Date().toISOString()
                        }
                    })
                    .eq('id', session.user.id);
                
                if (metadataError) throw metadataError;
                
                console.log('‚úÖ Password changed successfully');
                
                // Hide password change modal
                hidePasswordChangeModal();
                
                // Show success modal (replaces browser alert)
                showPasswordChangeSuccessModal();
                
            } catch (error) {
                console.error('Password change error:', error);
                errorMessage.textContent = error.message || 'Failed to update password. Please try again.';
                errorMessage.style.display = 'block';
                
                // Re-enable button
                changeBtn.disabled = false;
                changeBtn.textContent = 'Set New Password';
            }
        }
        
        /**
         * Handle login form submission
         */
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('loginError');
            
            // Hide previous errors
            errorMessage.style.display = 'none';
            
            // Disable button and show loading
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            try {
                // Attempt login
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Check if user is a family member
                const role = data.user.app_metadata?.role;
                
                if (role !== 'family') {
                    throw new Error('Access denied: This form is only for family members.');
                }
                
                // Fetch user data from database (EXACT same as Director Portal)
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('role, status, metadata')
                    .eq('id', data.user.id)
                    .single();
                
                console.log('===== FAMILY LOGIN DEBUG START =====');
                console.log('‚úÖ Login successful:', data.user.email);
                console.log('üîê Raw database user data:', JSON.stringify(userData, null, 2));
                console.log('üîê Metadata object:', JSON.stringify(userData?.metadata, null, 2));
                console.log('üîë Password change flag check:', {
                    hasUserData: !!userData,
                    hasMetadata: !!userData?.metadata,
                    metadataKeys: userData?.metadata ? Object.keys(userData.metadata) : [],
                    requiresChange: userData?.metadata?.requires_password_change,
                    requiresChangeType: typeof userData?.metadata?.requires_password_change,
                    strictCheck: userData?.metadata?.requires_password_change === true,
                    looseCheck: userData?.metadata?.requires_password_change == true
                });
                console.log('===== FAMILY LOGIN DEBUG END =====');
                
                if (userError || !userData || userData.role !== 'family') {
                    throw new Error('Access denied: This form is only for family members.');
                }
                
                // Update user status to 'active' on first successful login
                if (userData.status === 'invited') {
                    await supabaseClient
                        .from('users')
                        .update({ 
                            status: 'active',
                            last_login_at: new Date().toISOString()
                        })
                        .eq('id', data.user.id);
                } else {
                    // Just update last login time for already active users
                    await supabaseClient
                        .from('users')
                        .update({ 
                            last_login_at: new Date().toISOString()
                        })
                        .eq('id', data.user.id);
                }
                
                // Check if user needs to change password (EXACT same check as Director Portal)
                if (userData.metadata?.requires_password_change === true) {
                    console.log('üö®üö®üö® FORCING PASSWORD CHANGE üö®üö®üö®');
                    hideLoginModal();
                    showPasswordChangeModal();
                    return; // Stop execution until password is changed
                }
                
                console.log('‚úÖ No password change required, proceeding to form');
                
                // Set currentUser with full data
                currentUser = {
                    id: data.user.id,
                    email: data.user.email,
                    ...userData
                };
                
                // Fetch and display user's name for personalized greeting
                try {
                    const { data: userData, error: userError } = await supabaseClient
                        .from('users')
                        .select('metadata')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (!userError && userData?.metadata?.name) {
                        const userName = userData.metadata.name;
                        console.log('‚úÖ User name loaded:', userName);
                        
                        // Update the welcome heading with personalized greeting
                        const welcomeHeading = document.getElementById('welcome-heading');
                        if (welcomeHeading) {
                            welcomeHeading.textContent = `Hey ${userName}, Let's begin.`;
                        }
                    } else {
                        // Fallback to JWT user_metadata
                        const fallbackName = currentUser.user_metadata?.name;
                        if (fallbackName) {
                            const welcomeHeading = document.getElementById('welcome-heading');
                            if (welcomeHeading) {
                                welcomeHeading.textContent = `Hey ${fallbackName}, Let's begin.`;
                            }
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Error fetching user name:', e);
                }
                
                hideLoginModal();
                await loadFamilyCase();
                
                // Show success message
                console.log('‚úÖ You can now complete the obituary form');
                
            } catch (error) {
                console.error('Login error:', error);
                errorMessage.textContent = error.message || 'Failed to sign in. Please check your credentials.';
                errorMessage.style.display = 'block';
                
                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }
        
        /**
         * Handle sign out
         */
        async function handleSignOut() {
            try {
                console.log('üîì Signing out...');
                
                // Save draft before signing out
                await saveFormDraft();
                
                // Sign out
                await supabaseClient.auth.signOut();
                
                // Redirect to login page
                window.location.href = 'm-family-7x2p/login.html';
            } catch (error) {
                console.error('‚ùå Sign out error:', error);
                // Still redirect even if error
                window.location.href = 'm-family-7x2p/login.html';
            }
        }
        
        // Form content is hidden by CSS initially

        // Initialize obituary data
        const obituaryData = { name: "", content: "" };
        let originalObituaryData = {};
        let originalFormPayload = {};
        // üîë holds the Wait node's per-execution resume URL (from n8n)
        let MEMORIO_RESUME_URL = "";
        
        // ============================================================================
        // AUTHENTICATION & CASE LOADING
        // ============================================================================
        
        /**
         * Check if family user is authenticated
         * If not, redirect to family login page
         * If yes, load their assigned case
         */
        async function checkAuthentication() {
            try {
                // Get current session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    console.log('No active session, showing login modal...');
                    showLoginModal();
                    return false;
                }
                
                // Fetch user data from database (EXACT same as Director Portal)
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('role, metadata')
                    .eq('id', session.user.id)
                    .single();
                
                console.log('===== CHECK AUTHENTICATION DEBUG START =====');
                console.log('‚úÖ User authenticated:', session.user.email);
                console.log('üîê Raw database user data:', JSON.stringify(userData, null, 2));
                console.log('üîê Metadata object:', JSON.stringify(userData?.metadata, null, 2));
                console.log('üîë Password change flag check:', {
                    hasUserData: !!userData,
                    hasMetadata: !!userData?.metadata,
                    metadataKeys: userData?.metadata ? Object.keys(userData.metadata) : [],
                    requiresChange: userData?.metadata?.requires_password_change,
                    requiresChangeType: typeof userData?.metadata?.requires_password_change,
                    strictCheck: userData?.metadata?.requires_password_change === true,
                    looseCheck: userData?.metadata?.requires_password_change == true
                });
                console.log('===== CHECK AUTHENTICATION DEBUG END =====');
                
                if (userError || !userData || userData.role !== 'family') {
                    console.error('‚ùå Not a family member or user not found:', userError);
                    showLoginModal();
                    return false;
                }
                
                // Check if user needs to change password (EXACT same check as Director Portal)
                if (userData.metadata?.requires_password_change === true) {
                    console.log('üö®üö®üö® FORCING PASSWORD CHANGE üö®üö®üö®');
                    showPasswordChangeModal();
                    return false; // Block form access until password is changed
                }
                
                console.log('‚úÖ No password change required, proceeding to form');
                
                // Set currentUser with full data
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    ...userData
                };
                
                // Fetch user's name for personalized greeting
                try {
                    console.log('üì° Attempting to fetch user data from database...');
                    const { data: userData, error: userError } = await supabaseClient
                        .from('users')
                        .select('metadata')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (userError) {
                        console.error('‚ùå Database query failed:', userError);
                        console.error('‚ùå Error code:', userError.code);
                        console.error('‚ùå Error message:', userError.message);
                        console.error('‚ùå Error details:', userError.details);
                        console.error('‚ùå Error hint:', userError.hint);
                    }
                    
                    if (!userError && userData?.metadata?.name) {
                        const userName = userData.metadata.name;
                        console.log('‚úÖ User name loaded:', userName);
                        
                        // Update the welcome heading with personalized greeting
                        const welcomeHeading = document.getElementById('welcome-heading');
                        if (welcomeHeading) {
                            welcomeHeading.textContent = `Hey ${userName}, Let's begin.`;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Could not load user name from database:', userError);
                        // Fallback: try to get name from user_metadata (JWT)
                        const fallbackName = currentUser.user_metadata?.name;
                        if (fallbackName) {
                            console.log('‚úÖ User name loaded from JWT:', fallbackName);
                            const welcomeHeading = document.getElementById('welcome-heading');
                            if (welcomeHeading) {
                                welcomeHeading.textContent = `Hey ${fallbackName}, Let's begin.`;
                            }
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Error fetching user name:', e);
                    // Continue without personalization - will show default "Lets begin!"
                }
                
                // Check if form is already completed BEFORE loading the page
                const { data: cases, error: caseError } = await supabaseClient
                    .from('cases')
                    .select('id')
                    .eq('assigned_family_user_id', currentUser.id)
                    .single();
                
                if (!caseError && cases) {
                    // Check if form has already been submitted
                    const { data: forms, error: formError } = await supabaseClient
                        .from('forms')
                        .select('submitted_at')
                        .eq('case_id', cases.id)
                        .single();
                    
                    // Check if user is in edit mode
                    const urlParams = new URLSearchParams(window.location.search);
                    const isEditMode = urlParams.get('mode') === 'edit';
                    
                    if (!formError && forms && forms.submitted_at && !isEditMode) {
                        console.log('‚úÖ Form already submitted, redirecting to dashboard immediately...');
                        // Form is already completed and not in edit mode, redirect immediately without showing form
                        if (canRedirect()) {
                            setRedirectLock();
                            window.location.href = '/m-family-7x2p/dashboard.html';
                        } else {
                            console.error('üõë Redirect loop detected! Stopping to prevent infinite loop.');
                            alert('There seems to be an issue with your account setup. Please contact support or clear your browser cache and try again.');
                        }
                        return false; // Stop execution
                    } else {
                        // Clear redirect lock when staying on form page
                        sessionStorage.removeItem(REDIRECT_LOCK_KEY);
                    }
                    
                    if (isEditMode && forms && forms.submitted_at) {
                        console.log('‚úÖ Edit mode enabled - family can update their submission');
                        // In edit mode, allow editing and pre-fill form with existing data
                        // TODO: Pre-fill form fields with existing form data
                    }
                }
                
                // Form not completed yet, continue with normal flow
                console.log('‚úÖ Form not completed yet, loading case...');
                await loadFamilyCase();
                
                return true;
            } catch (error) {
                console.error('Authentication error:', error);
                console.log('Error occurred, showing login modal...');
                showLoginModal();
                return false;
            }
        }
        
        /**
         * Load the case assigned to the current family user
         * (Form completion check is now handled in checkAuthentication)
         */
        async function loadFamilyCase() {
            try {
                const { data: cases, error } = await supabaseClient
                    .from('cases')
                    .select('*, organizations(name)')
                    .eq('assigned_family_user_id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error('Error loading case:', error);
                    alert('Error: No case found assigned to your account. Please contact your funeral director.');
                    return;
                }
                
                currentCase = cases;
                console.log('‚úÖ Case loaded:', currentCase.deceased_name, '| Case ID:', currentCase.id);
                
                // Show the form content now that we know user hasn't completed it
                const formContent = document.querySelector('.form-container, .form-wrapper, .w-form');
                if (formContent) {
                    formContent.classList.add('show');
                }
                
                // Initialize all family portal enhancements (hide steps, populate fields, etc.)
                initFamilyPortalEnhancements();
                
            } catch (error) {
                console.error('Error loading case:', error);
                alert('Error: Failed to load case information. Please try again.');
            }
        }
        
        /**
         * Save form data to Supabase database
         * This runs AFTER N8N webhook succeeds
         */
        async function saveFormToDatabase(formPayload) {
            if (!currentCase) {
                console.warn('‚ö†Ô∏è No case loaded, skipping database save');
                return;
            }
            
            try {
                console.log('üíæ Saving form data to database...');
                
                // Check if a form record already exists for this case
                const { data: existingForms, error: checkError } = await supabaseClient
                    .from('forms')
                    .select('id')
                    .eq('case_id', currentCase.id)
                    .single();
                
                let formResult;
                
                if (existingForms) {
                    // Update existing form
                    formResult = await supabaseClient
                        .from('forms')
                        .update({
                            submitted_json: formPayload,
                            submitted_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingForms.id)
                        .select();
                } else {
                    // Create new form record
                    formResult = await supabaseClient
                        .from('forms')
                        .insert({
                            case_id: currentCase.id,
                            json_schema_version: 'v1',
                            submitted_json: formPayload,
                            submitted_at: new Date().toISOString()
                        })
                        .select();
                }
                
                if (formResult.error) {
                    console.error('‚ùå Error saving form to database:', formResult.error);
                    // Don't block the user experience, just log the error
                    return;
                }
                
                console.log('‚úÖ Form data saved to database successfully');
                
                // Save uploaded photos to Supabase Storage and assets table
                await saveUploadedPhotos();
                
                // Update case status to 'submitted'
                await updateCaseStatus('submitted');
                
                // Auto-assign an editor to the case
                await autoAssignEditor(currentCase.id);
                
            } catch (error) {
                console.error('‚ùå Error in saveFormToDatabase:', error);
                // Don't block the user experience
            }
        }
        
        /**
         * Handle photo selection and preview
         */
        function handlePhotoSelection() {
            const input = document.getElementById('photo_upload');
            const preview = document.getElementById('photo-preview');
            
            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                selectedPhotos = files;
                
                console.log(`üì∑ ${files.length} photo(s) selected`);
                
                // Clear preview
                preview.innerHTML = '';
                
                // Generate previews
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        const wrapper = document.createElement('div');
                        wrapper.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                        
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; display: block;';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '√ó';
                        removeBtn.type = 'button';
                        removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 18px; line-height: 20px;';
                        removeBtn.onclick = () => {
                            selectedPhotos.splice(index, 1);
                            wrapper.remove();
                        };
                        
                        wrapper.appendChild(img);
                        wrapper.appendChild(removeBtn);
                        preview.appendChild(wrapper);
                    };
                    
                    reader.readAsDataURL(file);
                });
            });
        }
        
        /**
         * Save uploaded photos to Supabase Storage and assets table
         */
        async function saveUploadedPhotos() {
            if (!currentCase || !currentUser) {
                console.warn('‚ö†Ô∏è No case or user loaded, skipping photo save');
                return;
            }
            
            if (!selectedPhotos || selectedPhotos.length === 0) {
                console.log('üì∑ No photos selected');
                return;
            }
            
            try {
                console.log(`üì∑ Uploading ${selectedPhotos.length} photo(s) to Supabase Storage...`);
                
                for (let i = 0; i < selectedPhotos.length; i++) {
                    const file = selectedPhotos[i];
                    
                    try {
                        // Generate unique file path
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${currentCase.id}/${Date.now()}_${i}.${fileExt}`;
                        
                        console.log(`üì∑ Uploading: ${file.name} ‚Üí ${fileName}`);
                        
                        // Upload to Supabase Storage
                        const { data: uploadData, error: uploadError } = await supabaseClient.storage
                            .from('case-assets')
                            .upload(fileName, file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (uploadError) {
                            console.error('‚ùå Error uploading photo:', uploadError);
                            continue;
                        }
                        
                        // Get public URL
                        const { data: { publicUrl } } = supabaseClient.storage
                            .from('case-assets')
                            .getPublicUrl(fileName);
                        
                        console.log(`‚úÖ Photo uploaded: ${publicUrl}`);
                        
                        // Save to assets table
                        const { error: assetError } = await supabaseClient
                            .from('assets')
                            .insert({
                                case_id: currentCase.id,
                                uploader_user_id: currentUser.id,
                                file_key: publicUrl,
                                mime_type: file.type,
                                size_bytes: file.size,
                                metadata: {
                                    source: 'supabase_storage',
                                    original_filename: file.name,
                                    uploaded_via: 'form_submission'
                                }
                            });
                        
                        if (assetError) {
                            console.error('‚ùå Error saving photo to assets table:', assetError);
                        } else {
                            console.log('‚úÖ Photo saved to assets table');
                        }
                    } catch (photoError) {
                        console.error('‚ùå Error processing individual photo:', photoError);
                    }
                }
                
                console.log('‚úÖ All photos processed');
            } catch (error) {
                console.error('‚ùå Error saving uploaded photos:', error);
                // Don't block the user experience
            }
        }
        
        /**
         * Update case status in database
         */
        async function updateCaseStatus(newStatus) {
            if (!currentCase) return;
            
            try {
                const { error } = await supabaseClient
                    .from('cases')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentCase.id);
                
                if (error) {
                    console.error('‚ùå Error updating case status:', error);
                    return;
                }
                
                console.log(`‚úÖ Case status updated to: ${newStatus}`);
                currentCase.status = newStatus;
                
            } catch (error) {
                console.error('‚ùå Error in updateCaseStatus:', error);
            }
        }
        
        /**
         * Auto-assign an editor to the case using load balancing
         */
        async function autoAssignEditor(caseId) {
            try {
                console.log('ü§ñ Auto-assigning editor to case...');
                
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    console.warn('‚ö†Ô∏è No session for auto-assign');
                    return;
                }
                
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/auto-assign-editor`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ case_id: caseId })
                    }
                );
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.assigned) {
                        console.log(`‚úÖ Editor auto-assigned: ${result.editor_name}`);
                    } else {
                        console.log('‚ö†Ô∏è No editors available - admin notified');
                    }
                } else {
                    console.error('‚ùå Auto-assign failed:', result.error);
                    // Don't block user experience
                }
                
            } catch (error) {
                console.error('‚ùå Error in autoAssignEditor:', error);
                // Don't block user experience - case can be manually assigned later
            }
        }
        
        // ---------- helpers ----------
        function extractContent(raw) {
            let text =
                raw?.content ||
                raw?.choices?.[0]?.message?.content ||
                raw?.data?.[0]?.message?.content ||
                raw?.message?.content ||
                raw?.contentText || "";
            return String(text)
                .replace(/\r\n/g, "\n")
                .replace(/\n{1}(?=\S)/g, "\n\n")
                .trim();
        }
        function injectStyles() {
            const styleId = 'memorio-injected-styles';
            if (document.getElementById(styleId)) return;
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `
                .writing-status{background:#fff3e9;border-radius:20px;padding:25px;margin-bottom:30px;text-align:center;box-shadow:0 2px 8px -2px rgba(0,0,0,.2);font-family:'Dosis',sans-serif;opacity:1;transition:opacity 0.5s ease-out}
                .writing-status.fade-out{opacity:0}
                .status-text{font-size:18px;margin-bottom:15px;color:#436481;font-family:'Dosis',sans-serif}
                .loading-dots{display:inline-flex;gap:5px}
                .dot{width:8px;height:8px;background:#436481;border-radius:50%;animation:pulse 1.5s infinite}
                .dot:nth-child(2){animation-delay:.3s}
                .dot:nth-child(3){animation-delay:.6s}
                @keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
                .obituary-card{background:#fff3e9;border-radius:20px;padding:25px;margin-bottom:30px;box-shadow:0 2px 8px -2px rgba(0,0,0,.2);font-family:'Dosis',sans-serif}
                .obituary-title{font-size:18px;color:#436481;margin-bottom:20px;font-weight:500;border:none;font-family:'Dosis',sans-serif}
                .edit-hint{font-size:13px;color:#7a8592;text-align:center;margin-top:15px;margin-bottom:15px;font-style:italic;opacity:0.7;transition:opacity 0.3s ease;font-family:'Dosis',sans-serif;cursor:default}
                .edit-hint:hover{opacity:0.9}
                .obituary-content{font-size:18px;line-height:1.8;color:#32343a;min-height:200px;cursor:text;background:#fff3e9;border-radius:20px;padding:25px;box-shadow:0 2px 8px -2px rgba(0,0,0,.2);border:none;outline:none;font-family:'Dosis',sans-serif;margin-top:15px;font-weight:400;word-wrap:break-word;white-space:pre-wrap}
                .obituary-content:focus{outline:none;border:none;box-shadow:0 2px 8px -2px rgba(0,0,0,.2)}
                .obituary-content::selection{background-color:rgba(67,100,129,.2)}
                .obituary-content p{margin-bottom:20px;font-size:18px;line-height:1.8;color:#32343a;font-family:'Dosis',sans-serif;font-weight:400}
                .obituary-content p:last-child{margin-bottom:0}
                .obituary-content[contenteditable="true"]{box-shadow:0 2px 8px -2px rgba(67,100,129,.3)}
                .typewriter-cursor{display:inline-block;width:2px;height:22px;background:#32343a;animation:blink 1s infinite;vertical-align:text-top;margin-left:2px}
                @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
                .action-buttons{display:flex;justify-content:center;margin-top:30px}
                .btn{background:#32343a;color:#fff;border:none;padding:15px 30px;font-size:16px;font-family:'Dosis',sans-serif;border-radius:60px;cursor:pointer;transition:all .3s ease;font-weight:500}
                .btn:hover{background:#436481;transform:translateY(-2px)}
                .btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none}
                .hidden{display:none}
                .fade-in{animation:fadeIn .5s ease-in}
                @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
                .memorial-info{background:#fff3e9;border-radius:20px;padding:25px;margin-bottom:20px;font-size:16px;color:#32343a;text-align:center;font-family:'Dosis',sans-serif;box-shadow:0 2px 8px -2px rgba(0,0,0,.2)}
                .memorio-container{max-width:800px;margin:0 auto;font-family:'Dosis',sans-serif}
                
                /* Date input group styling */
                .date-input-group{display:flex;gap:10px;margin-bottom:15px}
                .date-input-group .select-field{flex:1;min-width:0}
                .date-input-group .select-field:first-child{flex:1.5}
                .date-input-group .select-field:last-child{flex:1.2}
            `;
            document.head.appendChild(style);
        }
        // ---------- UI mounting (instant loader on submit) ----------
        function mountUIIntoSuccess() {
            const container = document.getElementById('memorio-success-container');
            if (!container) return;
            if (!container.querySelector('#obituaryCard')) {
                // Get deceased person's name for personalization
                let deceasedFirstName = 'your loved one';
                let deceasedPossessiveName = 'your loved one\'s';
                
                if (currentCase && currentCase.deceased_name) {
                    const firstName = currentCase.deceased_name.split(' ')[0];
                    deceasedFirstName = firstName;
                    // Handle possessive form correctly (e.g., "James' story" vs "John's story")
                    deceasedPossessiveName = firstName.endsWith('s') ? firstName + "'" : firstName + "'s";
                }
                
                container.innerHTML = `
                    <div class="memorio-container">
                        <div id="writingStatus" class="writing-status">
                            <div class="status-text">Crafting ${deceasedPossessiveName} story...</div>
                            <div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        </div>
                        <div id="memorialInfo" class="memorial-info hidden">
                            Thank you for sharing about ${deceasedFirstName}. Here's the tribute we've crafted based on the memories you provided.
                        </div>
                        <div id="obituaryCard" class="obituary-card hidden">
                            <div id="obituaryTitle" class="obituary-title">Here's your updated obituary</div>
                            <div id="obituaryContent" class="obituary-content"></div>
                            <div class="edit-hint">You can always make changes in the dashboard</div>
                            <div class="action-buttons">
                                <a href="/m-family-7x2p/dashboard.html" class="btn" style="background: #436481; text-decoration: none;">Access Dashboard</a>
                            </div>
                        </div>
                    </div>`;
            }
            injectStyles();
        }
        // ---------- typewriter flow with loading screen ----------
        function startTypewriter() {
            originalObituaryData = JSON.parse(JSON.stringify(obituaryData));
            // Show loading screen for 2 seconds before starting typewriter
            const status = document.getElementById('writingStatus');
            const memorialInfo = document.getElementById('memorialInfo');
            const card = document.getElementById('obituaryCard');
            setTimeout(() => {
                // Fade out loading screen
                status?.classList.add('fade-out');
                setTimeout(() => {
                    // Hide loading and show memorial info
                    status?.classList.add('hidden');
                    memorialInfo?.classList.remove('hidden');
                    memorialInfo?.classList.add('fade-in');
                    setTimeout(() => {
                        // Show obituary card and start typing
                        card?.classList.remove('hidden');
                        card?.classList.add('fade-in');
                        typeTitle();
                    }, 1000);
                }, 500); // Wait for fade-out to complete
            }, 2000); // Show loading for 2 seconds
        }
        function typeTitle() {
            const titleElement = document.getElementById('obituaryTitle');
            titleElement.textContent = `Here's your updated obituary${obituaryData.name ? ` for ${obituaryData.name}` : ''}`;
            setTimeout(() => { typeContent(); }, 200);
        }
        function typeContent() {
            const contentElement = document.getElementById('obituaryContent');
            contentElement.innerHTML = '';
            contentElement.contentEditable = false;
            const content = obituaryData.content || '';
            if (!content) return;
            const paragraphs = content.split('\n\n').filter(p => p.trim());
            let i = 0, j = 0;
            const cursor = document.createElement('span');
            cursor.className = 'typewriter-cursor';
            function typeNextChar() {
                if (i < paragraphs.length) {
                    const txt = paragraphs[i].trim();
                    if (j < txt.length) {
                        const existingCursor = contentElement.querySelector('.typewriter-cursor');
                        if (existingCursor) existingCursor.remove();
                        if (j === 0) { const p = document.createElement('p'); contentElement.appendChild(p); }
                        const pNow = contentElement.lastElementChild; pNow.textContent += txt.charAt(j); pNow.appendChild(cursor.cloneNode());
                        j++;
                        const prev = txt.charAt(j-1);
                        const speed = prev === '.' ? 80 : prev === ',' ? 60 : Math.random()*20 + 15;
                        setTimeout(typeNextChar, speed);
                    } else {
                        i++; j = 0; if (i < paragraphs.length) setTimeout(typeNextChar, 250); else setTimeout(() => { const c = contentElement.querySelector('.typewriter-cursor'); if (c) c.remove(); /* makeContentEditable() - Disabled: all edits must be done in dashboard */ }, 600);
                    }
                }
            }
            typeNextChar();
        }
        // DISABLED: Obituary editing must be done in dashboard only
        // function makeContentEditable() {
        //     const el = document.getElementById('obituaryContent');
        //     const paragraphs = Array.from(el.querySelectorAll('p'));
        //     const plain = paragraphs.map(p => p.textContent).join('\n\n');
        //     el.innerHTML = '';
        //     el.textContent = plain;
        //     el.contentEditable = true;
        //     el.addEventListener('click', function(){ this.focus(); }, { once: true });
        // }
        // üîß Modified to include resumeUrl in payload sent to Email Webhook
        async function publishObituary() {
            const el = document.getElementById('obituaryContent');
            const btn = document.querySelector('.btn');
            // Capture final content with proper formatting
            let finalContent = el.textContent || el.innerText || '';
            finalContent = finalContent.replace(/\n\s*\n/g, '\n\n').trim();
            const finalData = { 
                name: obituaryData.name, 
                content: finalContent,
                originalFormData: originalFormPayload,
                timestamp: new Date().toISOString(),
                // ‚¨áÔ∏è Send the Wait node resume URL so the Email Webhook branch can resume the flow
                resumeUrl: MEMORIO_RESUME_URL || ""
            };
            console.log('Submitting final obituary data:', finalData);
            // Disable button and show loading state
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                // First, update the database with the final obituary content
                if (currentCase && currentCase.id) {
                    const { data: existingForms, error: formQueryError } = await supabaseClient
                        .from('forms')
                        .select('id')
                        .eq('case_id', currentCase.id)
                        .single();
                    
                    if (!formQueryError && existingForms) {
                        // Update existing form with final obituary content
                        const { error: updateError } = await supabaseClient
                            .from('forms')
                            .update({
                                submitted_json: {
                                    ...originalFormPayload,
                                    obituary_name: obituaryData.name,
                                    obituary_content: finalContent,
                                    generated_at: new Date().toISOString()
                                },
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingForms.id);
                        
                        if (updateError) {
                            console.error('‚ùå Error updating form with obituary:', updateError);
                        } else {
                            console.log('‚úÖ Successfully updated form with final obituary content');
                        }
                        
                        // Also save to obituary_content table for director/QC portal access
                        const { error: obituaryError } = await supabaseClient
                            .from('obituary_content')
                            .upsert({
                                case_id: currentCase.id,
                                content_html: `<div>${finalContent.split('\n\n').map(p => `<p>${p}</p>`).join('')}</div>`,
                                content_plain: finalContent,
                                generated_by: currentUser?.id || 'AI',
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'case_id'  // Update if exists, insert if new
                            });
                        
                        if (obituaryError) {
                            console.error('‚ùå Error saving to obituary_content:', obituaryError);
                        } else {
                            console.log('‚úÖ Successfully saved obituary to obituary_content table');
                        }
                    }
                }
                
                // Then send to email webhook
                console.log('Sending to email webhook:', EMAIL_ENDPOINT);
                console.log('Payload:', finalData);
                const response = await fetch(EMAIL_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify(finalData)
                });
                console.log('Response status:', 'no-cors mode - status not available');
                console.log('Request sent successfully');
                // In no-cors mode, we can't read the response, so assume success
                btn.textContent = 'Sent!';
                btn.style.background = '#22c55e';
                
                // Add "Access Dashboard" button
                const actionButtons = document.querySelector('.action-buttons');
                if (actionButtons && !document.getElementById('dashboardBtn')) {
                    const dashboardBtn = document.createElement('a');
                    dashboardBtn.id = 'dashboardBtn';
                    dashboardBtn.href = '/m-family-7x2p/dashboard.html';
                    dashboardBtn.className = 'btn';
                    dashboardBtn.textContent = 'Access Dashboard';
                    dashboardBtn.style.marginLeft = '15px';
                    dashboardBtn.style.background = '#436481';
                    dashboardBtn.style.textDecoration = 'none';
                    dashboardBtn.style.display = 'inline-block';
                    actionButtons.appendChild(dashboardBtn);
                }
                
                setTimeout(() => {
                    alert('Obituary submitted successfully! You will receive an email shortly with your final obituary.');
                }, 500);
            } catch (error) {
                console.error('Detailed error submitting obituary:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                btn.disabled = false;
                btn.textContent = 'Submit';
                // More specific error messages
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    alert('Network Error: Cannot reach the email webhook. Check N8N webhook status and CORS settings.');
                } else if (error.message.includes('HTTP')) {
                    alert(`Server Error: ${error.message}`);
                } else {
                    alert(`Error: ${error.message}`);
                }
            }
        }
        // ---------- response handling ----------
        async function displayObituary(data, formPayload = {}) {
            // Store original form payload for email submission
            originalFormPayload = JSON.parse(JSON.stringify(formPayload));
            obituaryData.name =
                data?.name ||
                data?.obituary?.name ||
                [formPayload.loved_ones_name, formPayload.loved_ones_last_name].filter(Boolean).join(' ') ||
                [formPayload.customer_name, formPayload.loved_ones_last_name].filter(Boolean).join(' ') ||
                formPayload.loved_ones_name ||
                formPayload.customer_name || '';
            obituaryData.content = extractContent(data);
            // üîë Capture resumeUrl from n8n Respond-to-Webhook payload
            MEMORIO_RESUME_URL = data?.resumeUrl || MEMORIO_RESUME_URL || "";
            if (!obituaryData.content) {
                alert('No obituary content was generated. Please check the n8n workflow output.');
                return;
            }
            
            // ‚úÖ AUTO-SAVE: Save obituary to database immediately after N8N generates it
            await saveObituaryToDatabase(obituaryData.name, obituaryData.content);
            
            startTypewriter();
        }
        
        /**
         * Save generated obituary to database
         * This runs automatically after N8N generates the obituary
         */
        async function saveObituaryToDatabase(obituaryName, obituaryContent) {
            if (!currentCase || !currentCase.id) {
                console.warn('‚ö†Ô∏è No case loaded, skipping obituary save');
                return;
            }
            
            try {
                console.log('üíæ Auto-saving generated obituary to database...');
                
                // Find the existing form record
                const { data: existingForms, error: formQueryError } = await supabaseClient
                    .from('forms')
                    .select('id, submitted_json')
                    .eq('case_id', currentCase.id)
                    .single();
                
                if (formQueryError || !existingForms) {
                    console.error('‚ùå Error finding form:', formQueryError);
                    return;
                }
                
                // Update with obituary content
                const updatedJson = {
                    ...existingForms.submitted_json,
                    obituary_name: obituaryName,
                    obituary_content: obituaryContent,
                    generated_at: new Date().toISOString()
                };
                
                const { error: updateError } = await supabaseClient
                    .from('forms')
                    .update({
                        submitted_json: updatedJson,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existingForms.id);
                
                if (updateError) {
                    console.error('‚ùå Error saving obituary:', updateError);
                } else {
                    console.log('‚úÖ Obituary automatically saved to database');
                }
                
                // Also save to obituary_content table for director/QC portal access
                const { error: obituaryError } = await supabaseClient
                    .from('obituary_content')
                    .upsert({
                        case_id: currentCase.id,
                        content_html: `<div>${obituaryContent.split('\n\n').map(p => `<p>${p}</p>`).join('')}</div>`,
                        content_plain: obituaryContent,
                        generated_by: currentUser?.id || 'AI',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'case_id'  // Update if exists, insert if new
                    });
                
                if (obituaryError) {
                    console.error('‚ùå Error saving to obituary_content:', obituaryError);
                } else {
                    console.log('‚úÖ Saved obituary to obituary_content table (director/QC access)');
                }
            } catch (error) {
                console.error('‚ùå Error in saveObituaryToDatabase:', error);
            }
        }
        // Expose functions globally
        window.publishObituary = publishObituary;
        window.displayObituary = displayObituary;
        window.startObituaryTypewriter = function(obituaryContent, userName) { obituaryData.content = obituaryContent; obituaryData.name = userName; startTypewriter(); };
    </script>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=683b63acf5908465c8825ca8" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
  <script>
        // ---------- Date input combination functions ----------
        function combineDateInputs() {
            // Combine passing date
            const monthPassing = document.getElementById('month_of_passing');
            const dayPassing = document.getElementById('day_of_passing');
            const yearPassing = document.getElementById('year_of_passing');
            const datePassingHidden = document.getElementById('date_of_passing');
            
            if (monthPassing && dayPassing && yearPassing && datePassingHidden) {
                const updatePassingDate = () => {
                    if (monthPassing.value && dayPassing.value && yearPassing.value) {
                        datePassingHidden.value = `${yearPassing.value}-${monthPassing.value}-${dayPassing.value}`;
                    }
                };
                monthPassing.addEventListener('change', updatePassingDate);
                dayPassing.addEventListener('change', updatePassingDate);
                yearPassing.addEventListener('change', updatePassingDate);
            }
            
            // Combine birth date
            const monthBirth = document.getElementById('month_of_birth');
            const dayBirth = document.getElementById('day_of_birth');
            const yearBirth = document.getElementById('year_of_birth');
            const dateBirthHidden = document.getElementById('date_of_birth');
            
            if (monthBirth && dayBirth && yearBirth && dateBirthHidden) {
                const updateBirthDate = () => {
                    if (monthBirth.value && dayBirth.value && yearBirth.value) {
                        dateBirthHidden.value = `${yearBirth.value}-${monthBirth.value}-${dayBirth.value}`;
                    }
                };
                monthBirth.addEventListener('change', updateBirthDate);
                dayBirth.addEventListener('change', updateBirthDate);
                yearBirth.addEventListener('change', updateBirthDate);
            }
        }

        // ---------- Force date combination on form submit ----------
        function combineDateInputsOnSubmit() {
            console.log('=== COMBINING DATES ON SUBMIT ===');
            
            // Force combine passing date
            const monthPassing = document.getElementById('month_of_passing');
            const dayPassing = document.getElementById('day_of_passing');
            const yearPassing = document.getElementById('year_of_passing');
            const datePassingHidden = document.getElementById('date_of_passing');
            
            console.log('Passing date elements found:', {
                month: !!monthPassing,
                day: !!dayPassing,
                year: !!yearPassing,
                hidden: !!datePassingHidden
            });
            
            if (monthPassing && dayPassing && yearPassing && datePassingHidden) {
                console.log('Passing date values:', {
                    month: monthPassing.value,
                    day: dayPassing.value,
                    year: yearPassing.value
                });
                
                if (monthPassing.value && dayPassing.value && yearPassing.value) {
                    datePassingHidden.value = `${yearPassing.value}-${monthPassing.value}-${dayPassing.value}`;
                    console.log('‚úÖ Combined passing date:', datePassingHidden.value);
                } else {
                    console.log('‚ùå Missing passing date values');
                }
            } else {
                console.log('‚ùå Missing passing date elements');
            }
            
            // Force combine birth date
            const monthBirth = document.getElementById('month_of_birth');
            const dayBirth = document.getElementById('day_of_birth');
            const yearBirth = document.getElementById('year_of_birth');
            const dateBirthHidden = document.getElementById('date_of_birth');
            
            console.log('Birth date elements found:', {
                month: !!monthBirth,
                day: !!dayBirth,
                year: !!yearBirth,
                hidden: !!dateBirthHidden
            });
            
            if (monthBirth && dayBirth && yearBirth && dateBirthHidden) {
                console.log('Birth date values:', {
                    month: monthBirth.value,
                    day: dayBirth.value,
                    year: yearBirth.value
                });
                
                if (monthBirth.value && dayBirth.value && yearBirth.value) {
                    dateBirthHidden.value = `${yearBirth.value}-${monthBirth.value}-${dayBirth.value}`;
                    console.log('‚úÖ Combined birth date:', dateBirthHidden.value);
                } else {
                    console.log('‚ùå Missing birth date values');
                }
            } else {
                console.log('‚ùå Missing birth date elements');
            }
            
            console.log('=== DATE COMBINATION COMPLETE ===');
        }

        // ---------- Hook into the Webflow form AFTER Webflow loads ----------
        (function() {
            injectStyles();
            combineDateInputs();
            const wrapper = document.querySelector('.w-form');
            const form = wrapper?.querySelector('form');
            const success = wrapper?.querySelector('.w-form-done');
            const fail = wrapper?.querySelector('.w-form-fail');
            
            if (!form || !success) {
                console.error('Form or success element not found');
                return;
            }
            
            // Remove Webflow's default form handler
            form.removeAttribute('data-wf-element-id');
            form.removeAttribute('data-wf-page-id');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Form submitted - our handler');
                
                // Ensure date fields are combined before submission
                combineDateInputsOnSubmit();
                
                // Swap to success area immediately, then mount loader UI so it shows right away
                form.style.display = 'none';
                success.style.display = 'block';
                fail.style.display = 'none';
                mountUIIntoSuccess();
                
                const payload = Object.fromEntries(new FormData(form).entries());
                console.log('Form payload:', payload);
                console.log('Date fields check:');
                console.log('- date_of_birth:', payload.date_of_birth);
                console.log('- date_of_passing:', payload.date_of_passing);
                console.log('- month_of_birth:', payload.month_of_birth);
                console.log('- day_of_birth:', payload.day_of_birth);
                console.log('- year_of_birth:', payload.year_of_birth);
                console.log('- month_of_passing:', payload.month_of_passing);
                console.log('- day_of_passing:', payload.day_of_passing);
                console.log('- year_of_passing:', payload.year_of_passing);
                
                try {
                    console.log('Fetching from:', ENDPOINT);
                    const res = await fetch(ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        mode: 'cors',
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    const raw = await res.json();
                    console.log('N8N Response:', raw);
                    
                    // ‚úÖ DUAL SUBMISSION: After N8N succeeds, save to database
                    await saveFormToDatabase(payload);
                    
                    displayObituary(raw, payload);
                } catch (err) {
                    console.error('Submit error:', err);
                    if (err.name === 'TypeError' && err.message.includes('fetch')) {
                        alert(`Network Error: Cannot reach the webhook. This could be due to:\n1. CORS policy blocking the request\n2. Webhook endpoint is down\n3. Network connectivity issues`);
                    }
                    if (confirm('Webhook failed. Would you like to test with sample data instead?')) {
                        const sampleResponse = {
                            content: `${payload.loved_ones_name || 'Your loved one'} was a remarkable person who touched the lives of everyone they met. Born with a generous spirit and kind heart, they dedicated their life to family, friends, and community.\n\nThroughout their years, they showed unwavering love and support to those around them. Their wisdom, humor, and compassion will be deeply missed by all who had the privilege of knowing them.\n\nThey leave behind a legacy of love, kindness, and cherished memories that will live on in the hearts of family and friends forever.\n\nA celebration of their life will be held to honor their memory and the profound impact they had on all our lives.`,
                            resumeUrl: ""
                        };
                        displayObituary(sampleResponse, payload);
                    } else {
                        success.style.display = 'none';
                        if (fail) fail.style.display = 'block';
                    }
                }
            });
            
        // Listen for iframe postMessage if needed
            window.addEventListener('message', (e) => { 
                if (e.data?.type === 'obituary-data') displayObituary(e.data.obituary || {}); 
            });
            
            // ============================================================================
            // INITIALIZE PHOTO UPLOAD HANDLER
            // ============================================================================
            handlePhotoSelection();
            
            // ============================================================================
            // CHECK AUTHENTICATION ON PAGE LOAD
            // ============================================================================
            // Check if family user is authenticated and load their case
            checkAuthentication().then(isAuthenticated => {
                if (isAuthenticated) {
                    console.log('‚úÖ Page ready - User authenticated and case loaded');
                    // Initialize family portal enhancements after authentication
                    initFamilyPortalEnhancements();
                } else {
                    console.log('üîê Authentication required - Login modal shown (form hidden until login)');
                }
            });
        })();
        
        // ============================================================================
        // FAMILY PORTAL ENHANCEMENTS
        // ============================================================================
        function initFamilyPortalEnhancements() {
            // Populate deceased name throughout form
            populateDeceasedName();
            
            // Show sign-out button (removed dashboard icon as requested)
            const signOutBtn = document.getElementById('signOutBtn');
            if (signOutBtn) {
                signOutBtn.style.display = 'block';
            }
            
            // Initialize autosave
            initializeAutosave();
            
            // Initialize accordion "Add" buttons
            console.log('üîß About to initialize accordion Add buttons...');
            initAccordionAddButtons();
            console.log('‚úÖ initAccordionAddButtons() called');
            
            // Update review screen
            updateReviewScreen();
            
            // Initialize custom form navigation (MUST run after form is shown)
            initCustomFormNavigation();
            
            console.log('‚úÖ Family portal enhancements initialized');
        }
        
        /**
         * Initialize accordion "Add" buttons functionality
         * Make Add button clicks bubble up to faq-title (the working click handler)
         */
        function initAccordionAddButtons() {
            console.log('üîß Initializing accordion Add buttons...');
            
            // Wait for form to be visible
            setTimeout(() => {
                // Find all Add buttons
                const faqItems = document.querySelectorAll('.faq-item');
                console.log(`üîç Found ${faqItems.length} faq-items`);
                
                faqItems.forEach((faqItem, index) => {
                    // Find the Add button - look for element with "Add" text that's inside faq-title
                    const faqTitle = faqItem.querySelector('.faq-title');
                    if (!faqTitle) return;
                    
                    // Find Add button inside faq-title
                    const allInTitle = faqTitle.querySelectorAll('*');
                    const addButton = Array.from(allInTitle).find(el => {
                        const text = el.textContent?.trim();
                        return (text === 'Add' || text === 'Hide') && 
                               (el.classList.contains('accordion') || el.classList.contains('_1') || 
                                el.classList.contains('_2') || el.classList.contains('_3') ||
                                el.classList.contains('_4') || el.classList.contains('_5') || 
                                el.classList.contains('_6'));
                    });
                    
                    if (!addButton) {
                        console.warn(`‚ö†Ô∏è No Add button found in faq-item ${index + 1}`);
                        return;
                    }
                    
                    console.log(`‚úÖ Found Add button in faq-item ${index + 1}`);
                    
                    // Make it look clickable
                    addButton.style.cursor = 'pointer';
                    addButton.style.userSelect = 'none';
                    
                    // Store reference to faq-title for the handler
                    addButton._faqTitle = faqTitle;
                    
                    // Remove the Add button from blocking clicks - make it trigger faq-title
                    // Use a simple, direct approach
                    const handleAddClick = function() {
                        console.log('üñ±Ô∏è Add button handler fired!');
                        if (this._faqTitle) {
                            console.log('‚úÖ Triggering faq-title click');
                            this._faqTitle.click();
                        }
                    };
                    
                    // Attach handler directly to the button
                    addButton.onclick = handleAddClick;
                    addButton.onmousedown = handleAddClick;
                    
                    // Also try addEventListener
                    addButton.addEventListener('click', handleAddClick, true);
                    addButton.addEventListener('mousedown', handleAddClick, true);
                    
                    console.log(`‚úÖ Set up handlers for Add button ${index + 1}`);
                });
                
                console.log(`‚úÖ Initialized Add buttons for ${faqItems.length} accordion sections`);
            }, 1000);
        }
        
        /**
         * Initialize custom form step navigation
         * This bypasses Webflow's slider and manually controls step visibility
         */
        function initCustomFormNavigation() {
            console.log('üîß Initializing custom form navigation');
            
            // Get all form steps
            const steps = document.querySelectorAll('.form-slider-step-1');
            let currentStepIndex = 0;
            
            console.log(`üìä Found ${steps.length} form steps`);
            
            if (steps.length === 0) {
                console.error('‚ùå No form steps found! Navigation cannot be initialized.');
                return;
            }
            
            // Function to show a specific step
            function showStep(index) {
                if (index < 0 || index >= steps.length) {
                    console.warn(`‚ö†Ô∏è Invalid step index: ${index}`);
                    return;
                }
                
                console.log(`‚û°Ô∏è Navigating to step ${index + 1} of ${steps.length}`);
                
                // Force hide all steps and show target step with !important styles
                steps.forEach((step, i) => {
                    if (i === index) {
                        step.style.cssText = 'display: flex !important;';
                        step.classList.add('active-step');
                        console.log(`‚úÖ Showing step ${i + 1}`);
                    } else {
                        step.style.cssText = 'display: none !important;';
                        step.classList.remove('active-step');
                    }
                });
                
                currentStepIndex = index;
            }
            
            // Function to go to next step
            function nextStep(e) {
                console.log('üñ±Ô∏è nextStep called, current:', currentStepIndex);
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
                if (currentStepIndex < steps.length - 1) {
                    showStep(currentStepIndex + 1);
                } else {
                    console.log('üìù At last step - form ready to submit');
                }
            }
            
            // Function to go to previous step
            function prevStep(e) {
                console.log('üñ±Ô∏è prevStep called, current:', currentStepIndex);
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
                if (currentStepIndex > 0) {
                    showStep(currentStepIndex - 1);
                }
            }
            
            // Use capturing phase and attach to document to catch ALL clicks
            document.addEventListener('click', function(e) {
                const target = e.target;
                
                // Check if click is on Next button or its parent
                if (target.classList.contains('next') || 
                    target.closest('.next') ||
                    (target.classList.contains('div-block') && !target.classList.contains('back'))) {
                    console.log('üñ±Ô∏è Next button DETECTED via document listener');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    nextStep(e);
                    return false;
                }
                
                // Check if click is on Back button
                if (target.classList.contains('back') || target.closest('.back')) {
                    console.log('üñ±Ô∏è Back button DETECTED via document listener');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    prevStep(e);
                    return false;
                }
            }, true); // Use CAPTURING phase (true) to catch events early
            
            // Initialize - show first step with !important
            showStep(0);
            console.log('‚úÖ Custom form navigation initialized with document-level capturing');
        }
        
        /**
         * Populate deceased name dynamically throughout the form
         */
        function populateDeceasedName() {
            if (!currentCase || !currentCase.deceased_name) {
                console.warn('‚ö†Ô∏è No case loaded or deceased name not available');
                return;
            }
            
            const deceasedName = currentCase.deceased_name.split(' ')[0]; // Use first name
            const fullName = currentCase.metadata?.full_name || currentCase.deceased_name || '';
            
            // Update the "Any other names" label
            const deceasedNameDisplay = document.getElementById('deceased-name-display');
            if (deceasedNameDisplay) {
                deceasedNameDisplay.textContent = deceasedName;
            }
            
            // Update "Visualize Your Loved Ones Story" to "Visualize {full name's} Story"
            const visualizeHeading = document.getElementById('visualize-story-heading');
            if (visualizeHeading && fullName) {
                const possessiveName = fullName.endsWith('s') ? fullName + "'" : fullName + "'s";
                visualizeHeading.textContent = `Visualize ${possessiveName} Story`;
                console.log('‚úÖ Updated heading to:', visualizeHeading.textContent);
            }
            
            // Update "Upload your images below" to "Upload your images of {name} below"
            const uploadLabel = document.getElementById('upload-images-label');
            if (uploadLabel && deceasedName) {
                uploadLabel.textContent = `Upload your images of ${deceasedName} below`;
                console.log('‚úÖ Updated upload label to:', uploadLabel.textContent);
            }
            
            // Auto-populate hidden fields with data from case metadata (collected by director)
            // These hidden fields are required for n8n to generate the obituary correctly
            
            if (fullName) {
                const nameParts = fullName.trim().split(' ');
                const firstNameField = document.getElementById('loved_ones_name');
                const lastNameField = document.getElementById('loved_ones_last_name');
                
                if (firstNameField) {
                    firstNameField.value = nameParts[0] || '';
                    console.log('‚úÖ Pre-populated loved_ones_name:', nameParts[0]);
                }
                if (lastNameField && nameParts.length > 1) {
                    lastNameField.value = nameParts.slice(1).join(' ') || '';
                    console.log('‚úÖ Pre-populated loved_ones_last_name:', nameParts.slice(1).join(' '));
                }
            } else {
                console.warn('‚ö†Ô∏è No name found in case metadata or deceased_name');
            }
            
            // Populate gender if available
            if (currentCase.metadata?.gender) {
                const genderField = document.getElementById('loved_ones_gender');
                if (genderField) {
                    genderField.value = currentCase.metadata.gender;
                    console.log('‚úÖ Pre-populated loved_ones_gender:', currentCase.metadata.gender);
                }
            }
            
            // Populate FUNERAL HOME name (from organization)
            if (currentCase.organizations?.name) {
                const funeralHomeField = document.getElementById('funeral_home');
                if (funeralHomeField) {
                    funeralHomeField.value = currentCase.organizations.name;
                    console.log('‚úÖ Pre-populated funeral_home:', currentCase.organizations.name);
                }
            }
            
            // Populate DATE OF BIRTH fields (same pattern as name fields above)
            if (currentCase.metadata?.date_of_birth) {
                const dobParts = currentCase.metadata.date_of_birth.split('-'); // YYYY-MM-DD format
                if (dobParts.length === 3) {
                    const [year, month, day] = dobParts;
                    
                    const monthField = document.getElementById('month_of_birth');
                    const dayField = document.getElementById('day_of_birth');
                    const yearField = document.getElementById('year_of_birth');
                    const dateField = document.getElementById('date_of_birth');
                    
                    if (monthField) monthField.value = month;
                    if (dayField) dayField.value = day;
                    if (yearField) yearField.value = year;
                    if (dateField) dateField.value = currentCase.metadata.date_of_birth;
                    
                    console.log('‚úÖ Pre-populated DOB:', currentCase.metadata.date_of_birth);
                }
            }
            
            // Populate CITY OF BIRTH
            if (currentCase.metadata?.city_of_birth) {
                const cityField = document.getElementById('city_of_birth');
                if (cityField) {
                    cityField.value = currentCase.metadata.city_of_birth;
                    console.log('‚úÖ Pre-populated city_of_birth:', currentCase.metadata.city_of_birth);
                }
            }
            
            // Populate DATE OF DEATH fields (same pattern as DOB)
            if (currentCase.metadata?.date_of_death) {
                const dodParts = currentCase.metadata.date_of_death.split('-'); // YYYY-MM-DD format
                if (dodParts.length === 3) {
                    const [year, month, day] = dodParts;
                    
                    const monthField = document.getElementById('month_of_passing');
                    const dayField = document.getElementById('day_of_passing');
                    const yearField = document.getElementById('year_of_passing');
                    const dateField = document.getElementById('date_of_passing');
                    
                    if (monthField) monthField.value = month;
                    if (dayField) dayField.value = day;
                    if (yearField) yearField.value = year;
                    if (dateField) dateField.value = currentCase.metadata.date_of_death;
                    
                    console.log('‚úÖ Pre-populated DOD:', currentCase.metadata.date_of_death);
                }
            }
            
            // Populate CITY OF DEATH
            if (currentCase.metadata?.city_of_death) {
                const cityField = document.getElementById('city_of_passing');
                if (cityField) {
                    cityField.value = currentCase.metadata.city_of_death;
                    console.log('‚úÖ Pre-populated city_of_passing:', currentCase.metadata.city_of_death);
                }
            }
            
            // Log summary for debugging
            console.log('üìã All director-provided data populated:', {
                name: fullName,
                gender: currentCase.metadata?.gender,
                funeral_home: currentCase.organizations?.name,
                dob: currentCase.metadata?.date_of_birth,
                dod: currentCase.metadata?.date_of_death,
                city_of_birth: currentCase.metadata?.city_of_birth,
                city_of_death: currentCase.metadata?.city_of_death
            });
            
            console.log('‚úÖ Deceased name populated:', deceasedName);
        }
        
        /**
         * Add persistent dashboard icon (always visible, non-intrusive)
         */
        function addPersistentDashboardIcon() {
            // Check if icon already exists
            if (document.getElementById('persistent-dashboard-icon')) {
                return;
            }
            
            const dashboardIcon = document.createElement('a');
            dashboardIcon.id = 'persistent-dashboard-icon';
            dashboardIcon.href = '/m-family-7x2p/dashboard.html';
            dashboardIcon.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9998; background-color: #436481; color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease; text-decoration: none;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </div>
            `;
            dashboardIcon.title = 'Go to Dashboard';
            document.body.appendChild(dashboardIcon);
            console.log('‚úÖ Persistent dashboard icon added');
        }
        
        /**
         * Initialize autosave functionality
         */
        function initializeAutosave() {
            let autosaveTimeout;
            const AUTOSAVE_DELAY = 2000; // 2 seconds after last change
            
            // Get all form inputs
            const formInputs = document.querySelectorAll('#wf-form-memorio_obituary_form input, #wf-form-memorio_obituary_form textarea, #wf-form-memorio_obituary_form select');
            
            formInputs.forEach(input => {
                input.addEventListener('change', () => {
                    clearTimeout(autosaveTimeout);
                    autosaveTimeout = setTimeout(() => {
                        saveFormDraft();
                    }, AUTOSAVE_DELAY);
                });
                
                // Also autosave on input for text fields
                if (input.type === 'text' || input.type === 'textarea') {
                    input.addEventListener('input', () => {
                        clearTimeout(autosaveTimeout);
                        autosaveTimeout = setTimeout(() => {
                            saveFormDraft();
                        }, AUTOSAVE_DELAY);
                    });
                }
            });
            
            // Save immediately when clicking navigation buttons (NEXT/BACK)
            const navButtons = document.querySelectorAll('.next, .back, .submit-button');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    console.log('üìù Navigation button clicked - saving draft immediately');
                    clearTimeout(autosaveTimeout);
                    saveFormDraft(); // Save immediately, don't wait
                });
            });
            
            // Save before page unload (closing tab, refreshing, etc.)
            window.addEventListener('beforeunload', () => {
                // Use synchronous save attempt (navigator.sendBeacon for reliable save on page close)
                const formData = {};
                const inputs = document.querySelectorAll('#wf-form-memorio_obituary_form input, #wf-form-memorio_obituary_form textarea, #wf-form-memorio_obituary_form select');
                inputs.forEach(input => {
                    if (input.name && input.value) {
                        formData[input.name] = input.value;
                    }
                });
                
                if (currentCase && Object.keys(formData).length > 0) {
                    console.log('üíæ Saving draft before page unload');
                    // Try to save synchronously
                    saveFormDraft();
                }
            });
            
            // Load existing draft on page load
            loadFormDraft();
            
            console.log('‚úÖ Autosave initialized with navigation and unload hooks');
        }
        
        /**
         * Save form draft to database
         */
        async function saveFormDraft() {
            if (!currentCase) {
                console.warn('‚ö†Ô∏è No case loaded, skipping autosave');
                return;
            }
            
            try {
                // Collect all form data
                const formData = {};
                const formInputs = document.querySelectorAll('#wf-form-memorio_obituary_form input, #wf-form-memorio_obituary_form textarea, #wf-form-memorio_obituary_form select');
                
                console.log(`üìù Collecting form data from ${formInputs.length} inputs...`);
                
                formInputs.forEach(input => {
                    if (input.name && input.value) {
                        formData[input.name] = input.value;
                        console.log(`  ‚úì ${input.name}: "${input.value.substring(0, 50)}${input.value.length > 50 ? '...' : ''}"`);
                    }
                });
                
                console.log(`üì¶ Total fields to save: ${Object.keys(formData).length}`);
                
                // Also save photo selection state
                if (selectedPhotos && selectedPhotos.length > 0) {
                    formData._photo_count = selectedPhotos.length;
                }
                
                if (Object.keys(formData).length === 0) {
                    console.log('‚ö†Ô∏è No data to save, skipping autosave');
                    return;
                }
                
                // Save to forms table as draft
                console.log('üíæ Saving to database...');
                const { error } = await supabaseClient
                    .from('forms')
                    .upsert({
                        case_id: currentCase.id,
                        draft_json: formData,
                        json_schema_version: 'v1',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'case_id'
                    });
                
                if (error) {
                    console.error('‚ùå Autosave failed:', error);
                } else {
                    console.log(`‚úÖ Form draft autosaved successfully (${Object.keys(formData).length} fields)`);
                    // Removed: showAutosaveIndicator(); - user requested to remove "SAVED" notification
                }
            } catch (error) {
                console.error('‚ùå Autosave error:', error);
            }
        }
        
        /**
         * Load existing form draft
         */
        async function loadFormDraft() {
            if (!currentCase) {
                console.log('‚ö†Ô∏è No case loaded, skipping draft load');
                return;
            }
            
            try {
                console.log('üì• Loading draft for case:', currentCase.id);
                
                const { data, error } = await supabaseClient
                    .from('forms')
                    .select('draft_json, submitted_at')
                    .eq('case_id', currentCase.id)
                    .single();
                
                if (error) {
                    console.log('‚ÑπÔ∏è No existing draft found (this is normal for new forms)');
                    return;
                }
                
                if (!data || !data.draft_json) {
                    console.log('‚ÑπÔ∏è No draft data available');
                    return;
                }
                
                if (data.submitted_at) {
                    console.log('‚ÑπÔ∏è Form already submitted, not loading draft');
                    return;
                }
                
                // Restore form values
                const draftData = data.draft_json;
                const fieldCount = Object.keys(draftData).filter(k => !k.startsWith('_')).length;
                console.log(`üì¶ Found draft with ${fieldCount} fields, restoring...`);
                
                let restoredCount = 0;
                Object.keys(draftData).forEach(key => {
                    if (key.startsWith('_')) return; // Skip meta fields
                    
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (!input.value) {
                            input.value = draftData[key];
                            restoredCount++;
                            console.log(`  ‚úì Restored ${key}: "${draftData[key].substring(0, 50)}${draftData[key].length > 50 ? '...' : ''}"`);
                        } else {
                            console.log(`  ‚äò Skipped ${key} (field already has value)`);
                        }
                    } else {
                        console.log(`  ‚ö†Ô∏è Field not found: ${key}`);
                    }
                });
                
                console.log(`‚úÖ Form draft loaded successfully (${restoredCount}/${fieldCount} fields restored)`);
            } catch (error) {
                console.error('‚ùå Failed to load draft:', error);
            }
        }
        
        /**
         * Show autosave indicator
         */
        function showAutosaveIndicator() {
            // Check if indicator already exists
            let indicator = document.getElementById('autosave-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'autosave-indicator';
                indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background-color: #4caf50; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-family: "Dosis Variablefont Wght", Arial, sans-serif; z-index: 9999; opacity: 0; transition: opacity 0.3s ease;';
                indicator.textContent = '‚úì Saved';
                document.body.appendChild(indicator);
            }
            
            // Show briefly
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);
        }
        
        /**
         * Update review screen - remove "Access Dashboard" button
         */
        function updateReviewScreen() {
            // The review/final screen typically has the obituary preview
            // We need to remove any "Access Dashboard" button if it exists
            // The persistent icon will be the only dashboard access point
            
            // This will be executed when the user reaches the final step
            // For now, just log that this is initialized
            console.log('‚úÖ Review screen updated (dashboard button removed, persistent icon active)');
        }
    </script>
  <script src="https://cdn.prod.website-files.com/683b63acf5908465c8825ca8%2F685146e1d8a68f749232b664%2F68ae0b3e267aed7d50d43ce0%2Femptyfieldsremoval-1.0.0.js" type="text/javascript"></script>
  <script src="https://cdn.prod.website-files.com/683b63acf5908465c8825ca8%2F685146e1d8a68f749232b664%2F68ae0b3e451db983d19c0c84%2Fmetadatahandler-0.0.5.js" type="text/javascript"></script>
  <script src="https://cdn.prod.website-files.com/683b63acf5908465c8825ca8%2F685146e1d8a68f749232b664%2F68ae0b3eebf6ed82e6d479bc%2Fenablevisiblebuttons-0.0.7.js" type="text/javascript"></script>
  <script src="https://cdn.prod.website-files.com/683b63acf5908465c8825ca8%2F685146e1d8a68f749232b664%2F68ae0b3e5d17346e14370d63%2Fenableuploadstateview-0.0.3.js" type="text/javascript"></script>
</body>
</html>