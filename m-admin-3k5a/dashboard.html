<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - Memorio</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Preload Dosis font -->
  <link rel="preload" href="../fonts/Dosis-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/memorio-forms.webflow.css" rel="stylesheet" type="text/css">
  <link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  
  <style>
    /* ============================================================================
       CSS VARIABLES FOR THEME SUPPORT (LIGHT & DARK MODE)
       ============================================================================ */
    
    :root {
      /* Light Mode Colors */
      --bg-primary: #f4e8de;
      --bg-secondary: #fff3e9;
      --bg-tertiary: #ffffff;
      --bg-hover: #f9f9f9;
      --bg-active: #f4e8de;
      
      --text-primary: #32343a;
      --text-secondary: #666666;
      --text-tertiary: #999999;
      --text-inverse: #ffffff;
      
      --border-primary: #436481;
      --border-secondary: #f4e8de;
      --border-light: #e0e0e0;
      
      --accent-primary: #6ca7d3;
      --accent-secondary: #436481;
      --accent-hover: #5a91bb;
      
      --error: #e74c3c;
      --warning: #ffc107;
      --success: #27ae60;
      
      --shadow-sm: rgba(67, 100, 129, 0.1);
      --shadow-md: rgba(0, 0, 0, 0.15);
      --shadow-lg: rgba(0, 0, 0, 0.2);
      
      --input-bg: #ffffff;
      --input-border: #ddd;
      --input-focus: #6ca7d3;
      
      --modal-overlay: rgba(0, 0, 0, 0.5);
      --notification-unread: #fff3e9;
    }
    
    [data-theme="dark"] {
      /* Dark Mode Colors */
      --bg-primary: #1a1a1a;
      --bg-secondary: #242424;
      --bg-tertiary: #2d2d2d;
      --bg-hover: #333333;
      --bg-active: #3a3a3a;
      
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-tertiary: #808080;
      --text-inverse: #1a1a1a;
      
      --border-primary: #6ca7d3;
      --border-secondary: #3a3a3a;
      --border-light: #404040;
      
      --accent-primary: #6ca7d3;
      --accent-secondary: #5a91bb;
      --accent-hover: #7bb5dc;
      
      --error: #ff6b6b;
      --warning: #ffd93d;
      --success: #51cf66;
      
      --shadow-sm: rgba(0, 0, 0, 0.3);
      --shadow-md: rgba(0, 0, 0, 0.5);
      --shadow-lg: rgba(0, 0, 0, 0.7);
      
      --input-bg: #2d2d2d;
      --input-border: #404040;
      --input-focus: #6ca7d3;
      
      --modal-overlay: rgba(0, 0, 0, 0.7);
      --notification-unread: #2d2d2d;
    }
    
    /* ============================================================================
       MEMORIO ADMIN DASHBOARD - BRAND-CONSISTENT REDESIGN
       ============================================================================ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      background-color: var(--bg-primary);
      transition: background-color 0.3s ease;
    }
    
    body {
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* ============================================================================
       SIDEBAR NAVIGATION - MEMORIO THEMED (CREAM + BLUE BORDERS)
       ============================================================================ */
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background-color: var(--bg-secondary);
      border-right: 3px solid var(--border-primary);
      box-shadow: 4px 0 15px var(--shadow-sm);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    }
    
    .sidebar-logo {
      height: 70px;
      padding: 0;
      border-bottom: 2px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar-logo img {
      width: 140px;
      height: auto;
      max-height: 60px;
      object-fit: contain;
      /* No filter in light mode - keep original colors */
      transition: filter 0.3s ease, opacity 0.3s ease;
    }
    
    [data-theme="dark"] .sidebar-logo img {
      filter: brightness(0) saturate(100%) invert(1);
      opacity: 0.9;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
      padding-bottom: 20px;
      overflow-y: auto;
    }
    
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 24px;
      margin: 4px 12px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      border: 1.5px solid transparent;
    }
    
    .sidebar-nav-item:hover {
      background-color: var(--bg-active);
      border-color: var(--accent-primary);
      color: var(--accent-secondary);
    }
    
    .sidebar-nav-item.active {
      background-color: var(--bg-active);
      border-color: var(--border-primary);
      color: var(--accent-secondary);
    }
    
    .sidebar-nav-item svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    .notification-badge {
      position: relative;
      /* Don't change display - keep the flex layout from parent */
    }
    
    .notification-badge::after {
      content: attr(data-count);
      position: absolute;
      top: -8px;
      right: -12px;
      background-color: var(--error);
      color: var(--text-inverse);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      box-shadow: 0 2px 4px var(--shadow-md);
    }
    
    .notification-badge[data-count="0"]::after,
    .notification-badge:not([data-count])::after {
      display: none;
    }
    
    /* ============================================================================
       TOP NAVBAR - MEMORIO THEMED
       ============================================================================ */
    
    .topbar {
      position: fixed;
      top: 0;
      left: 280px;
      right: 0;
      height: 70px;
      background-color: var(--bg-secondary);
      border-bottom: 2px solid var(--border-primary);
      box-shadow: 0 2px 8px var(--shadow-sm);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .topbar-title {
      color: var(--text-primary);
      font-size: 26px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .topbar-search {
      position: relative;
    }
    
    .topbar-search-input {
      width: 350px;
      padding: 11px 16px 11px 40px;
      border: 1.5px solid var(--border-primary);
      border-radius: 60px;
      font-size: 14px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      transition: all 0.2s ease;
      background-color: var(--input-bg);
      color: var(--text-primary);
    }
    
    .topbar-search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background-color: var(--bg-tertiary);
    }
    
    .topbar-search-input::placeholder {
      color: var(--text-tertiary);
    }
    
    .topbar-search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--border-primary);
    }
    
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .topbar-icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--bg-active);
      border: 1.5px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .topbar-icon-btn:hover {
      background-color: var(--accent-primary);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }
    
    .topbar-icon-btn:hover svg {
      color: var(--text-inverse);
    }
    
    .topbar-icon-btn svg {
      width: 20px;
      height: 20px;
      color: var(--text-primary);
      transition: color 0.2s ease;
    }
    
    .topbar-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background-color: var(--error);
      border-radius: 50%;
      color: var(--text-inverse);
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--bg-secondary);
    }
    
    .topbar-badge.hidden {
      display: none;
    }
    
    /* Notification Dropdown */
    .notification-dropdown {
      position: absolute;
      top: 70px;
      right: 70px;
      width: 400px;
      max-height: 500px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      box-shadow: 0 8px 24px var(--shadow-md);
      display: none;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    
    .notification-dropdown.active {
      display: flex;
    }
    
    .notification-header {
      padding: 16px 20px;
      border-bottom: 2px solid var(--border-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .notification-mark-all {
      font-size: 13px;
      color: var(--accent-primary);
      cursor: pointer;
      border: none;
      background: none;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .notification-mark-all:hover {
      background-color: var(--bg-active);
      color: var(--accent-secondary);
    }
    
    .notification-list {
      overflow-y: auto;
      max-height: 400px;
    }
    
    .notification-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-secondary);
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .notification-item:hover {
      background-color: var(--bg-hover);
    }
    
    .notification-item.unread {
      background-color: var(--notification-unread);
    }
    
    .notification-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .notification-icon svg {
      width: 16px;
      height: 16px;
      color: var(--text-inverse);
    }
    
    .notification-icon.warning {
      background-color: var(--warning);
    }
    
    .notification-icon.error {
      background-color: var(--error);
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .notification-text {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .notification-time {
      font-size: 12px;
      color: var(--text-tertiary);
    }
    
    .notification-empty {
      padding: 48px 20px;
      text-align: center;
      color: var(--text-tertiary);
    }
    
    .notification-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .notification-footer {
      padding: 12px 20px;
      border-top: 2px solid var(--border-secondary);
      text-align: center;
    }
    
    .notification-view-all {
      font-size: 13px;
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .notification-view-all:hover {
      color: var(--accent-secondary);
      text-decoration: underline;
    }
    
    .topbar-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px 6px 6px;
      background-color: var(--bg-active);
      border: 1.5px solid var(--border-primary);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .topbar-profile:hover {
      background-color: var(--accent-primary);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }
    
    .topbar-profile:hover .topbar-profile-name {
      color: var(--text-inverse);
    }
    
    .topbar-profile:hover .topbar-profile-avatar {
      background-color: var(--text-primary);
    }
    
    .topbar-profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--accent-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-inverse);
      font-weight: 600;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    .topbar-profile-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      transition: color 0.2s ease;
    }
    
    /* Profile Dropdown - Same Width as Profile Button */
    .topbar-profile-wrapper {
      position: relative;
    }
    
    .topbar-profile-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      width: 100%;
      background-color: var(--bg-secondary);
      border: 1.5px solid var(--border-primary);
      box-shadow: 0 4px 12px var(--shadow-md);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 9999;
      overflow: hidden;
    }
    
    .topbar-profile-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .topbar-profile-dropdown-item {
      padding: 10px 14px;
      color: var(--text-primary);
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
    }
    
    .topbar-profile-dropdown-item:hover {
      background-color: #6ca7d3;
      color: white;
    }
    
    .topbar-profile-dropdown-item svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    
    /* ============================================================================
       MAIN CONTENT AREA
       ============================================================================ */
    
    .main-content {
      margin-left: 280px;
      margin-top: 70px;
      padding: 32px;
      min-height: calc(100vh - 70px);
      background-color: var(--bg-primary);
      transition: background-color 0.3s ease;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      margin-bottom: 32px;
    }
    
    .dashboard-title {
      color: var(--text-primary);
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
      transition: color 0.3s ease;
    }
    
    .dashboard-subtitle {
      color: var(--text-secondary);
      font-size: 15px;
      transition: color 0.3s ease;
    }
    
    /* ============================================================================
       CARDS & SECTIONS - MEMORIO STYLE
       ============================================================================ */
    
    .invite-section {
      background-color: var(--bg-secondary);
      border: 3px solid var(--border-primary);
      border-radius: 20px;
      padding: 48px;
      margin-bottom: 40px;
      box-shadow: 0 2px 8px -2px var(--shadow-md);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    
    .section-title {
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      margin-bottom: 20px;
      transition: color 0.3s ease;
    }
    
    .paragraph {
      color: var(--text-primary);
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 24px;
      transition: color 0.3s ease;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-row-single {
      margin-bottom: 20px;
    }
    
    /* ============================================================================
       FORM ELEMENTS - MEMORIO STYLE
       ============================================================================ */
    
    .field-label {
      display: block;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      margin-bottom: 8px;
      transition: color 0.3s ease;
    }
    
    .text-field {
      width: 100%;
      padding: 12px 16px;
      border: 0.5px solid var(--input-border);
      border-radius: 5px;
      font-size: 15px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      transition: all 0.2s ease;
      background-color: var(--input-bg);
      color: var(--text-primary);
    }
    
    .text-field:focus {
      outline: none;
      border-color: var(--border-primary);
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .text-field:disabled {
      background-color: var(--bg-active);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    /* ============================================================================
       BUTTONS - MEMORIO STYLE
       ============================================================================ */
    
    .button-primary {
      padding: 11px 18px;
      background-color: var(--accent-secondary);
      color: var(--text-inverse);
      border: none;
      border-radius: 60px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .button-primary:hover {
      background-color: var(--accent-secondary);
      color: var(--accent-primary);
      text-shadow: 0 3px 6px var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .button-primary:active {
      transform: translateY(0);
    }
    
    .button-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      padding: 10px 18px;
      background-color: var(--bg-active);
      color: var(--text-primary);
      border: 1.5px solid var(--border-primary);
      border-radius: 60px;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
      background-color: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--text-inverse);
      transform: translateY(-1px);
    }
    
    .logout-btn {
      padding: 10px 18px;
      background-color: var(--accent-secondary);
      color: var(--text-inverse);
      border: none;
      border-radius: 60px;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      color: var(--accent-primary);
      text-shadow: 0 3px 6px var(--shadow-md);
      transform: translateY(-2px);
    }
    
    /* ============================================================================
       SUCCESS & ERROR BOXES - MEMORIO STYLE
       ============================================================================ */
    
    .success-box {
      background-color: #e8f5e9;
      border: 2px solid #66bb6a;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .success-box h3 {
      color: #2e7d32;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .success-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      background-color: #66bb6a;
      border-radius: 50%;
      position: relative;
    }
    
    .success-icon::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    
    .error-box {
      background-color: #ffebee;
      border: 2px solid #ef5350;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      color: #c62828;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      display: none;
      font-weight: 500;
      animation: slideIn 0.3s ease;
    }
    
    .credential-box {
      background-color: var(--bg-active);
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      position: relative;
      transition: background-color 0.3s ease;
    }
    
    .credential-label {
      color: var(--text-tertiary);
      font-size: 12px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }
    
    .credential-value {
      color: var(--text-primary);
      font-size: 18px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      word-break: break-all;
    }
    
    .copy-btn {
      background-color: var(--accent-secondary);
      color: var(--text-inverse);
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 12px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      cursor: pointer;
      margin-top: 5px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .copy-btn:hover {
      background-color: var(--accent-primary);
      transform: translateY(-1px);
    }
    
    .error-box {
      background-color: #ffebee;
      border: 2px solid #ef5350;
      border-radius: 10px;
      padding: 15px;
      color: #c62828;
      margin-top: 20px;
      display: none;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background-color: transparent;
      border: 2px solid var(--border-primary);
      border-radius: 60px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .tab-btn.active {
      background-color: var(--accent-secondary);
      color: var(--text-inverse);
    }
    
    .tab-btn:hover {
      background-color: var(--accent-secondary);
      color: var(--text-inverse);
    }
    
    .tab-content {
      display: none;
      background-color: transparent;
    }
    
    .tab-content.active {
      display: block;
      background-color: transparent;
    }
    
    .org-card {
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .org-card:hover {
      box-shadow: 0 4px 12px var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .org-card-name {
      color: var(--text-primary);
      font-size: 20px;
      font-weight: 600;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      margin-bottom: 10px;
    }
    
    .org-card-detail {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .org-card-id {
      background-color: var(--bg-active);
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
      transition: background-color 0.3s ease;
    }
    
    /* Custom Confirmation Modal */
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .confirmation-content {
      background-color: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .confirmation-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .confirmation-title {
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
      transition: color 0.3s ease;
    }
    
    .confirmation-message {
      color: var(--text-secondary);
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 24px;
      transition: color 0.3s ease;
    }
    
    .confirmation-warning {
      background-color: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      color: #e65100;
      font-size: 14px;
      font-weight: 600;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .btn-confirm-delete {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-confirm-delete:hover {
      background-color: #d32f2f;
    }
    
    .btn-cancel {
      background-color: #f0f0f0;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-cancel:hover {
      background-color: #e0e0e0;
    }
    
    /* Success Modal */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .success-content {
      background-color: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .success-icon {
      width: 24px;
      height: 24px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .success-title {
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
      transition: color 0.3s ease;
    }
    
    .success-message {
      color: var(--text-secondary);
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 24px;
      transition: color 0.3s ease;
    }
    
    .btn-success-ok {
      background-color: #436481;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-success-ok:hover {
      background-color: #1e3a52;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }
      
      .tab-container {
        flex-direction: column;
      }
    }
    
    /* Organization Details Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 10px;
      padding: 0;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
      background-color: var(--bg-active);
      padding: 20px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease;
    }
    
    .modal-title {
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: var(--text-primary);
    }
    
    .modal-section {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-section:last-of-type {
      border-bottom: none;
    }
    
    .modal-section-title {
      color: var(--text-primary);
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: color 0.3s ease;
    }
    
    .modal-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
    }
    
    .modal-icon-org {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2332343a'%3E%3Cpath d='M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9M19 9H14V4H5V21H19V9Z'/%3E%3C/svg%3E");
    }
    
    .modal-icon-users {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2332343a'%3E%3Cpath d='M16 4C18.21 4 20 5.79 20 8S18.21 12 16 12 12 10.21 12 8 13.79 4 16 4M16 14C18.67 14 24 15.33 24 18V20H8V18C8 15.33 13.33 14 16 14M8 4C10.21 4 12 5.79 12 8S10.21 12 8 12 4 10.21 4 8 5.79 4 8 4M8 14C10.67 14 16 15.33 16 18V20H0V18C0 15.33 5.33 14 8 14Z'/%3E%3C/svg%3E");
    }
    
    .modal-icon-key {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2332343a'%3E%3Cpath d='M7 14C5.9 14 5 13.1 5 12S5.9 10 7 10 9 10.9 9 12 8.1 14 7 14M12.6 10C11.8 7.7 9.6 6 7 6C3.7 6 1 8.7 1 12S3.7 18 7 18C9.6 18 11.8 16.3 12.6 14H16V18H20V14H23V10H12.6Z'/%3E%3C/svg%3E");
    }
    
    .modal-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .modal-detail-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    
    .modal-detail-label {
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 120px;
      font-size: 14px;
      transition: color 0.3s ease;
    }
    
    .modal-detail-value {
      color: var(--text-primary);
      font-size: 14px;
      flex: 1;
      word-break: break-all;
      transition: color 0.3s ease;
    }
    
    .reveal-btn {
      background-color: var(--bg-active);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      margin-left: auto;
      transition: background-color 0.2s ease;
    }
    
    .reveal-btn:hover {
      background-color: var(--bg-hover);
    }
    
    .modal-footer {
      padding: 20px;
      background-color: var(--bg-hover);
      border-radius: 0 0 10px 10px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      transition: background-color 0.3s ease;
    }
    
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .modal-btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .modal-btn-danger:hover {
      background-color: #c82333;
    }
    
    .modal-btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .modal-btn-secondary:hover {
      background-color: #5a6268;
    }
    
    /* Toast Notification Styles */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.error {
      background-color: #dc3545;
    }
    
    /* ============================================================================
       RESPONSIVE DESIGN
       ============================================================================ */
    
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-280px);
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .topbar {
        left: 0;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .topbar-search {
        display: none;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .topbar-title {
        font-size: 18px;
      }
      
      .main-content {
        padding: 16px;
      }
      
      .invite-section {
        padding: 20px;
      }
      
      .section-title {
        font-size: 18px;
      }
      
      .topbar-profile-name {
        display: none;
      }
    }
    
    /* ============================================================================
       UTILITY CLASSES
       ============================================================================ */
    
    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }
    
    .text-sm { font-size: 13px; }
    .text-lg { font-size: 17px; }
    
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }
    
    /* Hide old nav completely */
    .nav {
      display: none !important;
    }
    
    /* ============================================================================
       COMPREHENSIVE DARK MODE OVERRIDES FOR REMAINING ELEMENTS
       ============================================================================ */
    
    .topbar-profile-dropdown {
      background-color: var(--bg-secondary);
      border-color: var(--border-primary);
      box-shadow: 0 4px 12px var(--shadow-md);
    }
    
    .topbar-profile-dropdown-item {
      color: var(--text-primary);
    }
    
    .topbar-profile-dropdown-item:hover {
      background-color: var(--accent-primary);
      color: var(--text-inverse);
    }
    
    .dashboard-title, .section-title, .heading {
      color: var(--text-primary) !important;
    }
    
    .dashboard-subtitle, .paragraph {
      color: var(--text-secondary) !important;
    }
    
    .invite-section, .section, .card {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-primary) !important;
    }
    
    .org-card {
      background-color: var(--bg-tertiary) !important;
      border-color: var(--border-primary) !important;
    }
    
    .org-card:hover {
      border-color: var(--accent-primary) !important;
    }
    
    .org-card-name {
      color: var(--text-primary) !important;
    }
    
    .org-card-detail {
      color: var(--text-secondary) !important;
    }
    
    .form-label, .label, .credential-label {
      color: var(--text-primary) !important;
    }
    
    .form-input, .text-field, input[type="text"], input[type="email"], input[type="password"], select, textarea {
      background-color: var(--input-bg) !important;
      border-color: var(--input-border) !important;
      color: var(--text-primary) !important;
    }
    
    .form-input:focus, .text-field:focus, input:focus, select:focus, textarea:focus {
      border-color: var(--input-focus) !important;
    }
    
    .btn-primary, .button-primary {
      background-color: var(--accent-primary) !important;
      border-color: var(--accent-primary) !important;
      color: var(--text-inverse) !important;
    }
    
    .btn-primary:hover, .button-primary:hover {
      background-color: var(--accent-hover) !important;
    }
    
    .btn-secondary, .button-secondary {
      background-color: transparent !important;
      border-color: var(--border-primary) !important;
      color: var(--text-primary) !important;
    }
    
    .btn-secondary:hover, .button-secondary:hover {
      background-color: var(--bg-active) !important;
    }
    
    .modal-overlay {
      background-color: var(--modal-overlay) !important;
    }
    
    .modal, .modal-content {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-primary) !important;
    }
    
    .modal-title {
      color: var(--text-primary) !important;
    }
    
    .modal-body, .modal-text {
      color: var(--text-secondary) !important;
    }
    
    .error-message, .error-box {
      background-color: var(--error) !important;
      color: var(--text-inverse) !important;
    }
    
    .success-message, .success-box {
      background-color: var(--success) !important;
      color: var(--text-inverse) !important;
    }
    
    table {
      background-color: var(--bg-tertiary) !important;
    }
    
    thead {
      background-color: var(--bg-secondary) !important;
    }
    
    th {
      color: var(--text-primary) !important;
      border-color: var(--border-secondary) !important;
    }
    
    td {
      color: var(--text-secondary) !important;
      border-color: var(--border-secondary) !important;
    }
    
    tr:hover {
      background-color: var(--bg-hover) !important;
    }
    
    .copy-btn, .btn-sm {
      background-color: var(--accent-primary) !important;
      color: var(--text-inverse) !important;
    }
    
    .copy-btn:hover, .btn-sm:hover {
      background-color: var(--accent-hover) !important;
    }
    
    .credential-value {
      color: var(--text-primary) !important;
      background-color: var(--bg-active) !important;
    }
    
    /* Scrollbar styling for dark mode */
    [data-theme="dark"] *::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    [data-theme="dark"] *::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    [data-theme="dark"] *::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 6px;
    }
    
    [data-theme="dark"] *::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }
    
    /* Fix tab-content background in dark mode */
    [data-theme="dark"] .tab-content {
      background-color: var(--bg-primary) !important;
    }
    
    [data-theme="dark"] .tab-content.active {
      background-color: var(--bg-primary) !important;
    }
    
    /* Ensure invite-section and other section containers have dark backgrounds */
    [data-theme="dark"] .invite-section,
    [data-theme="dark"] .section {
      background-color: var(--bg-secondary) !important;
    }
    
    /* Fix accounts-container and other specific containers */
    [data-theme="dark"] .accounts-container,
    [data-theme="dark"] .filters-bar,
    [data-theme="dark"] .kanban-board {
      background-color: transparent !important;
    }
    
    /* ============================================================================
       ALL CASES TAB - KANBAN BOARD STYLES
       ============================================================================ */
    
    .filters-bar {
      background-color: var(--bg-secondary);
      border: 2px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 180px;
    }
    
    .filter-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .filter-select,
    .filter-input {
      padding: 10px 14px;
      border: 2px solid var(--border-primary);
      border-radius: 8px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      font-size: 15px;
      background-color: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
    }
    
    .filter-select:focus,
    .filter-input:focus {
      border-color: var(--accent-primary);
    }
    
    .filter-button {
      padding: 11px 24px;
      background-color: var(--accent-primary);
      color: var(--text-inverse);
      border: none;
      border-radius: 8px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      align-self: flex-end;
    }
    
    .filter-button:hover {
      background-color: var(--accent-hover);
    }
    
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }
    
    @media (max-width: 1400px) {
      .kanban-board {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .kanban-board {
        grid-template-columns: 1fr;
      }
    }
    
    .kanban-column {
      background-color: var(--bg-secondary);
      border: 2px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .kanban-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-primary);
    }
    
    .kanban-column-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .kanban-column-count {
      background-color: var(--accent-primary);
      color: var(--text-inverse);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .kanban-column-cards {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }
    
    .case-card {
      background-color: var(--bg-tertiary);
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .case-card:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 4px 12px var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .case-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .case-card-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }
    
    .sla-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .sla-badge.green {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #66bb6a;
    }
    
    .sla-badge.yellow {
      background-color: #fff9e6;
      color: #d68000;
      border: 1px solid #ffeb3b;
    }
    
    .sla-badge.orange {
      background-color: #fff3e0;
      color: #e65100;
      border: 1px solid #ff9800;
    }
    
    .sla-badge.red {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    
    .case-card-org {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .case-card-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .case-card-meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .meta-icon {
      width: 16px;
      text-align: center;
    }
    
    .case-card-footer {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-tertiary);
    }
    
    /* ============================================================================
       MANAGE ACCOUNTS TAB STYLES
       ============================================================================ */
    
    .accounts-container {
      max-width: 1200px;
    }
    
    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .account-card {
      background-color: var(--bg-tertiary);
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    
    .account-card:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 4px 12px var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .account-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .account-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .account-email {
      font-size: 14px;
      color: var(--text-secondary);
      word-break: break-all;
    }
    
    .account-role-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }
    
    .account-role-badge.admin {
      background-color: #e3f2fd;
      color: #1565c0;
      border: 1px solid #64b5f6;
    }
    
    .account-role-badge.director {
      background-color: #f3e5f5;
      color: #6a1b9a;
      border: 1px solid #ab47bc;
    }
    
    .account-role-badge.editor {
      background-color: #fff3e0;
      color: #e65100;
      border: 1px solid #ff9800;
    }
    
    .account-role-badge.qc {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #66bb6a;
    }
    
    .account-status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .account-status-badge.active {
      background-color: var(--success);
      color: var(--text-inverse);
    }
    
    .account-status-badge.invited {
      background-color: var(--warning);
      color: var(--text-inverse);
    }
    
    .account-status-badge.suspended {
      background-color: var(--error);
      color: var(--text-inverse);
    }
    
    .account-info {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .account-info-row {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    .account-info-label {
      font-weight: 600;
    }
    
    .account-actions {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 8px;
    }
    
    .account-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .account-btn-primary {
      background-color: var(--accent-primary);
      color: var(--text-inverse);
    }
    
    .account-btn-primary:hover {
      background-color: var(--accent-hover);
    }
    
    .account-btn-danger {
      background-color: var(--error);
      color: var(--text-inverse);
    }
    
    .account-btn-danger:hover {
      opacity: 0.9;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .empty-state-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    /* ============================================================================
       CASE DETAIL MODAL
       ============================================================================ */
    
    .case-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--modal-overlay);
      z-index: 10000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .case-detail-modal.active {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    
    .case-detail-content {
      background-color: var(--bg-secondary);
      border: 3px solid var(--border-primary);
      border-radius: 20px;
      padding: 0;
      max-width: 1400px;
      width: 100%;
      position: relative;
      margin: 20px 0;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    .case-detail-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-active);
      border: 2px solid var(--border-primary);
      font-size: 24px;
      color: var(--text-primary);
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .case-detail-close:hover {
      background-color: var(--accent-primary);
      color: white;
      transform: scale(1.1);
    }
    
    .case-detail-header {
      border-bottom: 2px solid var(--border-secondary);
      padding: 30px 40px;
      background-color: var(--bg-active);
      border-radius: 20px 20px 0 0;
    }
    
    .case-detail-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      padding-right: 50px;
    }
    
    .case-detail-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .case-detail-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .case-detail-meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .case-detail-meta-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .case-detail-meta-value {
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .case-detail-body {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }
    
    .case-detail-main {
      overflow-y: auto;
      max-height: calc(90vh - 250px);
    }
    
    .case-detail-sidebar {
      background-color: var(--bg-active);
      border-left: 2px solid var(--border-secondary);
      padding: 24px;
      overflow-y: auto;
      max-height: calc(90vh - 250px);
    }
    
    /* Tabs in Modal */
    .modal-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-secondary);
      background-color: var(--bg-tertiary);
      padding: 0 20px;
    }
    
    .modal-tab-btn {
      padding: 16px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .modal-tab-btn:hover {
      color: var(--text-primary);
      background-color: var(--bg-hover);
    }
    
    .modal-tab-btn.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }
    
    .modal-tab-content {
      display: none;
      padding: 24px 40px;
    }
    
    .modal-tab-content.active {
      display: block;
    }
    
    /* Section Styling */
    .case-detail-section {
      margin-bottom: 30px;
    }
    
    .case-detail-section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .case-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .case-detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .case-detail-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .case-detail-value {
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Timeline in Modal */
    .modal-timeline {
      position: relative;
      padding-left: 32px;
    }
    
    .modal-timeline::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: var(--border-primary);
    }
    
    .modal-timeline-item {
      position: relative;
      margin-bottom: 20px;
      padding-left: 24px;
    }
    
    .modal-timeline-item::before {
      content: '';
      position: absolute;
      left: -27px;
      top: 4px;
      width: 12px;
      height: 12px;
      background-color: var(--accent-primary);
      border: 2px solid var(--bg-secondary);
      border-radius: 50%;
    }
    
    .modal-timeline-time {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }
    
    .modal-timeline-event {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .modal-timeline-actor {
      font-size: 13px;
      color: var(--accent-primary);
      font-weight: 600;
      margin-top: 4px;
    }
    
    /* Assets Grid in Modal */
    .modal-assets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }
    
    .modal-asset-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--border-primary);
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .modal-asset-item:hover {
      transform: scale(1.05);
    }
    
    .modal-asset-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Form Data in Modal */
    .modal-form-data-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border-secondary);
    }
    
    .modal-form-data-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .modal-form-data-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .modal-form-data-label {
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .modal-form-data-value {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Support Actions in Sidebar */
    .support-actions-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-secondary);
    }
    
    .support-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .support-action-btn {
      width: 100%;
      padding: 12px 16px;
      background-color: var(--bg-secondary);
      border: 2px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .support-action-btn:hover {
      background-color: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }
    
    .support-action-btn.danger {
      border-color: var(--error-border);
      color: var(--error-text);
    }
    
    .support-action-btn.danger:hover {
      background-color: var(--error-border);
      color: white;
    }
    
    /* Empty States */
    .modal-empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-tertiary);
      font-size: 14px;
    }
    
    .modal-loading {
      text-align: center;
      padding: 40px;
      color: var(--accent-primary);
      font-size: 14px;
      font-weight: 600;
    }
    
    @media (max-width: 1024px) {
      .case-detail-body {
        grid-template-columns: 1fr;
      }
      
      .case-detail-sidebar {
        border-left: none;
        border-top: 2px solid var(--border-secondary);
      }
    }
    
    @media (max-width: 768px) {
      .case-detail-grid,
      .modal-form-data-grid {
        grid-template-columns: 1fr;
      }
      
      .case-detail-content {
        padding: 0;
        margin: 10px;
      }
      
      .case-detail-header {
        padding: 20px;
      }
      
      .modal-tab-content {
        padding: 16px 20px;
      }
    }
  </style>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="body">
  
  <!-- ============================================================================
       SIDEBAR NAVIGATION
       ============================================================================ -->
  <div class="sidebar">
    <!-- Logo -->
    <div class="sidebar-logo">
      <img src="../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png" alt="Memorio Logo">
    </div>

    <!-- Navigation -->
    <div class="sidebar-nav">
      <div class="sidebar-nav-item notification-badge" id="allCasesNavLink" data-count="0" onclick="switchTab('all-cases')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
        <span>All Cases</span>
      </div>

      <div class="sidebar-nav-item" onclick="switchTab('manage-accounts')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
        </svg>
        <span>Manage Accounts</span>
      </div>

      <div class="sidebar-nav-item active" onclick="switchTab('organizations')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
        </svg>
        <span>Organizations</span>
      </div>

      <div class="sidebar-nav-item" onclick="switchTab('invite-director')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          <path d="M19 13h-2v-2h-2v2h-2v2h2v2h2v-2h2z" fill="currentColor" opacity="0.7"/>
        </svg>
        <span>Invite Director</span>
      </div>

      <div class="sidebar-nav-item" onclick="switchTab('invite-editor')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.41 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
        </svg>
        <span>Invite Editor</span>
      </div>

      <div class="sidebar-nav-item" onclick="switchTab('invite-qc')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <span>Invite QC User</span>
      </div>

      <div class="sidebar-nav-item" onclick="switchTab('assign-editor')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3zm6 12H6v-1c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1z"/>
        </svg>
        <span>Assign Editor</span>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       TOP NAVBAR
       ============================================================================ -->
  <div class="topbar">
    <div class="topbar-left">
      <h1 class="topbar-title" id="topbar-page-title">Organizations</h1>
      <div class="topbar-search">
        <svg class="topbar-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input type="text" class="topbar-search-input" placeholder="Search organizations, users, cases..." id="topbar-search">
      </div>
    </div>

    <div class="topbar-right">
      <!-- Notifications -->
      <button class="topbar-icon-btn" id="notificationBtn" title="Notifications" onclick="toggleNotifications()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <span class="topbar-badge hidden" id="notificationBadge">0</span>
      </button>
      
      <!-- Notification Dropdown -->
      <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
          <h3>Notifications</h3>
          <button class="notification-mark-all" onclick="markAllAsRead()">Mark all as read</button>
        </div>
        <div class="notification-list" id="notificationList">
          <!-- Notifications will be loaded here -->
        </div>
        <div class="notification-footer">
          <a href="javascript:void(0);" onclick="switchTab('all-cases'); toggleNotifications();" class="notification-view-all">View All Cases</a>
        </div>
      </div>

      <!-- Dark Mode Toggle -->
      <button class="topbar-icon-btn" id="themeToggle" title="Toggle Dark Mode" onclick="toggleTheme()">
        <!-- Sun icon (shown in dark mode) -->
        <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
          <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
        </svg>
        <!-- Moon icon (shown in light mode) -->
        <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
        </svg>
      </button>

      <!-- Profile with Dropdown -->
      <div class="topbar-profile-wrapper">
        <div class="topbar-profile" onclick="toggleProfileDropdown()" style="cursor: pointer;">
          <div class="topbar-profile-avatar">A</div>
          <span class="topbar-profile-name">Admin</span>
          <svg style="width: 16px; height: 16px; color: #436481; transition: transform 0.2s ease;" id="profile-dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 10l5 5 5-5z"/>
          </svg>
        </div>
        
        <!-- Dropdown Menu -->
        <div class="topbar-profile-dropdown" id="profile-dropdown">
          <div class="topbar-profile-dropdown-item" onclick="handleLogout()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            <span>Logout</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       MAIN CONTENT AREA
       ============================================================================ -->
  <div class="main-content">
    <div class="dashboard-container">
    
      <!-- Tabs (Hidden - controlled by sidebar) -->
      <div class="tab-container" style="display: none;">
        <button class="tab-btn active" onclick="switchTab('organizations')">Organizations</button>
        <button class="tab-btn" onclick="switchTab('invite-director')">Invite Director</button>
        <button class="tab-btn" onclick="switchTab('invite-editor')">Invite Editor</button>
        <button class="tab-btn" onclick="switchTab('assign-editor')">Assign Editor</button>
      </div>

    <!-- All Cases Tab -->
    <div id="all-cases-tab" class="tab-content">
      <!-- Filters Bar -->
      <div class="filters-bar">
        <div class="filter-group">
          <label class="filter-label">Organization</label>
          <select class="filter-select" id="filter-org">
            <option value="">All Organizations</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-select" id="filter-status">
            <option value="">All Statuses</option>
            <option value="waiting_on_family">Waiting on Family</option>
            <option value="submitted">Submitted</option>
            <option value="in_production">In Production</option>
            <option value="awaiting_review">Awaiting Review</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Search</label>
          <input type="text" class="filter-input" id="filter-search" placeholder="Search by name...">
        </div>
        
        <button class="filter-button" onclick="applyFilters()">Apply Filters</button>
      </div>
      
      <!-- Kanban Board -->
      <div class="kanban-board">
        <!-- Waiting on Family -->
        <div class="kanban-column">
          <div class="kanban-column-header">
            <h2 class="kanban-column-title">Waiting on Family</h2>
            <span class="kanban-column-count" id="count-waiting">0</span>
          </div>
          <div class="kanban-column-cards" id="column-waiting">
            <div class="loading">Loading...</div>
          </div>
        </div>
        
        <!-- In Progress -->
        <div class="kanban-column">
          <div class="kanban-column-header">
            <h2 class="kanban-column-title">In Progress</h2>
            <span class="kanban-column-count" id="count-progress">0</span>
          </div>
          <div class="kanban-column-cards" id="column-progress">
            <div class="loading">Loading...</div>
          </div>
        </div>
        
        <!-- Awaiting Review -->
        <div class="kanban-column">
          <div class="kanban-column-header">
            <h2 class="kanban-column-title">Awaiting Review</h2>
            <span class="kanban-column-count" id="count-review">0</span>
          </div>
          <div class="kanban-column-cards" id="column-review">
            <div class="loading">Loading...</div>
          </div>
        </div>
        
        <!-- Complete -->
        <div class="kanban-column">
          <div class="kanban-column-header">
            <h2 class="kanban-column-title">Complete</h2>
            <span class="kanban-column-count" id="count-complete">0</span>
          </div>
          <div class="kanban-column-cards" id="column-complete">
            <div class="loading">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manage Accounts Tab -->
    <div id="manage-accounts-tab" class="tab-content">
      <div class="accounts-container">
        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
          <div class="invite-section" style="padding: 24px; margin-bottom: 0;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Total Editors</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-primary);" id="totalEditors">0</div>
          </div>
          <div class="invite-section" style="padding: 24px; margin-bottom: 0;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Active Editors</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="activeEditors">0</div>
          </div>
          <div class="invite-section" style="padding: 24px; margin-bottom: 0;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Total QC Users</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-primary);" id="totalQC">0</div>
          </div>
          <div class="invite-section" style="padding: 24px; margin-bottom: 0;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Active QC Users</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="activeQC">0</div>
          </div>
        </div>
        
        <!-- Accounts Section -->
        <div class="invite-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 class="section-title" style="margin: 0;">All Accounts</h2>
            <div style="display: flex; gap: 12px;">
              <button class="btn-secondary" style="padding: 10px 20px; font-size: 14px;" onclick="filterManageAccounts('all')">All</button>
              <button class="btn-secondary" style="padding: 10px 20px; font-size: 14px;" onclick="filterManageAccounts('editor')">Editors</button>
              <button class="btn-secondary" style="padding: 10px 20px; font-size: 14px;" onclick="filterManageAccounts('qc')">QC Users</button>
              <button class="btn-secondary" style="padding: 10px 20px; font-size: 14px;" onclick="filterManageAccounts('active')">Active Only</button>
            </div>
          </div>
          
          <div id="accountsGrid" class="accounts-grid">
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ‘¥</div>
              <div class="empty-state-text">Loading accounts...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Organizations Tab -->
    <div id="organizations-tab" class="tab-content active">
      <!-- Unassigned Cases Notification -->
      <div id="unassigned-cases-alert" class="error-box" style="display: none; margin-bottom: 24px; background-color: #fff3cd; border-color: #ffc107; color: #856404;">
        <h3 style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 24px;">âš ï¸</span>
          <span id="unassigned-count">0</span> Cases Need Editor Assignment
        </h3>
        <p style="margin-bottom: 12px;">The following cases were submitted by families but could not be auto-assigned because no editors were available.</p>
        <div id="unassigned-cases-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
        <button onclick="switchTab('all-cases')" class="button-primary w-button" style="display: inline-block; margin-top: 8px; cursor: pointer;">
          Go to All Cases to Assign
        </button>
      </div>
      
      <div class="invite-section">
        <h2 class="section-title">Create New Organization</h2>
        <p class="paragraph">Add a new funeral home to the Memorio platform. Each organization can have multiple Directors and manage their own cases.</p>
        
        <form id="create-org-form">
          <div class="form-row">
            <div>
              <label for="org-name" class="field-label">Organization Name*</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="org-name" 
                placeholder="Smith Family Funeral Home" 
                required>
            </div>
            
            <div>
              <label for="org-email" class="field-label">Contact Email*</label>
              <input 
                class="text-field w-input" 
                type="email" 
                id="org-email" 
                placeholder="contact@smithfuneral.com" 
                required>
            </div>
          </div>
          
          <div class="form-row">
            <div>
              <label for="org-phone" class="field-label">Contact Phone</label>
              <input 
                class="text-field w-input" 
                type="tel" 
                id="org-phone" 
                placeholder="+1-555-0123">
            </div>
            
            <div>
              <label for="org-region" class="field-label">Region</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="org-region" 
                placeholder="New York, NY">
            </div>
          </div>
          
          <div class="form-button" style="margin-top: 20px;">
            <button type="submit" class="button-primary w-button" id="create-org-btn">
              CREATE ORGANIZATION
            </button>
          </div>
        </form>
        
        <!-- Success Box -->
        <div id="org-success-box" class="success-box">
          <h3><span class="success-icon"></span>Organization Created Successfully!</h3>
          <p>Use this Organization ID when inviting Directors for this funeral home.</p>
          
          <div class="credential-box">
            <div class="credential-label">Organization Name</div>
            <div class="credential-value" id="created-org-name"></div>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Organization ID (use this when inviting Directors)</div>
            <div class="credential-value" id="created-org-id"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-org-id')">Copy ID</button>
          </div>
        </div>
        
        <!-- Error Box -->
        <div id="org-error-box" class="error-box"></div>
      </div>

      <!-- Existing Organizations List -->
      <div class="invite-section" style="margin-top: 40px;">
        <h2 class="section-title">Existing Organizations</h2>
        <p class="paragraph">All funeral homes registered in Memorio. Copy the Organization ID to use when inviting Directors.</p>
        
        <div id="organizations-list" style="margin-top: 20px;">
          <!-- Organizations will be loaded here -->
        </div>
        
        <div id="org-list-error-box" class="error-box"></div>
      </div>
    </div>

    <!-- Invite Director Tab -->
    <div id="invite-director-tab" class="tab-content">
    <!-- Invite Director Section -->
    <div class="invite-section">
      <h2 class="section-title">Invite Director</h2>
      <p class="paragraph">Create a new Director account for a funeral home. The credentials will be displayed below for you to share securely.</p>
      
      <form id="invite-form">
        <div class="form-row">
          <div>
            <label for="director-email" class="field-label">Email Address*</label>
            <input 
              class="text-field w-input" 
              type="email" 
              id="director-email" 
              placeholder="director@funeralhome.com" 
              required>
          </div>
          
          <div>
            <label for="director-name" class="field-label">Full Name*</label>
            <input 
              class="text-field w-input" 
              type="text" 
              id="director-name" 
              placeholder="John Director" 
              required>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="director-phone" class="field-label">Phone Number</label>
            <input 
              class="text-field w-input" 
              type="tel" 
              id="director-phone" 
              placeholder="+1-555-0123">
          </div>
          
          <div>
            <label for="org-id" class="field-label">Organization ID*</label>
            <input 
              class="text-field w-input" 
              type="text" 
              id="org-id" 
              placeholder="00000000-0000-0000-0000-000000000001" 
              required>
          </div>
        </div>
        
        <div class="form-button" style="margin-top: 20px;">
          <button type="submit" class="button-primary w-button" id="invite-btn">
            CREATE DIRECTOR ACCOUNT
          </button>
        </div>
      </form>
      
      <!-- Success Box -->
      <div id="success-box" class="success-box">
        <h3><span class="success-icon"></span>Director Account Created Successfully!</h3>
        <p>Share these credentials with the Director securely. They should change their password after first login.</p>
        
        <div class="credential-box">
          <div class="credential-label">Email Address</div>
          <div class="credential-value" id="created-email"></div>
          <button class="copy-btn" onclick="copyToClipboard('created-email')">Copy</button>
        </div>
        
        <div class="credential-box">
          <div class="credential-label">Temporary Password</div>
          <div class="credential-value" id="created-password"></div>
          <button class="copy-btn" onclick="copyToClipboard('created-password')">Copy</button>
        </div>
        
        <div class="credential-box">
          <div class="credential-label">Login URL</div>
          <div class="credential-value">https://memorio.ai/m-director-9m6z/login.html</div>
          <button class="copy-btn" onclick="copyToClipboard('login-url')">Copy</button>
        </div>
      </div>
      
      <!-- Error Box -->
      <div id="error-box" class="error-box"></div>
    </div>
    </div>

    <!-- Invite Editor Tab -->
    <div id="invite-editor-tab" class="tab-content">
      <div class="invite-section">
        <h2 class="section-title">Invite Video Editor</h2>
        <p class="paragraph">Create a new Video Editor account. Editors create memorial tribute slideshow videos using family photos.</p>
        
        <form id="invite-editor-form">
          <div class="form-row">
            <div>
              <label for="editor-email" class="field-label">Email Address*</label>
              <input 
                class="text-field w-input" 
                type="email" 
                id="editor-email" 
                placeholder="editor@memorio.ai" 
                required>
            </div>
            
            <div>
              <label for="editor-name" class="field-label">Full Name*</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="editor-name" 
                placeholder="Jane Editor" 
                required>
            </div>
          </div>
          
          <div class="form-row-single">
            <div>
              <label for="editor-phone" class="field-label">Phone Number</label>
              <input 
                class="text-field w-input" 
                type="tel" 
                id="editor-phone" 
                placeholder="+1-555-0123">
            </div>
          </div>
          
          <div class="form-button" style="margin-top: 20px;">
            <button type="submit" class="button-primary w-button" id="invite-editor-btn">
              CREATE EDITOR ACCOUNT
            </button>
          </div>
        </form>
        
        <!-- Success Box -->
        <div id="editor-success-box" class="success-box">
          <h3><span class="success-icon"></span>Editor Account Created Successfully!</h3>
          <p>Share these credentials with the Editor securely. They should change their password after first login.</p>
          
          <div class="credential-box">
            <div class="credential-label">Email Address</div>
            <div class="credential-value" id="created-editor-email"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-editor-email')">Copy</button>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Temporary Password</div>
            <div class="credential-value" id="created-editor-password"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-editor-password')">Copy</button>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Login URL</div>
            <div class="credential-value">https://memorio.ai/m-editor-5w8r/login.html</div>
            <button class="copy-btn" onclick="copyToClipboard('editor-login-url')">Copy</button>
          </div>
        </div>
        
        <!-- Error Box -->
        <div id="editor-error-box" class="error-box"></div>
      </div>
    </div>

    <!-- Invite QC Tab -->
    <div id="invite-qc-tab" class="tab-content">
      <div class="invite-section">
        <h2 class="section-title">Invite Quality Control User</h2>
        <p class="paragraph">Create a new <strong>Global QC Account</strong>. QC users review and approve memorial videos for <strong>all funeral homes</strong>, not tied to a specific organization.</p>
        
        <form id="invite-qc-form">
          <div class="form-row">
            <div>
              <label for="qc-email" class="field-label">Email Address*</label>
              <input 
                class="text-field w-input" 
                type="email" 
                id="qc-email" 
                placeholder="qc@memorio.ai" 
                required>
            </div>
            
            <div>
              <label for="qc-name" class="field-label">Full Name*</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="qc-name" 
                placeholder="Jane Quality" 
                required>
            </div>
          </div>
          
          <div class="form-row">
            <div>
              <label for="qc-phone" class="field-label">Phone Number</label>
              <input 
                class="text-field w-input" 
                type="tel" 
                id="qc-phone" 
                placeholder="+1-555-0123">
            </div>
            
            <div style="display: flex; align-items: flex-end;">
              <div class="info-box" style="background-color: var(--bg-secondary); padding: 15px; border: 2px solid var(--border-primary); border-radius: 12px; font-size: 14px; color: var(--text-primary);">
                <strong>ðŸŒ Global Access:</strong> This QC user will have access to review videos from all funeral homes.
              </div>
            </div>
          </div>
          
          <div class="form-button" style="margin-top: 20px;">
            <button type="submit" class="button-primary w-button" id="invite-qc-btn">
              CREATE QC ACCOUNT
            </button>
          </div>
        </form>
        
        <!-- Success Box -->
        <div id="qc-success-box" class="success-box">
          <h3><span class="success-icon"></span>QC Account Created Successfully!</h3>
          <p>Share these credentials with the QC user securely. They should change their password after first login.</p>
          <p style="color: #436481; font-weight: 600; margin-top: 10px;">
            ðŸŒ This QC user has <strong>global access</strong> to review videos from all funeral homes.
          </p>
          
          <div class="credential-box">
            <div class="credential-label">Email Address</div>
            <div class="credential-value" id="created-qc-email"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-qc-email')">Copy</button>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Temporary Password</div>
            <div class="credential-value" id="created-qc-password"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-qc-password')">Copy</button>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Login URL</div>
            <div class="credential-value">https://memorio.ai/m-qc-4h7k/login.html</div>
            <button class="copy-btn" onclick="copyToClipboard('qc-login-url')">Copy</button>
          </div>
        </div>
          
          <div class="credential-box">
            <div class="credential-label">Login URL</div>
            <div class="credential-value">https://memorio.ai/m-qc-4h7k/login.html</div>
            <button class="copy-btn" onclick="copyToClipboard('qc-login-url')">Copy</button>
          </div>
        </div>
        
        <!-- Error Box -->
        <div id="qc-error-box" class="error-box"></div>
      </div>
    </div>

    <!-- Assign Editor Tab -->
    <div id="assign-editor-tab" class="tab-content">
      <div class="invite-section">
        <h2 class="section-title">Assign Editor to Case</h2>
        <p class="paragraph">Assign a Video Editor to work on a specific case. The editor will be able to download photos and create a memorial tribute video.</p>
        
        <form id="assign-editor-form">
          <div class="form-row">
            <div>
              <label for="assign-case-id" class="field-label">Case ID*</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="assign-case-id" 
                placeholder="00000000-0000-0000-0000-000000000001" 
                required>
            </div>
            
            <div>
              <label for="assign-editor-id" class="field-label">Editor Email*</label>
              <select class="text-field w-input" id="assign-editor-id" required>
                <option value="">Select an Editor...</option>
              </select>
            </div>
          </div>
          
          <div class="form-button" style="margin-top: 20px;">
            <button type="submit" class="button-primary w-button" id="assign-editor-btn">
              ASSIGN EDITOR TO CASE
            </button>
          </div>
        </form>
        
        <!-- Success Box -->
        <div id="assign-success-box" class="success-box">
          <h3><span class="success-icon"></span>Editor Assigned Successfully!</h3>
          <p>The editor has been assigned to the case and can now access the photos to create a memorial tribute video.</p>
        </div>
        
        <!-- Error Box -->
        <div id="assign-error-box" class="error-box"></div>
      </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmation-modal" class="confirmation-modal">
    <div class="confirmation-content">
      <div class="confirmation-icon">âš ï¸</div>
      <h2 class="confirmation-title" id="confirmation-title">Confirm Deletion</h2>
      <p class="confirmation-message" id="confirmation-message">Are you sure you want to delete this organization?</p>
      <div class="confirmation-warning" id="confirmation-warning">
        This action cannot be undone and will permanently remove all related data.
      </div>
      <div class="confirmation-buttons">
        <button class="btn-cancel" onclick="closeConfirmationModal()">Cancel</button>
        <button class="btn-confirm-delete" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Custom Success Modal -->
  <div id="success-modal" class="success-modal">
    <div class="success-content">
      <h2 class="success-title"><span class="success-icon"></span>Success!</h2>
      <p class="success-message" id="success-message">The organization has been successfully deleted.</p>
      <button class="btn-success-ok" onclick="closeSuccessModal()">OK</button>
    </div>
  </div>

  <!-- Organization Details Modal -->
  <div id="org-details-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-org-name">Organization Details</h2>
        <button class="modal-close" onclick="closeOrgModal()">&times;</button>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">
          <span class="modal-icon modal-icon-org"></span>
          Organization Information
        </h3>
        <div class="modal-details">
          <div class="modal-detail-item">
            <span class="modal-detail-label">Organization ID:</span>
            <span class="modal-detail-value" id="modal-org-id">-</span>
            <button class="copy-btn" onclick="copyToClipboard('modal-org-id')" style="margin-left: 10px;">Copy</button>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Name:</span>
            <span class="modal-detail-value" id="modal-org-name-value">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Contact Email:</span>
            <span class="modal-detail-value" id="modal-org-email">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Contact Phone:</span>
            <span class="modal-detail-value" id="modal-org-phone">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Region:</span>
            <span class="modal-detail-value" id="modal-org-region">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Created:</span>
            <span class="modal-detail-value" id="modal-org-created">-</span>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">
          <span class="modal-icon modal-icon-users"></span>
          Director Accounts
        </h3>
        <div class="modal-details">
          <div class="modal-detail-item">
            <span class="modal-detail-label">Total Directors:</span>
            <span class="modal-detail-value" id="modal-director-count">-</span>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">
          <span class="modal-icon">ðŸ“Š</span>
          Case Analytics
        </h3>
        <div class="modal-details">
          <div class="modal-detail-item">
            <span class="modal-detail-label">Active Cases:</span>
            <span class="modal-detail-value" id="modal-active-cases">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Cases (Last 30 Days):</span>
            <span class="modal-detail-value" id="modal-recent-cases">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">On-Time Cases:</span>
            <span class="modal-detail-value" id="modal-on-time-cases">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Breach Cases:</span>
            <span class="modal-detail-value" id="modal-breach-cases">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">SLA Performance:</span>
            <span class="modal-detail-value" id="modal-sla-percentage">-</span>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <button class="button-primary w-button" onclick="viewOrgCases()" style="width: 100%;">
            ðŸ“‹ View All Cases for This Organization
          </button>
        </div>
      </div>
      
      <div class="modal-section" id="director-credentials-section" style="display: none;">
        <h3 class="modal-section-title">
          <span class="modal-icon modal-icon-key"></span>
          Director Login Credentials
          <button id="reveal-director-credentials-btn" class="reveal-btn" onclick="revealDirectorCredentials()">Reveal</button>
        </h3>
        <div class="modal-details" id="director-credentials" style="display: none;">
          <div class="modal-detail-item">
            <span class="modal-detail-label">Director Email:</span>
            <span class="modal-detail-value" id="modal-director-email">-</span>
            <button class="copy-btn" onclick="copyToClipboard('modal-director-email')" style="margin-left: 10px;">Copy</button>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Director Password:</span>
            <span class="modal-detail-value" id="modal-director-password">-</span>
            <button class="copy-btn" onclick="copyToClipboard('modal-director-password')" style="margin-left: 10px;">Copy</button>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Login URL:</span>
            <span class="modal-detail-value" id="modal-director-login-url">https://memorio.ai/m-director-9m6z/login.html</span>
            <button class="copy-btn" onclick="copyToClipboard('modal-director-login-url')" style="margin-left: 10px;">Copy</button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="modal-btn modal-btn-danger" onclick="deleteOrgFromModal()">Delete Organization</button>
        <button class="modal-btn modal-btn-secondary" onclick="closeOrgModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Account Details Modal -->
  <div id="account-details-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-account-title">Account Details</h2>
        <button class="modal-close" onclick="closeAccountDetailsModal()">&times;</button>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">
          <span class="modal-icon">ðŸ‘¤</span>
          User Information
        </h3>
        <div class="modal-details">
          <div class="modal-detail-item">
            <span class="modal-detail-label">Name:</span>
            <span class="modal-detail-value" id="modal-account-name">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Email:</span>
            <span class="modal-detail-value" id="modal-account-email">-</span>
            <button class="copy-btn" onclick="copyToClipboard('modal-account-email')" style="margin-left: 10px;">Copy</button>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Role:</span>
            <span class="modal-detail-value" id="modal-account-role">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Status:</span>
            <span class="modal-detail-value" id="modal-account-status">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Organization:</span>
            <span class="modal-detail-value" id="modal-account-org">-</span>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">
          <span class="modal-icon">ðŸ“…</span>
          Account Activity
        </h3>
        <div class="modal-details">
          <div class="modal-detail-item">
            <span class="modal-detail-label">Created:</span>
            <span class="modal-detail-value" id="modal-account-created">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">Last Login:</span>
            <span class="modal-detail-value" id="modal-account-last-login">-</span>
          </div>
          <div class="modal-detail-item">
            <span class="modal-detail-label">User ID:</span>
            <span class="modal-detail-value" id="modal-account-id" style="font-family: monospace; font-size: 12px;">-</span>
            <button class="copy-btn" onclick="copyToClipboard('modal-account-id')" style="margin-left: 10px;">Copy</button>
          </div>
        </div>
      </div>
      
      <div class="modal-section" style="border-top: 1px solid var(--border-primary); padding-top: 20px;">
        <div style="background-color: #fff3cd; padding: 16px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 16px;">
          <p style="margin: 0; color: #856404; font-size: 14px;">
            <strong>âš ï¸ Note:</strong> Temporary passwords are only shown once during account creation for security reasons. 
            If the user has lost their password, they should use the "Forgot Password" feature on their login page.
          </p>
        </div>
        <div class="modal-detail-item" id="modal-login-url-container">
          <span class="modal-detail-label">Login URL:</span>
          <span class="modal-detail-value" id="modal-account-login-url">-</span>
          <button class="copy-btn" onclick="copyToClipboard('modal-account-login-url')" style="margin-left: 10px;">Copy</button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="modal-btn modal-btn-danger" id="modal-delete-account-btn">ðŸ—‘ï¸ Delete Account</button>
        <button class="modal-btn modal-btn-secondary" onclick="closeAccountDetailsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://gkabtvqwwuvigcdubwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrYWJ0dnF3d3V2aWdjZHVid3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDE5MjUsImV4cCI6MjA3NTQ3NzkyNX0.O1DfOR5FBm6r3Pg-tjEE5CkzRr3WlWqGU1xUYKrhtnU';
    
    const { createClient } = supabase;
    
    // Initialize Supabase client with proper session persistence
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,           // Automatically refresh token before expiry
        persistSession: true,              // Persist session to localStorage
        detectSessionInUrl: true,          // Detect OAuth sessions in URL
        storage: window.localStorage,      // Use localStorage for session persistence
        storageKey: 'memorio-admin-auth',  // Unique key per portal
      }
    });
    
    // Global auth state
    let isAuthenticated = false;
    let currentSession = null;
    
    // Set up automatic token refresh and session monitoring
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      console.log('ðŸ” Auth state changed:', event, session?.user?.email);
      
      // Update session state but DON'T redirect (let checkAuth handle redirects)
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        currentSession = session;
        isAuthenticated = !!session;
        console.log('âœ… Session updated/refreshed successfully');
      }
      
      if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
        isAuthenticated = false;
        currentSession = null;
        console.log('âš ï¸ User signed out');
        // Don't redirect here - it causes loops. Let checkAuth handle redirects.
      }
      
      if (event === 'TOKEN_REFRESHED') {
        console.log('ðŸ”„ Access token auto-refreshed - no action needed');
      }
    });
    
    // Enhanced auth check with proper session handling
    async function checkAuth() {
      console.log('=== ADMIN AUTHENTICATION CHECK ===');
      
      try {
        // Get session from localStorage (persisted)
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          console.error('Session error:', sessionError);
          throw new Error('Session retrieval failed');
        }
        
        if (!session) {
          console.error('No session found - redirecting to login');
          window.location.href = 'login.html';
          return false;
        }
        
        console.log('Session exists:', !!session);
        console.log('Admin Email:', session.user.email);
        console.log('JWT app_metadata:', session.user.app_metadata);
        
        // Store session globally
        currentSession = session;
        
        // Verify admin role from database
        const { data: userData, error } = await supabaseClient
          .from('users')
          .select('role')
          .eq('id', session.user.id)
          .single();
        
        console.log('Database user data:', userData);
        
        if (error || !userData || userData.role !== 'admin') {
          console.error('âŒ Not an admin or user not found');
          await supabaseClient.auth.signOut();
          window.location.href = 'login.html';
          return false;
        }
        
        // Check JWT role
        const jwtRole = session.user.app_metadata?.role;
        console.log('JWT Role from app_metadata:', jwtRole);
        
        if (!jwtRole || jwtRole !== 'admin') {
          console.warn('âš ï¸ WARNING: app_metadata role missing or incorrect in JWT!');
          console.warn('Expected: admin, Got:', jwtRole);
          console.warn('Refreshing session to update JWT...');
          
          // Refresh session to get updated JWT
          const { data: refreshData } = await supabaseClient.auth.refreshSession();
          if (refreshData?.session) {
            currentSession = refreshData.session;
            console.log('âœ… Session refreshed, JWT updated');
          }
        } else {
          console.log('âœ… JWT app_metadata role is correct');
        }
        
        isAuthenticated = true;
        console.log('âœ… Admin authentication successful');
        console.log('=== END AUTH CHECK ===\n');
        return true;
        
      } catch (error) {
        console.error('âŒ Auth check failed:', error);
        window.location.href = 'login.html';
        return false;
      }
    }
    
    // Initialize app - authenticate FIRST, then load data
    async function initializeApp() {
      const authSuccess = await checkAuth();
      
      if (authSuccess) {
        // Only load data after successful authentication
        console.log('ðŸš€ Loading organizations and notifications...');
        await loadUnassignedCasesNotifications();
        await loadNotifications(); // Load notification dropdown data
        await loadOrganizations();
        console.log('âœ… App initialization complete');
      }
    }
    
    // Run initialization on page load
    initializeApp();
    
    // Profile dropdown functions
    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profile-dropdown');
      const arrow = document.getElementById('profile-dropdown-arrow');
      dropdown.classList.toggle('show');
      
      // Rotate arrow
      if (dropdown.classList.contains('show')) {
        arrow.style.transform = 'rotate(180deg)';
      } else {
        arrow.style.transform = 'rotate(0deg)';
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('profile-dropdown');
      const profileWrapper = e.target.closest('.topbar-profile-wrapper');
      
      if (!profileWrapper && dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
        document.getElementById('profile-dropdown-arrow').style.transform = 'rotate(0deg)';
      }
    });
    
    // Logout handler
    async function handleLogout() {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    }
    
    // Make functions global
    window.toggleProfileDropdown = toggleProfileDropdown;
    window.handleLogout = handleLogout;
    
    // Helper function to get valid session (with auto-refresh if needed)
    async function getValidSession() {
      // Check if we have a session
      if (!currentSession) {
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentSession = session;
      }
      
      // If session is close to expiry, refresh it
      if (currentSession) {
        const expiresAt = currentSession.expires_at;
        const now = Math.floor(Date.now() / 1000);
        const timeUntilExpiry = expiresAt - now;
        
        // Refresh if less than 5 minutes until expiry
        if (timeUntilExpiry < 300) {
          console.log('ðŸ”„ Session expiring soon, refreshing...');
          const { data: refreshData, error } = await supabaseClient.auth.refreshSession();
          if (!error && refreshData.session) {
            currentSession = refreshData.session;
            console.log('âœ… Session refreshed successfully');
          }
        }
      }
      
      if (!currentSession) {
        throw new Error('No valid session - please log in again');
      }
      
      return currentSession;
    }
    
    // Handle invite form submission
    document.getElementById('invite-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('director-email').value;
      const name = document.getElementById('director-name').value;
      const phone = document.getElementById('director-phone').value;
      const orgId = document.getElementById('org-id').value;
      
      const inviteBtn = document.getElementById('invite-btn');
      const successBox = document.getElementById('success-box');
      const errorBox = document.getElementById('error-box');
      const inviteSection = document.querySelector('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      inviteSection.classList.add('loading');
      inviteBtn.disabled = true;
      inviteBtn.textContent = 'CREATING ACCOUNT...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        // Call invite-director Edge Function
        const response = await fetch(`${SUPABASE_URL}/functions/v1/invite-director`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            email,
            name,
            org_id: orgId,
            phone: phone || undefined
          })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create director account');
        }
        
        // Display success with credentials
        document.getElementById('created-email').textContent = result.data.email;
        document.getElementById('created-password').textContent = result.data.temp_password;
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('invite-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        inviteSection.classList.remove('loading');
        inviteBtn.disabled = false;
        inviteBtn.textContent = 'CREATE DIRECTOR ACCOUNT';
      }
    });
    
    // Handle invite editor form submission
    document.getElementById('invite-editor-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('editor-email').value;
      const name = document.getElementById('editor-name').value;
      const phone = document.getElementById('editor-phone').value;
      
      const inviteBtn = document.getElementById('invite-editor-btn');
      const successBox = document.getElementById('editor-success-box');
      const errorBox = document.getElementById('editor-error-box');
      const section = e.target.closest('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      section.classList.add('loading');
      inviteBtn.disabled = true;
      inviteBtn.textContent = 'CREATING EDITOR ACCOUNT...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/invite-editor`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ email, name, phone })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to create editor account');
        }
        
        // Display success with credentials
        document.getElementById('created-editor-email').textContent = result.data.email;
        document.getElementById('created-editor-password').textContent = result.data.temp_password;
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('invite-editor-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        inviteBtn.disabled = false;
        inviteBtn.textContent = 'CREATE EDITOR ACCOUNT';
      }
    });
    
    // Handle invite QC form submission
    document.getElementById('invite-qc-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('qc-email').value;
      const name = document.getElementById('qc-name').value;
      const phone = document.getElementById('qc-phone').value;
      
      const inviteBtn = document.getElementById('invite-qc-btn');
      const successBox = document.getElementById('qc-success-box');
      const errorBox = document.getElementById('qc-error-box');
      const section = e.target.closest('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      section.classList.add('loading');
      inviteBtn.disabled = true;
      inviteBtn.textContent = 'CREATING GLOBAL QC ACCOUNT...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/invite-qc`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ email, name, phone }) // No org_id - QC is global
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to create QC account');
        }
        
        // Display success with credentials
        document.getElementById('created-qc-email').textContent = result.data.email;
        document.getElementById('created-qc-password').textContent = result.data.temp_password;
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('invite-qc-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        inviteBtn.disabled = false;
        inviteBtn.textContent = 'CREATE QC ACCOUNT';
      }
    });
    
    // Handle assign editor form submission
    document.getElementById('assign-editor-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const caseId = document.getElementById('assign-case-id').value;
      const editorEmail = document.getElementById('assign-editor-id').value;
      
      const assignBtn = document.getElementById('assign-editor-btn');
      const successBox = document.getElementById('assign-success-box');
      const errorBox = document.getElementById('assign-error-box');
      const section = e.target.closest('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      section.classList.add('loading');
      assignBtn.disabled = true;
      assignBtn.textContent = 'ASSIGNING EDITOR...';
      
      try {
        // Get editor user ID from email
        const { data: editorData, error: editorError } = await supabaseClient
          .from('admin_users_view')  // Use view to bypass RLS
          .select('id')
          .eq('email', editorEmail)
          .eq('role', 'editor')
          .single();
        
        if (editorError || !editorData) {
          throw new Error('Editor not found');
        }
        
        // Get current admin user ID for assigned_by field
        const { data: { session } } = await supabaseClient.auth.getSession();
        const adminUserId = session.user.id;
        
        // Create editor assignment
        const { error: assignError } = await supabaseClient
          .from('editor_assignments')
          .insert({
            case_id: caseId,
            editor_user_id: editorData.id,
            assigned_by: adminUserId,
            assigned_at: new Date().toISOString()
          });
        
        if (assignError) {
          throw new Error(`Failed to assign editor: ${assignError.message}`);
        }
        
        // Update case status to 'in_production' when editor is assigned
        const { error: statusError } = await supabaseClient
          .from('cases')
          .update({ 
            status: 'in_production',
            updated_at: new Date().toISOString()
          })
          .eq('id', caseId);
        
        if (statusError) {
          console.warn('âš ï¸ Failed to update case status:', statusError);
          // Don't throw - assignment was successful, just log the warning
        } else {
          console.log('âœ… Case status updated to in_production');
        }
        
        // Display success
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('assign-editor-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        assignBtn.disabled = false;
        assignBtn.textContent = 'ASSIGN EDITOR TO CASE';
      }
    });
    
    // Load editors for assignment dropdown
    async function loadEditors() {
      try {
        const { data: editors, error } = await supabaseClient
          .from('admin_users_view')  // Use view to bypass RLS
          .select('email, metadata')
          .eq('role', 'editor')
          .in('status', ['active', 'invited']); // Include both active and invited editors
        
        if (error) throw error;
        
        const select = document.getElementById('assign-editor-id');
        select.innerHTML = '<option value="">Select an Editor...</option>';
        
        editors.forEach(editor => {
          const option = document.createElement('option');
          option.value = editor.email;
          option.textContent = `${editor.metadata?.name || editor.email}`;
          select.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading editors:', error);
      }
    }
    
    // Load editors when assign editor tab is opened
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all sidebar nav items
      document.querySelectorAll('.sidebar-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Remove active class from all old tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Update topbar title
      const titles = {
        'all-cases': 'All Cases',
        'manage-accounts': 'Manage Accounts',
        'organizations': 'Organizations',
        'invite-director': 'Invite Director',
        'invite-editor': 'Invite Editor',
        'invite-qc': 'Invite QC User',
        'assign-editor': 'Assign Editor'
      };
      document.getElementById('topbar-page-title').textContent = titles[tabName] || 'Dashboard';
      
      // Add active class to clicked sidebar item (if triggered by click)
      if (event && event.target) {
        const clickedItem = event.target.closest('.sidebar-nav-item');
        if (clickedItem) {
          clickedItem.classList.add('active');
        } else {
          // If event target is an old tab button
          event.target.classList.add('active');
        }
      } else {
        // Fallback: find and activate the matching sidebar item by onclick attribute
        document.querySelectorAll('.sidebar-nav-item').forEach(item => {
          const onclick = item.getAttribute('onclick');
          if (onclick && onclick.includes(`'${tabName}'`)) {
            item.classList.add('active');
          }
        });
      }
      
      // Load data based on tab
      if (tabName === 'organizations') {
        loadUnassignedCasesNotifications();
        loadOrganizations();
      } else if (tabName === 'assign-editor') {
        loadEditors();
      } else if (tabName === 'invite-qc') {
        loadQCOrgDropdown();
      } else if (tabName === 'all-cases') {
        loadAllCases();
      } else if (tabName === 'manage-accounts') {
        loadManageAccounts();
      }
    }
    
    // Load organizations for QC dropdown
    async function loadQCOrgDropdown() {
      const qcOrgSelect = document.getElementById('qc-org');
      
      try {
        const { data: orgs, error } = await supabaseClient
          .from('organizations')
          .select('id, name')
          .order('name');
        
        if (error) throw error;
        
        qcOrgSelect.innerHTML = '<option value="">Select Funeral Home...</option>';
        orgs.forEach(org => {
          const option = document.createElement('option');
          option.value = org.id;
          option.textContent = org.name;
          qcOrgSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading organizations for QC dropdown:', error);
      }
    }
    
    // Make switchTab global
    window.switchTab = switchTab;
    
    // Handle create organization form submission
    document.getElementById('create-org-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('org-name').value;
      const email = document.getElementById('org-email').value;
      const phone = document.getElementById('org-phone').value;
      const region = document.getElementById('org-region').value;
      
      const createBtn = document.getElementById('create-org-btn');
      const successBox = document.getElementById('org-success-box');
      const errorBox = document.getElementById('org-error-box');
      const section = e.target.closest('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      section.classList.add('loading');
      createBtn.disabled = true;
      createBtn.textContent = 'CREATING ORGANIZATION...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        console.log('ðŸ”„ Ensuring valid session before organization creation...');
        const session = await getValidSession();
        
        // Verify the session has admin role in app_metadata
        const jwtRole = session?.user?.app_metadata?.role;
        
        if (!jwtRole || jwtRole !== 'admin') {
          console.error('âŒ JWT still missing app_metadata.role:', session?.user);
          throw new Error('Your account does not have admin privileges. Please contact support.');
        }
        
        console.log('âœ… JWT verified with app_metadata.role =', jwtRole);
        
        // Small delay to ensure JWT propagation (prevents race condition)
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Insert organization into database
        const { data, error } = await supabaseClient
          .from('organizations')
          .insert({
            name: name,
            contact_email: email,
            contact_phone: phone || null,
            region: region || null,
            status: 'active'
          })
          .select()
          .single();
        
        if (error) {
          throw new Error(error.message);
        }
        
        // Display success with organization ID
        document.getElementById('created-org-name').textContent = data.name;
        document.getElementById('created-org-id').textContent = data.id;
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('create-org-form').reset();
        
        // Reload organizations list
        loadOrganizations();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        createBtn.disabled = false;
        createBtn.textContent = 'CREATE ORGANIZATION';
      }
    });
    
    // Load unassigned cases notifications
    async function loadUnassignedCasesNotifications() {
      try {
        const { data: notifications, error } = await supabaseClient
          .from('notifications')
          .select('case_id, created_at')
          .eq('event_type', 'no_editors_available')
          .eq('status', 'pending')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading notifications:', error);
          return;
        }
        
        const count = notifications?.length || 0;
        
        // Update badge on "All Cases" nav link
        const navLink = document.getElementById('allCasesNavLink');
        if (navLink) {
          navLink.setAttribute('data-count', count);
        }
        
        // Show/hide alert box
        const alertBox = document.getElementById('unassigned-cases-alert');
        const countElement = document.getElementById('unassigned-count');
        const listElement = document.getElementById('unassigned-cases-list');
        
        if (count === 0 || !notifications) {
          alertBox.style.display = 'none';
          return;
        }
        
        alertBox.style.display = 'block';
        countElement.textContent = count;
        
        // Load case details for each notification
        const caseIds = notifications.map(n => n.case_id);
        const { data: cases, error: casesError } = await supabaseClient
          .from('cases')
          .select('id, deceased_name, created_at, org_id, organizations(name)')
          .in('id', caseIds);
        
        if (casesError) {
          console.error('Error loading case details:', casesError);
          listElement.innerHTML = '<p style="color: #666;">Unable to load case details.</p>';
          return;
        }
        
        // Display case list
        listElement.innerHTML = cases.map(c => `
          <div style="padding: 12px; background: white; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #ffc107;">
            <strong>${c.deceased_name}</strong><br>
            <small style="color: #666;">
              ${c.organizations?.name || 'Unknown Org'} â€¢ 
              Submitted ${new Date(c.created_at).toLocaleDateString()}
            </small>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error in loadUnassignedCasesNotifications:', error);
      }
    }
    
    // ============================================================================
    // NOTIFICATION DROPDOWN SYSTEM
    // ============================================================================
    
    let allNotifications = [];
    
    // Toggle notification dropdown
    function toggleNotifications() {
      const dropdown = document.getElementById('notificationDropdown');
      const isActive = dropdown.classList.contains('active');
      
      if (!isActive) {
        loadNotifications();
        dropdown.classList.add('active');
      } else {
        dropdown.classList.remove('active');
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('notificationDropdown');
      const btn = document.getElementById('notificationBtn');
      
      if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });
    
    // Load all notifications
    async function loadNotifications() {
      try {
        // Get unassigned cases notifications
        const { data: notifications, error } = await supabaseClient
          .from('notifications')
          .select(`
            id,
            case_id,
            event_type,
            status,
            created_at,
            cases (
              id,
              deceased_name,
              organizations (
                name
              )
            )
          `)
          .eq('event_type', 'no_editors_available')
          .in('status', ['pending', 'sent'])
          .order('created_at', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        allNotifications = notifications || [];
        renderNotifications();
        updateNotificationBadge();
        
      } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notificationList').innerHTML = `
          <div class="notification-empty">
            <p>Error loading notifications</p>
          </div>
        `;
      }
    }
    
    // Render notifications in dropdown
    function renderNotifications() {
      const listEl = document.getElementById('notificationList');
      
      if (!allNotifications || allNotifications.length === 0) {
        listEl.innerHTML = `
          <div class="notification-empty">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
            <p>No notifications</p>
          </div>
        `;
        return;
      }
      
      listEl.innerHTML = allNotifications.map(notif => {
        const isUnread = notif.status === 'pending';
        const caseName = notif.cases?.deceased_name || 'Unknown Case';
        const orgName = notif.cases?.organizations?.name || 'Unknown Org';
        const timeAgo = getTimeAgo(new Date(notif.created_at));
        
        return `
          <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="handleNotificationClick('${notif.id}', '${notif.case_id}')">
            <div class="notification-icon error">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
            </div>
            <div class="notification-content">
              <div class="notification-title">No Editors Available</div>
              <div class="notification-text">
                Case <strong>${caseName}</strong> from ${orgName} needs an editor assignment
              </div>
              <div class="notification-time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Update notification badge count
    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      const unreadCount = allNotifications.filter(n => n.status === 'pending').length;
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    // Handle notification click
    async function handleNotificationClick(notificationId, caseId) {
      try {
        // Mark notification as read
        await supabaseClient
          .from('notifications')
          .update({ status: 'sent' })
          .eq('id', notificationId);
        
        // Update local state
        const notif = allNotifications.find(n => n.id === notificationId);
        if (notif) notif.status = 'sent';
        
        renderNotifications();
        updateNotificationBadge();
        
        // Navigate to case detail
        window.location.href = `case-detail.html?id=${caseId}`;
        
      } catch (error) {
        console.error('Error handling notification click:', error);
      }
    }
    
    // Mark all as read
    async function markAllAsRead() {
      try {
        const pendingIds = allNotifications
          .filter(n => n.status === 'pending')
          .map(n => n.id);
        
        if (pendingIds.length === 0) return;
        
        await supabaseClient
          .from('notifications')
          .update({ status: 'sent' })
          .in('id', pendingIds);
        
        // Update local state
        allNotifications.forEach(n => {
          if (n.status === 'pending') n.status = 'sent';
        });
        
        renderNotifications();
        updateNotificationBadge();
        
      } catch (error) {
        console.error('Error marking all as read:', error);
      }
    }
    
    // Get time ago string
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
      };
      
      for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
          return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
        }
      }
      
      return 'Just now';
    }
    
    // Make functions global
    window.toggleNotifications = toggleNotifications;
    window.markAllAsRead = markAllAsRead;
    window.handleNotificationClick = handleNotificationClick;
    
    // ============================================================================
    // DARK MODE TOGGLE SYSTEM
    // ============================================================================
    
    // Initialize theme from localStorage or default to light
    function initializeTheme() {
      const savedTheme = localStorage.getItem('memorio-admin-theme') || 'light';
      applyTheme(savedTheme);
    }
    
    // Apply theme to document
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      
      // Update icon visibility
      const sunIcon = document.getElementById('sunIcon');
      const moonIcon = document.getElementById('moonIcon');
      
      if (theme === 'dark') {
        sunIcon.style.display = 'block';
        moonIcon.style.display = 'none';
      } else {
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'block';
      }
      
      // Save to localStorage
      localStorage.setItem('memorio-admin-theme', theme);
      
      console.log(`ðŸŽ¨ Theme switched to: ${theme}`);
    }
    
    // Toggle theme
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      applyTheme(newTheme);
    }
    
    // Make toggle function global
    window.toggleTheme = toggleTheme;
    
    // Initialize theme on page load
    initializeTheme();
    
    // ============================================================================
    // END DARK MODE TOGGLE SYSTEM
    // ============================================================================
    
    // Auto-refresh notifications every 30 seconds
    setInterval(() => {
      const dropdown = document.getElementById('notificationDropdown');
      if (dropdown && dropdown.classList.contains('active')) {
        loadNotifications();
      } else {
        // Just update badge count without opening dropdown
        loadNotifications();
      }
    }, 30000);
    
    // ============================================================================
    // END NOTIFICATION DROPDOWN SYSTEM
    // ============================================================================
    
    // Load organizations list
    async function loadOrganizations() {
      const orgsList = document.getElementById('organizations-list');
      const errorBox = document.getElementById('org-list-error-box');
      
      errorBox.style.display = 'none';
      orgsList.innerHTML = '<p class="paragraph">Loading organizations...</p>';
      
      try {
        const { data: orgs, error } = await supabaseClient
          .from('organizations')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!orgs || orgs.length === 0) {
          orgsList.innerHTML = '<p class="paragraph">No organizations found. Create your first one above!</p>';
          return;
        }
        
        orgsList.innerHTML = orgs.map(org => `
          <div class="org-card" onclick="openOrgModal('${org.id}')" style="cursor: pointer;">
            <div class="org-card-name">${org.name}</div>
            <div class="org-card-detail">ðŸ“§ ${org.contact_email}</div>
            ${org.contact_phone ? `<div class="org-card-detail">ðŸ“ž ${org.contact_phone}</div>` : ''}
            ${org.region ? `<div class="org-card-detail">ðŸ“ ${org.region}</div>` : ''}
            <div class="org-card-detail" style="margin-top: 10px;">Created: ${new Date(org.created_at).toLocaleDateString()}</div>
            <div class="org-card-id">
              <div class="credential-label">Organization ID (copy this when inviting Directors)</div>
              <div class="credential-value" id="org-${org.id}" style="margin-top: 5px;">${org.id}</div>
              <button class="copy-btn" onclick="event.stopPropagation(); copyOrgId('org-${org.id}')">Copy ID</button>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button class="btn-secondary" onclick="event.stopPropagation(); deleteOrganization('${org.id}', '${org.name}')" style="padding: 6px 12px; font-size: 12px;">
                Delete Organization
              </button>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        errorBox.textContent = `Error loading organizations: ${error.message}`;
        errorBox.style.display = 'block';
        orgsList.innerHTML = '';
      }
    }
    
    // Copy organization ID
    function copyOrgId(elementId) {
      const text = document.getElementById(elementId).textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      });
    }
    
    // Make copyOrgId global
    window.copyOrgId = copyOrgId;
    window.deleteOrganization = deleteOrganization;
    window.closeConfirmationModal = closeConfirmationModal;
    window.closeSuccessModal = closeSuccessModal;
    
    // Modal Control Functions
    function closeConfirmationModal() {
      document.getElementById('confirmation-modal').style.display = 'none';
    }
    
    function closeSuccessModal() {
      document.getElementById('success-modal').style.display = 'none';
    }
    
    function showConfirmationModal(title, message, warning, onConfirm) {
      document.getElementById('confirmation-title').textContent = title;
      document.getElementById('confirmation-message').textContent = message;
      document.getElementById('confirmation-warning').textContent = warning;
      
      // Set up confirm button
      const confirmBtn = document.getElementById('confirm-delete-btn');
      confirmBtn.onclick = () => {
        closeConfirmationModal();
        onConfirm();
      };
      
      document.getElementById('confirmation-modal').style.display = 'flex';
    }
    
    function showSuccessModal(message) {
      document.getElementById('success-message').textContent = message;
      document.getElementById('success-modal').style.display = 'flex';
    }
    
    // Delete Organization Function
    async function deleteOrganization(orgId, orgName) {
      // First, get count of users in this org
      let userCount = 0;
      try {
        const { count, error: countError } = await supabaseClient
          .from('admin_users_view')  // Use view to bypass RLS
          .select('*', { count: 'exact', head: true })
          .eq('org_id', orgId);
        
        if (!countError && count !== null) {
          userCount = count;
        }
        
        console.log(`Found ${userCount} user(s) in organization ${orgId}`);
      } catch (e) {
        console.warn('Could not get user count:', e);
      }
      
      showConfirmationModal(
        'Delete Organization',
        `Are you sure you want to delete the organization "${orgName}"?`,
        `This action cannot be undone and will permanently remove:\nâ€¢ Organization details\nâ€¢ ${userCount} user account${userCount !== 1 ? 's' : ''} (Directors, Families)\nâ€¢ All authentication credentials\nâ€¢ All associated cases\nâ€¢ All form submissions\nâ€¢ All uploaded assets\nâ€¢ All related data\n\nAll users will be immediately logged out and unable to log in.\n\nThis should only be done if the funeral home is leaving Memorio permanently.`,
        async () => {
          try {
            console.log(`Deleting organization: ${orgName} (${orgId})`);
            console.log(`This will cascade delete ${userCount} user(s)`);
            
            // Get the current session token
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              throw new Error('No active session');
            }
            
            // Call the Edge Function to delete organization and all auth users
            const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-organization`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
              },
              body: JSON.stringify({ orgId })
            });
            
            const result = await response.json();
            
            if (!response.ok || !result.success) {
              throw new Error(result.error || 'Failed to delete organization');
            }
            
            console.log('Organization deletion result:', result);
            console.log(`âœ… Deleted ${result.deleted_users_count} auth user(s)`);
            
            // Show detailed results
            if (result.deletion_results && result.deletion_results.length > 0) {
              const succeeded = result.deletion_results.filter(r => r.success);
              const failed = result.deletion_results.filter(r => !r.success);
              
              console.log(`âœ… Successfully deleted ${succeeded.length} user(s):`, succeeded.map(u => u.email));
              
              if (failed.length > 0) {
                console.error(`âŒ Failed to delete ${failed.length} user(s):`, failed);
                failed.forEach(f => {
                  console.error(`  - ${f.email}: ${f.error}`);
                });
              }
            }
            
            showSuccessModal(`Organization "${orgName}" and all ${result.deleted_users_count} associated user account(s) have been permanently deleted.\n\nAll authentication credentials have been removed. Users can no longer log in.`);
            
            // Reload the organizations list
            await loadOrganizations();
            
          } catch (error) {
            console.error('Error deleting organization:', error);
            showSuccessModal(`Failed to delete organization: ${error.message}`);
          }
        }
      );
    }
    
    // Toast notification functions
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Copy to clipboard function
    function copyToClipboard(elementId, buttonElement = null) {
      let text;
      if (elementId === 'login-url') {
        text = 'https://memorio.ai/m-director-9m6z/login.html';
      } else {
        const element = document.getElementById(elementId);
        if (!element) {
          console.error('Element not found:', elementId);
          showToast('Element not found', true);
          return;
        }
        text = element.textContent;
      }
      
      // Use the buttonElement parameter if provided, otherwise try to find the button
      const btn = buttonElement || (event && event.target) || null;
      
      navigator.clipboard.writeText(text).then(() => {
        console.log('Successfully copied to clipboard:', text);
        
        // Update button appearance
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          btn.style.backgroundColor = '#28a745';
          btn.style.color = 'white';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.backgroundColor = '';
            btn.style.color = '';
          }, 2000);
        }
        
        // Show success toast
        showToast('Copied to clipboard!');
        
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        console.error('Text that failed to copy:', text);
        // Show error toast
        showToast('Failed to copy to clipboard', true);
      });
    }
    
    // Make copy function global
    window.copyToClipboard = copyToClipboard;
    
    // Organization Details Modal Functions
    let currentOrgDetails = null;
    let directorCredentialsRevealed = false;
    
    async function openOrgModal(orgId) {
      const modal = document.getElementById('org-details-modal');
      modal.style.display = 'flex';
      
      // Reset credentials state
      directorCredentialsRevealed = false;
      document.getElementById('reveal-director-credentials-btn').textContent = 'Reveal';
      document.getElementById('director-credentials').style.display = 'none';
      document.getElementById('director-credentials-section').style.display = 'none';
      
      try {
        // Load organization details
        const { data: org, error: orgError } = await supabaseClient
          .from('organizations')
          .select('*')
          .eq('id', orgId)
          .single();
        
        if (orgError) throw orgError;
        
        // Load director users for this organization
        const { data: directors, error: directorsError } = await supabaseClient
          .from('admin_users_view')  // Use view to bypass RLS
          .select('*')
          .eq('org_id', orgId)
          .eq('role', 'director');
        
        if (directorsError) throw directorsError;
        
        // Load case analytics from the view
        const { data: analytics, error: analyticsError } = await supabaseClient
          .from('case_analytics')
          .select('*')
          .eq('org_id', orgId)
          .single();
        
        // Handle case where no analytics exist yet (new org with no cases)
        const analyticsData = analyticsError ? {
          active_cases: 0,
          cases_last_30_days: 0,
          on_time_cases: 0,
          breach_cases: 0,
          sla_percentage: 100
        } : analytics;
        
        // Populate modal with organization data
        document.getElementById('modal-org-name').textContent = org.name;
        document.getElementById('modal-org-name-value').textContent = org.name;
        document.getElementById('modal-org-id').textContent = org.id;
        document.getElementById('modal-org-email').textContent = org.contact_email || 'Not provided';
        document.getElementById('modal-org-phone').textContent = org.contact_phone || 'Not provided';
        document.getElementById('modal-org-region').textContent = org.region || 'Not provided';
        document.getElementById('modal-org-created').textContent = new Date(org.created_at).toLocaleDateString();
        
        // Populate director accounts data
        document.getElementById('modal-director-count').textContent = directors.length;
        
        // Populate case analytics
        document.getElementById('modal-active-cases').textContent = analyticsData.active_cases || 0;
        document.getElementById('modal-recent-cases').textContent = analyticsData.cases_last_30_days || 0;
        document.getElementById('modal-on-time-cases').textContent = analyticsData.on_time_cases || 0;
        document.getElementById('modal-breach-cases').textContent = analyticsData.breach_cases || 0;
        
        // Format SLA percentage with color
        const slaPercent = analyticsData.sla_percentage || 100;
        const slaColor = slaPercent >= 80 ? '#2e7d32' : slaPercent >= 60 ? '#d68000' : '#c62828';
        document.getElementById('modal-sla-percentage').innerHTML = 
          `<span style="color: ${slaColor}; font-weight: 600;">${slaPercent}%</span>`;
        
        // Store current org details for deletion
        currentOrgDetails = { id: orgId, name: org.name };
        
        // Show director credentials section if there are directors
        if (directors.length > 0) {
          document.getElementById('director-credentials-section').style.display = 'block';
          
          // For now, show the first director's credentials
          // In a real app, you might want to show all directors or let admin select
          const firstDirector = directors[0];
          document.getElementById('modal-director-email').textContent = firstDirector.email;
          
          // Show the actual password if available
          if (firstDirector.temp_password) {
            document.getElementById('modal-director-password').textContent = firstDirector.temp_password;
          } else {
            document.getElementById('modal-director-password').textContent = 'Password not available';
          }
        }
        
      } catch (error) {
        console.error('Error loading organization details:', error);
        alert('Error loading organization details. Please try again.');
        closeOrgModal();
      }
    }
    
    function closeOrgModal() {
      const modal = document.getElementById('org-details-modal');
      modal.style.display = 'none';
      currentOrgDetails = null;
      directorCredentialsRevealed = false;
    }
    
    function revealDirectorCredentials() {
      const credentialsDiv = document.getElementById('director-credentials');
      const revealBtn = document.getElementById('reveal-director-credentials-btn');
      
      if (directorCredentialsRevealed) {
        credentialsDiv.style.display = 'none';
        revealBtn.textContent = 'Reveal';
        directorCredentialsRevealed = false;
      } else {
        credentialsDiv.style.display = 'block';
        revealBtn.textContent = 'Hide';
        directorCredentialsRevealed = true;
      }
    }
    
    function deleteOrgFromModal() {
      if (currentOrgDetails) {
        deleteOrganization(currentOrgDetails.id, currentOrgDetails.name);
        closeOrgModal();
      }
    }
    
    // Close modal when clicking outside
    document.getElementById('org-details-modal').addEventListener('click', (e) => {
      if (e.target.id === 'org-details-modal') {
        closeOrgModal();
      }
    });
    
    // View organization cases
    function viewOrgCases() {
      if (!currentOrgDetails) return;
      
      // Redirect to cases page with org filter
      window.location.href = `cases.html?org=${currentOrgDetails.id}`;
    }
    
    // Make functions global
    window.openOrgModal = openOrgModal;
    window.closeOrgModal = closeOrgModal;
    window.revealDirectorCredentials = revealDirectorCredentials;
    window.deleteOrgFromModal = deleteOrgFromModal;
    window.viewOrgCases = viewOrgCases;
    
    // ============================================================================
    // ALL CASES TAB - KANBAN BOARD FUNCTIONALITY
    // ============================================================================
    
    let allCasesData = [];
    let filteredCasesData = [];
    
    async function loadAllCases() {
      try {
        console.log('ðŸ“Š Loading all cases for Kanban board...');
        
        // Query cases with org and user info from view
        const { data: cases, error: casesError} = await supabaseClient
          .from('admin_cases_view')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (casesError) {
          console.error('âŒ Error loading cases:', casesError);
          throw casesError;
        }
        
        console.log(`âœ… Loaded ${cases?.length || 0} cases`);
        
        // Get editor assignments
        const { data: assignments, error: assignmentsError } = await supabaseClient
          .from('admin_editor_assignments_view')
          .select('*')
          .is('unassigned_at', null);
        
        if (assignmentsError) {
          console.warn('âš ï¸ Error loading editor assignments:', assignmentsError);
        }
        
        // Get video submissions with QC reviewer info from view (bypasses RLS)
        const { data: submissions, error: submissionsError } = await supabaseClient
          .from('admin_video_submissions_view')
          .select('case_id, qc_status, qc_reviewer_id, qc_reviewer_email, qc_reviewer_metadata')
          .order('created_at', { ascending: false });
        
        if (submissionsError) {
          console.warn('âš ï¸ Error loading video submissions:', submissionsError);
        }
        
        // Combine data
        allCasesData = (cases || []).map(c => {
          // Find editor assignments for this case
          const caseAssignments = (assignments || []).filter(a => a.case_id === c.id);
          
          // Find video submission for this case
          const caseSubmissions = (submissions || []).filter(s => s.case_id === c.id);
          const latestSubmission = caseSubmissions[0]; // Already ordered by created_at DESC
          
          // Build qc_reviewer object structure to match what populateModalHeader expects
          const qcReviewer = latestSubmission && latestSubmission.qc_reviewer_id ? {
            email: latestSubmission.qc_reviewer_email,
            metadata: latestSubmission.qc_reviewer_metadata
          } : null;
          
          return {
            ...c,
            organizations: c.org_name ? { name: c.org_name } : null,
            editor_assignments: caseAssignments,
            video_submissions: latestSubmission ? [{
              ...latestSubmission,
              qc_reviewer: qcReviewer
            }] : []
          };
        });
        
        filteredCasesData = allCasesData;
        
        // Load filter options
        await loadCasesFilterOptions();
        
        // Render Kanban
        renderKanbanBoard();
        
      } catch (error) {
        console.error('âŒ Error loading cases:', error);
        showErrorInKanban('Failed to load cases. Please refresh the page.');
      }
    }
    
    async function loadCasesFilterOptions() {
      try {
        const { data: orgs, error } = await supabaseClient
          .from('organizations')
          .select('id, name')
          .order('name');
        
        if (!error && orgs) {
          const filterOrg = document.getElementById('filter-org');
          if (filterOrg) {
            filterOrg.innerHTML = '<option value="">All Organizations</option>';
            orgs.forEach(org => {
              const option = document.createElement('option');
              option.value = org.id;
              option.textContent = org.name;
              filterOrg.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('Error loading filter options:', error);
      }
    }
    
    function applyFilters() {
      const orgFilter = document.getElementById('filter-org').value;
      const statusFilter = document.getElementById('filter-status').value;
      const searchFilter = document.getElementById('filter-search').value.toLowerCase();
      
      filteredCasesData = allCasesData.filter(c => {
        if (orgFilter && c.org_id !== orgFilter) return false;
        if (statusFilter && c.status !== statusFilter) return false;
        if (searchFilter && !c.deceased_name.toLowerCase().includes(searchFilter)) return false;
        return true;
      });
      
      renderKanbanBoard();
    }
    
    function renderKanbanBoard() {
      const columns = {
        waiting: ['waiting_on_family', 'intake_in_progress'],
        progress: ['submitted', 'in_production'],
        review: ['awaiting_review', 'revision_requested'],
        complete: ['delivered', 'closed']
      };
      
      // Count cases per column
      const counts = {
        waiting: filteredCasesData.filter(c => columns.waiting.includes(c.status)).length,
        progress: filteredCasesData.filter(c => columns.progress.includes(c.status)).length,
        review: filteredCasesData.filter(c => columns.review.includes(c.status)).length,
        complete: filteredCasesData.filter(c => columns.complete.includes(c.status)).length
      };
      
      // Update counts
      document.getElementById('count-waiting').textContent = counts.waiting;
      document.getElementById('count-progress').textContent = counts.progress;
      document.getElementById('count-review').textContent = counts.review;
      document.getElementById('count-complete').textContent = counts.complete;
      
      // Render cards in each column
      Object.keys(columns).forEach(columnKey => {
        const columnEl = document.getElementById(`column-${columnKey}`);
        const cases = filteredCasesData.filter(c => columns[columnKey].includes(c.status));
        
        if (cases.length === 0) {
          columnEl.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: 20px; font-size: 14px;">No cases</div>';
        } else {
          columnEl.innerHTML = cases.map(c => createCaseCard(c)).join('');
        }
      });
    }
    
    function createCaseCard(caseData) {
      const orgName = caseData.organizations?.name || caseData.org_name || 'Unknown Org';
      // Show editor name from metadata, fallback to email
      const editorAssignment = caseData.editor_assignments?.[0];
      const editorName = editorAssignment?.editor_metadata?.name || editorAssignment?.editor_email || 'Unassigned';
      const createdDate = new Date(caseData.created_at).toLocaleDateString();
      
      // SLA badge (simplified)
      let slaBadge = '<span class="sla-badge green">On Time</span>';
      
      return `
        <div class="case-card" onclick="openCaseDetailModal('${caseData.id}')">
          <div class="case-card-header">
            <div class="case-card-name">${caseData.deceased_name}</div>
            ${slaBadge}
          </div>
          <div class="case-card-org">${orgName}</div>
          <div class="case-card-meta">
            <div class="case-card-meta-row">
              <span class="meta-icon">ðŸ‘¤</span>
              <span>${editorName}</span>
            </div>
            <div class="case-card-meta-row">
              <span class="meta-icon">ðŸ“…</span>
              <span>Created ${createdDate}</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function showErrorInKanban(message) {
      ['waiting', 'progress', 'review', 'complete'].forEach(col => {
        const el = document.getElementById(`column-${col}`);
        if (el) el.innerHTML = `<div style="color: var(--error); padding: 20px;">${message}</div>`;
      });
    }
    
    // Make filter function global
    window.applyFilters = applyFilters;
    
    // ============================================================================
    // MANAGE ACCOUNTS TAB FUNCTIONALITY
    // ============================================================================
    
    let allAccountsData = [];
    let filteredAccountsData = [];
    let currentAccountFilter = 'all';
    
    async function loadManageAccounts() {
      try {
        console.log('ðŸ‘¥ Loading manage accounts...');
        
        const { data: accounts, error } = await supabaseClient
          .from('admin_users_view')
          .select('*')
          .in('role', ['editor', 'qc'])
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('âŒ Error loading accounts:', error);
          throw error;
        }
        
        console.log(`âœ… Loaded ${accounts?.length || 0} accounts`);
        
        allAccountsData = accounts || [];
        filteredAccountsData = allAccountsData;
        
        // Update stats
        updateAccountsStats();
        
        // Render accounts
        renderAccountsGrid();
        
      } catch (error) {
        console.error('âŒ Error loading accounts:', error);
        document.getElementById('accountsGrid').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âŒ</div>
            <div class="empty-state-text">Failed to load accounts</div>
          </div>
        `;
      }
    }
    
    function updateAccountsStats() {
      const totalEditors = allAccountsData.filter(a => a.role === 'editor').length;
      const activeEditors = allAccountsData.filter(a => a.role === 'editor' && a.status === 'active').length;
      const totalQC = allAccountsData.filter(a => a.role === 'qc').length;
      const activeQC = allAccountsData.filter(a => a.role === 'qc' && a.status === 'active').length;
      
      document.getElementById('totalEditors').textContent = totalEditors;
      document.getElementById('activeEditors').textContent = activeEditors;
      document.getElementById('totalQC').textContent = totalQC;
      document.getElementById('activeQC').textContent = activeQC;
    }
    
    function filterManageAccounts(filterType) {
      currentAccountFilter = filterType;
      
      // Update button states
      document.querySelectorAll('#manage-accounts-tab .btn-secondary').forEach(btn => {
        btn.style.backgroundColor = 'transparent';
        btn.style.color = 'var(--text-primary)';
      });
      event.target.style.backgroundColor = 'var(--accent-primary)';
      event.target.style.color = 'var(--text-inverse)';
      
      // Filter data
      if (filterType === 'all') {
        filteredAccountsData = allAccountsData;
      } else if (filterType === 'editor') {
        filteredAccountsData = allAccountsData.filter(a => a.role === 'editor');
      } else if (filterType === 'qc') {
        filteredAccountsData = allAccountsData.filter(a => a.role === 'qc');
      } else if (filterType === 'active') {
        filteredAccountsData = allAccountsData.filter(a => a.status === 'active');
      }
      
      renderAccountsGrid();
    }
    
    function renderAccountsGrid() {
      const grid = document.getElementById('accountsGrid');
      
      if (filteredAccountsData.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ‘¥</div>
            <div class="empty-state-text">No accounts found</div>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = filteredAccountsData.map(account => createAccountCard(account)).join('');
    }
    
    function createAccountCard(account) {
      const name = account.metadata?.name || 'No name';
      
      const orgName = account.org_name || 'Global Access'; // Editors & QC have global access
      const createdDate = new Date(account.created_at).toLocaleDateString('en-US', { 
        timeZone: 'America/New_York',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      const lastLogin = account.last_login_at 
        ? new Date(account.last_login_at).toLocaleString('en-US', { 
            timeZone: 'America/New_York',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          })
        : 'Never';
      
      return `
        <div class="account-card" style="cursor: pointer;" onclick="openAccountDetailsModal('${account.id}')">
          <div class="account-card-header">
            <div>
              <div class="account-name">${name}</div>
              <div class="account-email">${account.email}</div>
            </div>
            <span class="account-role-badge ${account.role}">${account.role.toUpperCase()}</span>
          </div>
          
          <div style="margin: 12px 0;">
            <span class="account-status-badge ${account.status}">${account.status}</span>
          </div>
          
          <div class="account-info">
            <div class="account-info-row">
              <span class="account-info-label">Organization:</span>
              <span>${orgName}</span>
            </div>
            <div class="account-info-row">
              <span class="account-info-label">Created:</span>
              <span>${createdDate}</span>
            </div>
            <div class="account-info-row">
              <span class="account-info-label">Last Login:</span>
              <span>${lastLogin}</span>
            </div>
          </div>
          
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-primary);">
            <button 
              class="btn-danger" 
              style="width: 100%; padding: 10px; font-size: 14px;"
              onclick="event.stopPropagation(); openDeleteAccountModal('${account.id}', '${account.email.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', '${account.role}')">
              ðŸ—‘ï¸ Delete Account
            </button>
          </div>
        </div>
      `;
    }
    
    // ============================================================================
    // ACCOUNT DETAILS MODAL
    // ============================================================================
    
    async function openAccountDetailsModal(userId) {
      try {
        console.log('ðŸ‘¤ Opening account details for:', userId);
        
        // Find the account in our cached data
        const account = allAccountsData.find(a => a.id === userId);
        
        if (!account) {
          showToast('Account not found', true);
          return;
        }
        
        // Populate modal with account data
        document.getElementById('modal-account-title').textContent = `${account.role.toUpperCase()} Account Details`;
        document.getElementById('modal-account-name').textContent = account.metadata?.name || 'No name';
        document.getElementById('modal-account-email').textContent = account.email;
        document.getElementById('modal-account-role').innerHTML = `<span class="account-role-badge ${account.role}">${account.role.toUpperCase()}</span>`;
        document.getElementById('modal-account-status').innerHTML = `<span class="account-status-badge ${account.status}">${account.status}</span>`;
        document.getElementById('modal-account-org').textContent = account.org_name || 'Global Access';
        
        // Activity data
        document.getElementById('modal-account-created').textContent = new Date(account.created_at).toLocaleString('en-US', { 
          timeZone: 'America/New_York',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        
        document.getElementById('modal-account-last-login').textContent = account.last_login_at 
          ? new Date(account.last_login_at).toLocaleString('en-US', { 
              timeZone: 'America/New_York',
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            })
          : 'Never';
        
        document.getElementById('modal-account-id').textContent = account.id;
        
        // Set login URL based on role
        const loginUrls = {
          'editor': 'https://memorio.ai/m-editor-5w8r/login.html',
          'qc': 'https://memorio.ai/m-qc-4h7k/login.html'
        };
        document.getElementById('modal-account-login-url').textContent = loginUrls[account.role] || 'N/A';
        
        // Set up delete button
        const deleteBtn = document.getElementById('modal-delete-account-btn');
        deleteBtn.onclick = () => {
          closeAccountDetailsModal();
          openDeleteAccountModal(account.id, account.email, account.metadata?.name || 'No name', account.role);
        };
        
        // Show modal
        document.getElementById('account-details-modal').style.display = 'flex';
        
      } catch (error) {
        console.error('âŒ Error opening account details:', error);
        showToast('Error loading account details', true);
      }
    }
    
    function closeAccountDetailsModal() {
      document.getElementById('account-details-modal').style.display = 'none';
    }
    
    // ============================================================================
    // DELETE ACCOUNT FUNCTIONALITY
    // ============================================================================
    
    function openDeleteAccountModal(userId, email, name, role) {
      // Store the user info for deletion
      window.pendingAccountDelete = { userId, email, name, role };
      
      showConfirmationModal(
        `Delete ${role.toUpperCase()} Account?`,
        `Are you sure you want to permanently delete the account for:\n\nðŸ‘¤ ${name}\nðŸ“§ ${email}`,
        `âš ï¸ This action cannot be undone. This will:\nâ€¢ Remove the user from Supabase authentication\nâ€¢ Delete all user data from the database\nâ€¢ Revoke all access immediately`,
        () => confirmDeleteAccount()
      );
    }
    
    async function confirmDeleteAccount() {
      const { userId, email, name, role } = window.pendingAccountDelete;
      
      try {
        console.log(`ðŸ—‘ï¸ Deleting account: ${email} (${userId})`);
        
        // Show loading state
        showSuccessModal('â³ Deleting account...');
        
        // Call the delete-user edge function
        const { data, error } = await supabaseClient.functions.invoke('delete-user', {
          body: { user_id: userId }
        });
        
        if (error) {
          console.error('âŒ Error deleting account:', error);
          throw error;
        }
        
        console.log('âœ… Account deleted successfully:', data);
        
        // Show success message
        showSuccessModal(
          `âœ… Account Deleted\n\n` +
          `${name} (${email}) has been permanently deleted.\n\n` +
          `All authentication credentials have been removed.`
        );
        
        // Reload the accounts list
        await loadManageAccounts();
        
        // Clear the pending delete
        delete window.pendingAccountDelete;
        
      } catch (error) {
        console.error('âŒ Failed to delete account:', error);
        showSuccessModal(
          `âŒ Delete Failed\n\n` +
          `Failed to delete account: ${error.message || 'Unknown error'}\n\n` +
          `Please try again or contact support.`
        );
      }
    }
    
    // Make filter function global
    window.filterManageAccounts = filterManageAccounts;
    
    // ============================================================================
    // CASE DETAIL MODAL - COMPREHENSIVE VERSION
    // ============================================================================
    
    let currentCaseDetailId = null;
    let currentModalCaseData = null;
    
    async function openCaseDetailModal(caseId) {
      currentCaseDetailId = caseId;
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
      
      // Show modal immediately
      document.getElementById('case-detail-modal').classList.add('active');
      
      // Find case data from allCasesData
      const caseData = allCasesData.find(c => c.id === caseId);
      
      if (!caseData) {
        console.error('Case not found:', caseId);
        return;
      }
      
      currentModalCaseData = caseData;
      
      // Populate header with basic info
      populateModalHeader(caseData);
      
      // Load tab content
      await loadModalUploads(caseId);
      await loadModalTimeline(caseId);
      await loadModalAudit(caseId);
    }
    
    function populateModalHeader(caseData) {
      // Main header
      document.getElementById('case-modal-name').textContent = caseData.deceased_name;
      document.getElementById('case-modal-org').textContent = caseData.organizations?.name || caseData.org_name || 'Unknown Org';
      document.getElementById('case-modal-status').textContent = formatStatus(caseData.status);
      document.getElementById('case-modal-date').textContent = new Date(caseData.created_at).toLocaleDateString();
      
      // Meta grid in header
      document.getElementById('case-modal-org-name').textContent = caseData.organizations?.name || caseData.org_name || 'Unknown Org';
      
      // Show editor name from metadata, fallback to email
      const editorAssignment = caseData.editor_assignments?.[0];
      const editorName = editorAssignment?.editor_metadata?.name || editorAssignment?.editor_email || 'Unassigned';
      document.getElementById('case-modal-editor').textContent = editorName;
      
      // Show QC reviewer name from metadata, fallback to email
      const qcReviewerData = caseData.video_submissions?.[0]?.qc_reviewer;
      const qcReviewerName = qcReviewerData?.metadata?.name || qcReviewerData?.email || null;
      document.getElementById('case-modal-qc').textContent = qcReviewerName || 'Not assigned';
      
      document.getElementById('case-modal-family').textContent = caseData.family_email || 'Not assigned';
      
      // Overview tab
      document.getElementById('case-modal-id').textContent = caseData.id;
      document.getElementById('case-modal-status-full').textContent = formatStatus(caseData.status);
      document.getElementById('case-modal-created').textContent = new Date(caseData.created_at).toLocaleString();
      document.getElementById('case-modal-updated').textContent = new Date(caseData.updated_at).toLocaleString();
      document.getElementById('case-modal-org-id').textContent = caseData.org_id || '-';
    }
    
    async function loadModalUploads(caseId) {
      try {
        // Load assets
        const { data: assets, error: assetsError } = await supabaseClient
          .from('assets')
          .select('*')
          .eq('case_id', caseId)
          .order('uploaded_at', { ascending: false });
        
        if (assetsError) throw assetsError;
        
        // Load form data
        const { data: formData, error: formError } = await supabaseClient
          .from('forms')
          .select('*')
          .eq('case_id', caseId)
          .single();
        
        const uploadsContainer = document.getElementById('modal-uploads-content');
        let html = '';
        
        // Render assets
        if (assets && assets.length > 0) {
          html += '<h3 class="modal-form-data-title">Uploaded Photos</h3>';
          html += '<div class="modal-assets-grid">';
          assets.forEach(asset => {
            const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/case-assets/${asset.file_key}`;
            html += `
              <div class="modal-asset-item" onclick="window.open('${imageUrl}', '_blank')">
                <img src="${imageUrl}" alt="Asset" loading="lazy">
              </div>
            `;
          });
          html += '</div>';
        } else {
          html += '<div class="modal-empty-state">No photos uploaded yet</div>';
        }
        
        // Render form data
        if (formData && formData.submitted_json) {
          const data = formData.submitted_json;
          html += '<h3 class="modal-form-data-title">Intake Form Data</h3>';
          html += '<div class="modal-form-data-grid">';
          
          Object.entries(data).forEach(([key, value]) => {
            if (typeof value === 'object') {
              value = JSON.stringify(value);
            }
            html += `
              <div class="modal-form-data-item">
                <span class="modal-form-data-label">${formatFieldName(key)}</span>
                <span class="modal-form-data-value">${value || 'N/A'}</span>
              </div>
            `;
          });
          
          html += '</div>';
        } else {
          html += '<div class="modal-empty-state">No form data submitted yet</div>';
        }
        
        uploadsContainer.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading uploads:', error);
        document.getElementById('modal-uploads-content').innerHTML = '<div class="modal-empty-state">Error loading uploads</div>';
      }
    }
    
    async function loadModalTimeline(caseId) {
      try {
        console.log('='.repeat(60));
        console.log('ðŸ”§ TIMELINE FILTER v3.0 - MODAL - STARTING');
        console.log('ðŸ“Š Loading timeline for case:', caseId);
        
        const { data: allEvents, error } = await supabaseClient
          .from('events')
          .select('*')
          .eq('target_id', caseId)
          .order('timestamp', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        console.log('ðŸ“‹ RAW EVENTS RECEIVED:', allEvents?.length || 0);
        console.log('ðŸ“‹ ALL ACTION TYPES:', allEvents?.map(e => `"${e.action_type}"`) || []);
        
        const timelineContainer = document.getElementById('modal-timeline-content');
        
        if (!allEvents || allEvents.length === 0) {
          timelineContainer.innerHTML = '<div class="modal-empty-state">No timeline events yet</div>';
          return;
        }
        
        // ========================================================================
        // FILTER - ONLY SHOW KEY WORKFLOW EVENTS
        // ========================================================================
        console.log('ðŸ” APPLYING FILTER...');
        
        const filteredEvents = allEvents.filter(event => {
          const action = event.action_type;
          
          // Block unwanted events
          if (action === 'INSERT') {
            console.log(`âŒ BLOCKED: INSERT`);
            return false;
          }
          if (action === 'UPDATE') {
            console.log(`âŒ BLOCKED: UPDATE`);
            return false;
          }
          if (action === 'DELETE') {
            console.log(`âŒ BLOCKED: DELETE`);
            return false;
          }
          if (action === 'status_changed') {
            console.log(`âŒ BLOCKED: status_changed`);
            return false;
          }
          if (action === 'case_updated') {
            console.log(`âŒ BLOCKED: case_updated`);
            return false;
          }
          if (action === 'cases_created') {
            console.log(`âŒ BLOCKED: cases_created`);
            return false;
          }
          if (action === 'form_updated') {
            console.log(`âŒ BLOCKED: form_updated`);
            return false;
          }
          if (action === 'form_draft_updated') {
            console.log(`âŒ BLOCKED: form_draft_updated`);
            return false;
          }
          if (action === 'editor_updated') {
            console.log(`âŒ BLOCKED: editor_updated`);
            return false;
          }
          if (action === 'sla_updated') {
            console.log(`âŒ BLOCKED: sla_updated`);
            return false;
          }
          
          // Allow everything else
          console.log(`âœ… ALLOWED: ${action}`);
          return true;
        });
        
        console.log(`âœ… FILTER COMPLETE: ${allEvents.length} â†’ ${filteredEvents.length} events`);
        console.log('âœ… REMAINING EVENTS:', filteredEvents.map(e => `"${e.action_type}"`));
        console.log('='.repeat(60));
        
        if (filteredEvents.length === 0) {
          timelineContainer.innerHTML = '<div class="modal-empty-state">No key timeline events</div>';
          return;
        }
        
        timelineContainer.innerHTML = filteredEvents.map(e => `
          <div class="modal-timeline-item">
            <div class="modal-timeline-time">${new Date(e.timestamp).toLocaleString()}</div>
            <div class="modal-timeline-event">${formatEventAction(e.action_type, e.payload)}</div>
            <div class="modal-timeline-actor">${formatActorDisplay(e)}</div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('âŒ ERROR loading timeline:', error);
        document.getElementById('modal-timeline-content').innerHTML = '<div class="modal-empty-state">Error loading timeline</div>';
      }
    }
    
    function formatEventAction(action, payload = {}) {
      const editorEmail = payload?.editor_email;
      const qcEmail = payload?.qc_reviewer_email;
      const revisionNum = payload?.revision_number;
      
      const actionMap = {
        'CREATE_CASE': 'Case created',
        'form_submitted': 'Intake form completed and submitted',
        'AUTO_ASSIGN_EDITOR': editorEmail ? `Editor automatically assigned: ${editorEmail}` : 'Editor automatically assigned',
        'editor_assigned': 'Editor assigned',
        'editor_reassigned': 'Editor reassigned',
        'video_submitted': editorEmail ? `Video submitted to QC by ${editorEmail}${revisionNum ? ` (Revision #${revisionNum})` : ''}` : 'Video submitted to QC',
        'qc_approved': qcEmail ? `QC approved - delivered to family by ${qcEmail}` : 'QC approved - delivered to family',
        'qc_revision': qcEmail ? `QC requested revision by ${qcEmail}` : 'QC requested revision',
        'qc_rejected': qcEmail ? `QC rejected by ${qcEmail}` : 'QC rejected',
        'qc_reassigned': 'QC reviewer reassigned',
        'pushed_to_revision': 'Case pushed to revision',
        'link_regenerated': 'Family login link regenerated',
        'link_resent': 'Family login link resent',
        'note_added': 'Note added to case'
      };
      
      return actionMap[action] || action.replace(/_/g, ' ');
    }
    
    function formatActorDisplay(event) {
      const role = event.actor_role;
      const roleBadges = {
        'admin': 'ðŸ‘‘ Admin',
        'director': 'ðŸ‘” Director',
        'family': 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Family',
        'editor': 'âœï¸ Editor',
        'qc': 'ðŸ” QC',
        'service_role': 'âš™ï¸ System'
      };
      
      const badge = roleBadges[role] || role || 'System';
      return `By: ${badge}`;
    }
    
    async function loadModalAudit(caseId) {
      try {
        const { data: events, error } = await supabaseClient
          .from('events')
          .select('*')
          .eq('target_id', caseId)
          .order('timestamp', { ascending: false });
        
        if (error) throw error;
        
        console.log('ðŸ” AUDIT DEBUG - All Events:', events?.map(e => ({ 
          action: e.action_type, 
          timestamp: e.timestamp,
          has_notes: !!e.payload?.qc_notes,
          payload_keys: Object.keys(e.payload || {})
        })));
        
        const auditContainer = document.getElementById('modal-audit-content');
        
        if (!events || events.length === 0) {
          auditContainer.innerHTML = '<div class="modal-empty-state">No audit events</div>';
          return;
        }
        
        // Fetch all unique user IDs to get their details
        const userIds = [...new Set(events.map(e => e.actor_user_id).filter(Boolean))];
        const userDetailsMap = {};
        
        if (userIds.length > 0) {
          try {
            const { data: users } = await supabaseClient
              .from('users')
              .select('id, email, metadata')
              .in('id', userIds);
            
            if (users) {
              users.forEach(user => {
                userDetailsMap[user.id] = {
                  name: user.metadata?.name || null,
                  email: user.email
                };
              });
            }
          } catch (err) {
            console.log('Could not fetch user details for audit:', err);
          }
        }
        
        // For status_changed events to revision_requested, we need to fetch QC notes from video_submissions
        // Build a map of submission_id to qc_notes for quick lookup
        const qcNotesMap = {};
        const statusChangedEvents = events.filter(e => 
          e.action_type === 'status_changed' && 
          e.payload?.new?.status === 'revision_requested'
        );
        
        if (statusChangedEvents.length > 0) {
          try {
            // Fetch the most recent video submission for this case to get QC notes
            const { data: submissions } = await supabaseClient
              .from('video_submissions')
              .select('id, qc_notes, qc_status, updated_at')
              .eq('case_id', caseId)
              .eq('qc_status', 'revision_requested')
              .order('updated_at', { ascending: false });
            
            if (submissions && submissions.length > 0) {
              // Map notes by timestamp - match events with submissions by approximate time
              submissions.forEach(sub => {
                qcNotesMap[sub.id] = sub.qc_notes;
              });
              
              console.log('ðŸ” AUDIT DEBUG - QC Notes Map:', qcNotesMap);
            }
          } catch (err) {
            console.log('Could not fetch QC notes:', err);
          }
        }
        
        // Render audit events with enhanced formatting
        auditContainer.innerHTML = events.map(e => {
          const actorDisplay = formatAuditActor(e, userDetailsMap);
          const eventDescription = formatAuditEvent(e.action_type, e.payload, e.actor_role, qcNotesMap);
          
          return `
            <div class="modal-timeline-item">
              <div class="modal-timeline-time">${new Date(e.timestamp).toLocaleString()}</div>
              <div class="modal-timeline-event">${eventDescription}</div>
              <div class="modal-timeline-actor">${actorDisplay}</div>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error loading audit:', error);
        document.getElementById('modal-audit-content').innerHTML = '<div class="modal-empty-state">Error loading audit trail</div>';
      }
    }
    
    function formatAuditActor(event, userDetailsMap) {
      const userId = event.actor_user_id;
      const role = event.actor_role;
      
      // Get user details if available
      let displayName = '';
      if (userId && userDetailsMap[userId]) {
        const user = userDetailsMap[userId];
        displayName = user.name || user.email;
      } else if (role && role !== 'service_role') {
        // Use role as fallback
        const roleMap = {
          'admin': 'Admin',
          'director': 'Director',
          'family': 'Family Member',
          'editor': 'Editor',
          'qc': 'QC Reviewer'
        };
        displayName = roleMap[role] || role;
      } else {
        displayName = 'System';
      }
      
      // Add role badge
      const roleBadges = {
        'admin': 'ðŸ‘‘',
        'director': 'ðŸ‘”',
        'family': 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§',
        'editor': 'âœï¸',
        'qc': 'ðŸ”',
        'service_role': 'âš™ï¸'
      };
      
      const badge = roleBadges[role] || 'ðŸ‘¤';
      
      return `<strong>${badge} ${displayName}</strong>`;
    }
    
    function formatAuditEvent(actionType, payload = {}, actorRole, qcNotesMap = {}) {
      // Extract common payload fields
      const editorEmail = payload?.editor_email;
      const qcEmail = payload?.qc_reviewer_email;
      const revisionNum = payload?.revision_number;
      const qcNotes = payload?.qc_notes;
      const editorNotes = payload?.editor_notes;
      
      // Handle status changes specifically
      if (actionType === 'status_changed' && payload?.new && payload?.old) {
        const oldStatus = payload.old.status;
        const newStatus = payload.new.status;
        
        const statusMap = {
          'created': 'Created',
          'waiting_on_family': 'Waiting on Family',
          'intake_in_progress': 'Intake in Progress',
          'submitted': 'Submitted',
          'in_production': 'In Production',
          'awaiting_review': 'Awaiting Review',
          'delivered': 'Delivered',
          'closed': 'Closed',
          'revision_requested': 'Revision Requested'
        };
        
        // Special handling for revision_requested status - try to find QC notes
        if (newStatus === 'revision_requested') {
          // Try multiple sources for the notes:
          // 1. Directly in payload.qc_notes
          // 2. In payload.new.qc_notes  
          // 3. From the qcNotesMap (fetched from video_submissions)
          let notes = qcNotes || payload.new?.qc_notes;
          
          // If still no notes, try to get from the most recent submission in the map
          if (!notes && Object.keys(qcNotesMap).length > 0) {
            // Get any available notes from the map
            const availableNotes = Object.values(qcNotesMap).find(n => n);
            if (availableNotes) {
              notes = availableNotes;
            }
          }
          
          const notesDisplay = notes ? `<br><small style="color: var(--text-tertiary);">QC Notes: ${notes}</small>` : '';
          return `<strong>QC Requested Revision</strong>${notesDisplay}`;
        }
        
        return `<strong>Status Changed:</strong> ${statusMap[oldStatus] || oldStatus} â†’ ${statusMap[newStatus] || newStatus}`;
      }
      
      // Handle case updates specifically
      if (actionType === 'case_updated' && payload?.new && payload?.old) {
        const changes = [];
        const old = payload.old;
        const newData = payload.new;
        
        // Check for specific field changes
        if (old.deceased_name !== newData.deceased_name) {
          changes.push(`Name: "${old.deceased_name}" â†’ "${newData.deceased_name}"`);
        }
        if (old.status !== newData.status) {
          changes.push(`Status: ${old.status} â†’ ${newData.status}`);
        }
        if (old.assigned_family_user_id !== newData.assigned_family_user_id) {
          changes.push('Family assignment updated');
        }
        
        if (changes.length > 0) {
          return `<strong>Case Updated:</strong> ${changes.join(', ')}`;
        } else {
          return '<strong>Case Updated:</strong> Internal data modified';
        }
      }
      
      // Map action types to human-readable descriptions
      const actionDescriptions = {
        'CREATE_CASE': '<strong>Case Created</strong> by director',
        'cases_created': '<strong>Case Created</strong> in system',
        'form_submitted': '<strong>Intake Form Submitted</strong> by family',
        'form_draft_updated': '<strong>Form Draft Saved</strong> (autosave)',
        'form_updated': '<strong>Form Updated</strong> after submission',
        
        'AUTO_ASSIGN_EDITOR': editorEmail 
          ? `<strong>Editor Auto-Assigned:</strong> ${editorEmail}` 
          : '<strong>Editor Auto-Assigned</strong> by system',
        
        'editor_assigned': editorEmail 
          ? `<strong>Editor Assigned:</strong> ${editorEmail}` 
          : '<strong>Editor Assigned</strong> to case',
        
        'editor_reassigned': '<strong>Editor Reassigned</strong> to different editor',
        'editor_unassigned': '<strong>Editor Unassigned</strong> from case',
        
        'video_submitted': editorEmail 
          ? `<strong>Video Submitted to QC</strong> by ${editorEmail}${revisionNum ? ` (Revision #${revisionNum})` : ''}${editorNotes ? `<br><small style="color: var(--text-tertiary);">Notes: ${editorNotes}</small>` : ''}`
          : `<strong>Video Submitted to QC</strong>${revisionNum ? ` (Revision #${revisionNum})` : ''}`,
        
        'qc_approved': qcEmail 
          ? `<strong>QC Approved - Delivered to Family</strong> by ${qcEmail}${qcNotes ? `<br><small style="color: var(--text-tertiary);">Notes: ${qcNotes}</small>` : ''}`
          : '<strong>QC Approved - Delivered to Family</strong>',
        
        'qc_revision': qcEmail 
          ? `<strong>QC Requested Revision</strong> by ${qcEmail}${qcNotes ? `<br><small style="color: var(--text-tertiary);">Notes: ${qcNotes}</small>` : ''}`
          : '<strong>QC Requested Revision</strong>',
        
        'qc_rejected': qcEmail 
          ? `<strong>QC Rejected</strong> by ${qcEmail}${qcNotes ? `<br><small style="color: var(--text-tertiary);">Notes: ${qcNotes}</small>` : ''}`
          : '<strong>QC Rejected</strong>',
        
        'qc_reassigned': '<strong>QC Reviewer Reassigned</strong>',
        'pushed_to_revision': '<strong>Case Pushed to Revision</strong> by admin',
        'link_regenerated': '<strong>Family Login Link Regenerated</strong>',
        'link_resent': '<strong>Family Login Link Resent</strong>',
        'note_added': '<strong>Note Added to Case</strong>',
        'sla_updated': '<strong>SLA Status Updated</strong>',
        'family_assigned': '<strong>Family Member Assigned</strong> to case'
      };
      
      // Return formatted description or fallback to cleaned action type
      if (actionDescriptions[actionType]) {
        return actionDescriptions[actionType];
      }
      
      // Fallback: Clean up action type
      return `<strong>${actionType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>`;
    }
    
    function switchModalTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`modal-tab-${tabName}`).classList.add('active');
    }
    
    function closeCaseDetailModal() {
      // Re-enable body scroll
      document.body.style.overflow = '';
      
      document.getElementById('case-detail-modal').classList.remove('active');
      currentCaseDetailId = null;
      currentModalCaseData = null;
      
      // Reset to overview tab
      document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('.modal-tab-btn').classList.add('active');
      document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('modal-tab-overview').classList.add('active');
    }
    
    function formatStatus(status) {
      const statusMap = {
        'waiting_on_family': 'Waiting on Family',
        'intake_in_progress': 'Intake in Progress',
        'submitted': 'Submitted',
        'in_production': 'In Production',
        'awaiting_review': 'Awaiting Review',
        'revision_requested': 'Revision Requested',
        'delivered': 'Delivered',
        'closed': 'Closed'
      };
      return statusMap[status] || status;
    }
    
    function formatEventAction(action) {
      const actionMap = {
        'INSERT': 'Case created',
        'UPDATE': 'Case updated',
        'case_created': 'Case created',
        'status_changed': 'Status changed',
        'editor_assigned': 'Editor assigned',
        'video_submitted': 'Video submitted to QC',
        'qc_approved': 'QC approved',
        'qc_revision': 'QC requested revision',
        'form_submitted': 'Intake form submitted'
      };
      return actionMap[action] || action;
    }
    
    function formatFieldName(key) {
      return key
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
    }
    
    // Support Actions from Modal
    async function openReassignEditorFromModal() {
      // TODO: Implement editor reassignment modal
      alert('Editor reassignment feature coming soon! (Currently being migrated from case-detail.html)');
    }
    
    async function openReassignQCFromModal() {
      // TODO: Implement QC reassignment modal
      alert('QC reassignment feature coming soon! (Currently being migrated from case-detail.html)');
    }
    
    async function pushToRevisionFromModal() {
      if (!confirm('Push this case to revision? The editor will be notified.')) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('cases')
          .update({ status: 'revision_requested' })
          .eq('id', currentCaseDetailId);
        
        if (error) throw error;
        
        // Log to audit
        await supabaseClient
          .from('events')
          .insert({
            actor_user_id: currentUser.id,
            actor_role: 'admin',
            action_type: 'pushed_to_revision',
            target_type: 'case',
            target_id: currentCaseDetailId,
            payload: { reason: 'Admin support action' }
          });
        
        alert('Case pushed to revision successfully!');
        closeCaseDetailModal();
        
        // Reload cases
        await loadCases();
        
      } catch (error) {
        console.error('Error pushing to revision:', error);
        alert('Error: ' + error.message);
      }
    }
    
    function showCaseIdInfo() {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(currentCaseDetailId);
        alert('Case ID copied to clipboard: ' + currentCaseDetailId);
      } else {
        alert('Case ID: ' + currentCaseDetailId);
      }
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('case-detail-modal');
      if (e.target === modal) {
        // Re-enable body scroll
        document.body.style.overflow = '';
        closeCaseDetailModal();
      }
    });
    
    // Make functions global
    window.openCaseDetailModal = openCaseDetailModal;
    window.closeCaseDetailModal = closeCaseDetailModal;
    window.switchModalTab = switchModalTab;
    window.openReassignEditorFromModal = openReassignEditorFromModal;
    window.openReassignQCFromModal = openReassignQCFromModal;
    window.pushToRevisionFromModal = pushToRevisionFromModal;
    window.showCaseIdInfo = showCaseIdInfo;
    
  </script>
  
  <!-- Case Detail Modal -->
  <div id="case-detail-modal" class="case-detail-modal">
    <div class="case-detail-content">
      <button class="case-detail-close" onclick="closeCaseDetailModal()">&times;</button>
      
      <!-- Header -->
      <div class="case-detail-header">
        <h2 class="case-detail-title" id="case-modal-name">Loading...</h2>
        <div class="case-detail-subtitle">
          <span id="case-modal-org">-</span>
          <span>â€¢</span>
          <span id="case-modal-status">-</span>
          <span>â€¢</span>
          <span id="case-modal-date">-</span>
        </div>
        <div class="case-detail-meta-grid">
          <div class="case-detail-meta-item">
            <span class="case-detail-meta-label">Funeral Home</span>
            <span class="case-detail-meta-value" id="case-modal-org-name">-</span>
          </div>
          <div class="case-detail-meta-item">
            <span class="case-detail-meta-label">Assigned Editor</span>
            <span class="case-detail-meta-value" id="case-modal-editor">-</span>
          </div>
          <div class="case-detail-meta-item">
            <span class="case-detail-meta-label">QC Reviewer</span>
            <span class="case-detail-meta-value" id="case-modal-qc">-</span>
          </div>
          <div class="case-detail-meta-item">
            <span class="case-detail-meta-label">Family Contact</span>
            <span class="case-detail-meta-value" id="case-modal-family">-</span>
          </div>
        </div>
      </div>
      
      <!-- Body with Tabs and Sidebar -->
      <div class="case-detail-body">
        <!-- Main Content with Tabs -->
        <div class="case-detail-main">
          <div class="modal-tabs">
            <button class="modal-tab-btn active" onclick="switchModalTab('overview')">Overview</button>
            <button class="modal-tab-btn" onclick="switchModalTab('uploads')">Uploads & Forms</button>
            <button class="modal-tab-btn" onclick="switchModalTab('timeline')">Timeline</button>
            <button class="modal-tab-btn" onclick="switchModalTab('audit')">Audit</button>
          </div>
          
          <!-- Overview Tab -->
          <div id="modal-tab-overview" class="modal-tab-content active">
            <div class="case-detail-section">
              <h3 class="case-detail-section-title">ðŸ“‹ Case Information</h3>
              <div class="case-detail-grid">
                <div class="case-detail-item">
                  <span class="case-detail-label">Case ID</span>
                  <span class="case-detail-value" id="case-modal-id">-</span>
                </div>
                <div class="case-detail-item">
                  <span class="case-detail-label">Status</span>
                  <span class="case-detail-value" id="case-modal-status-full">-</span>
                </div>
                <div class="case-detail-item">
                  <span class="case-detail-label">Created</span>
                  <span class="case-detail-value" id="case-modal-created">-</span>
                </div>
                <div class="case-detail-item">
                  <span class="case-detail-label">Last Updated</span>
                  <span class="case-detail-value" id="case-modal-updated">-</span>
                </div>
                <div class="case-detail-item">
                  <span class="case-detail-label">Organization ID</span>
                  <span class="case-detail-value" id="case-modal-org-id">-</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Uploads & Forms Tab -->
          <div id="modal-tab-uploads" class="modal-tab-content">
            <div id="modal-uploads-content">
              <div class="modal-loading">Loading uploads...</div>
            </div>
          </div>
          
          <!-- Timeline Tab -->
          <div id="modal-tab-timeline" class="modal-tab-content">
            <div class="modal-timeline" id="modal-timeline-content">
              <div class="modal-loading">Loading timeline...</div>
            </div>
          </div>
          
          <!-- Audit Tab -->
          <div id="modal-tab-audit" class="modal-tab-content">
            <div class="modal-timeline" id="modal-audit-content">
              <div class="modal-loading">Loading audit trail...</div>
            </div>
          </div>
        </div>
        
        <!-- Sidebar with Support Actions -->
        <div class="case-detail-sidebar">
          <h3 class="support-actions-title">Support Actions</h3>
          <div class="support-actions">
            <button class="support-action-btn" onclick="openReassignEditorFromModal()">
              <span>âœï¸</span>
              <span>Reassign Editor</span>
            </button>
            <button class="support-action-btn" onclick="openReassignQCFromModal()">
              <span>ðŸ”</span>
              <span>Reassign QC</span>
            </button>
            <button class="support-action-btn danger" onclick="pushToRevisionFromModal()">
              <span>ðŸ”„</span>
              <span>Push to Revision</span>
            </button>
            <button class="support-action-btn" onclick="showCaseIdInfo()">
              <span>ðŸ†”</span>
              <span>Copy Case ID</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</body>
</html>

