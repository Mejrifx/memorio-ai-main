<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - Memorio</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Preload Dosis font -->
  <link rel="preload" href="../fonts/Dosis-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/memorio-forms.webflow.css" rel="stylesheet" type="text/css">
  <link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  
  <style>
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 72px;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }
    
    .dashboard-title {
      color: #32343a;
      font-size: 32px;
      font-weight: 600;
      margin: 0;
    }
    
    .logout-btn {
      color: #32343a;
      background-color: transparent;
      border: 1.35px solid #32343a;
      border-radius: 60px;
      padding: 11px 18px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background-color: #32343a;
      color: #f2eadd;
    }
    
    .invite-section {
      background-color: #fff3e9;
      border: 3px solid #436481;
      border-radius: 20px;
      padding: 48px;
      margin-bottom: 40px;
      box-shadow: 0 2px 8px -2px rgba(0,0,0,0.2);
    }
    
    .section-title {
      color: #32343a;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-row-single {
      margin-bottom: 20px;
    }
    
    .success-box {
      background-color: #e8f5e9;
      border: 2px solid #66bb6a;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .success-box h3 {
      color: #2e7d32;
      margin-top: 0;
      margin-bottom: 15px;
    }
    
    .credential-box {
      background-color: #f4e8de;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      position: relative;
    }
    
    .credential-label {
      color: #33333373;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }
    
    .credential-value {
      color: #32343a;
      font-size: 18px;
      font-weight: 600;
      word-break: break-all;
    }
    
    .copy-btn {
      background-color: #32343a;
      color: #f2eadd;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 5px;
    }
    
    .copy-btn:hover {
      background-color: #6ca7d3;
    }
    
    .error-box {
      background-color: #ffebee;
      border: 2px solid #ef5350;
      border-radius: 10px;
      padding: 15px;
      color: #c62828;
      margin-top: 20px;
      display: none;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background-color: transparent;
      border: 2px solid #32343a;
      border-radius: 60px;
      color: #32343a;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .tab-btn.active {
      background-color: #32343a;
      color: #f2eadd;
    }
    
    .tab-btn:hover {
      background-color: #32343a;
      color: #f2eadd;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .org-card {
      background-color: #f4e8de;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .org-card-name {
      color: #32343a;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .org-card-detail {
      color: #33333373;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .org-card-id {
      background-color: #fff3e9;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
    }
    
    /* Custom Confirmation Modal */
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .confirmation-content {
      background-color: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .confirmation-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .confirmation-title {
      color: #32343a;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .confirmation-message {
      color: #666;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    
    .confirmation-warning {
      background-color: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      color: #e65100;
      font-size: 14px;
      font-weight: 600;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .btn-confirm-delete {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-confirm-delete:hover {
      background-color: #d32f2f;
    }
    
    .btn-cancel {
      background-color: #f0f0f0;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-cancel:hover {
      background-color: #e0e0e0;
    }
    
    /* Success Modal */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .success-content {
      background-color: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .success-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .success-title {
      color: #32343a;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .success-message {
      color: #666;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    
    .btn-success-ok {
      background-color: #436481;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-success-ok:hover {
      background-color: #1e3a52;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }
      
      .tab-container {
        flex-direction: column;
      }
    }
  </style>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="body">
  <!-- Nav -->
  <div class="nav">
    <div class="logo-wrapper">
      <img src="../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png" 
           loading="lazy" 
           width="166" 
           alt="Memorio Logo" 
           srcset="../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview-p-500.png 500w, ../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview-p-800.png 800w, ../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png 838w">
    </div>
  </div>

  <!-- Dashboard Container -->
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1 class="dashboard-title">Admin Dashboard</h1>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>

    <!-- Tabs -->
    <div class="tab-container" style="display: flex; gap: 10px; margin-bottom: 30px;">
      <button class="tab-btn active" onclick="switchTab('organizations')">Organizations</button>
      <button class="tab-btn" onclick="switchTab('invite-director')">Invite Director</button>
    </div>

    <!-- Organizations Tab -->
    <div id="organizations-tab" class="tab-content active">
      <div class="invite-section">
        <h2 class="section-title">Create New Organization</h2>
        <p class="paragraph">Add a new funeral home to the Memorio platform. Each organization can have multiple Directors and manage their own cases.</p>
        
        <form id="create-org-form">
          <div class="form-row">
            <div>
              <label for="org-name" class="field-label">Organization Name*</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="org-name" 
                placeholder="Smith Family Funeral Home" 
                required>
            </div>
            
            <div>
              <label for="org-email" class="field-label">Contact Email*</label>
              <input 
                class="text-field w-input" 
                type="email" 
                id="org-email" 
                placeholder="contact@smithfuneral.com" 
                required>
            </div>
          </div>
          
          <div class="form-row">
            <div>
              <label for="org-phone" class="field-label">Contact Phone</label>
              <input 
                class="text-field w-input" 
                type="tel" 
                id="org-phone" 
                placeholder="+1-555-0123">
            </div>
            
            <div>
              <label for="org-region" class="field-label">Region</label>
              <input 
                class="text-field w-input" 
                type="text" 
                id="org-region" 
                placeholder="New York, NY">
            </div>
          </div>
          
          <div class="form-button" style="margin-top: 20px;">
            <button type="submit" class="button-primary w-button" id="create-org-btn">
              CREATE ORGANIZATION
            </button>
          </div>
        </form>
        
        <!-- Success Box -->
        <div id="org-success-box" class="success-box">
          <h3>✅ Organization Created Successfully!</h3>
          <p>Use this Organization ID when inviting Directors for this funeral home.</p>
          
          <div class="credential-box">
            <div class="credential-label">Organization Name</div>
            <div class="credential-value" id="created-org-name"></div>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Organization ID (use this when inviting Directors)</div>
            <div class="credential-value" id="created-org-id"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-org-id')">Copy ID</button>
          </div>
        </div>
        
        <!-- Error Box -->
        <div id="org-error-box" class="error-box"></div>
      </div>

      <!-- Existing Organizations List -->
      <div class="invite-section" style="margin-top: 40px;">
        <h2 class="section-title">Existing Organizations</h2>
        <p class="paragraph">All funeral homes registered in Memorio. Copy the Organization ID to use when inviting Directors.</p>
        
        <div id="organizations-list" style="margin-top: 20px;">
          <!-- Organizations will be loaded here -->
        </div>
        
        <div id="org-list-error-box" class="error-box"></div>
      </div>
    </div>

    <!-- Invite Director Tab -->
    <div id="invite-director-tab" class="tab-content">
    <!-- Invite Director Section -->
    <div class="invite-section">
      <h2 class="section-title">Invite Director</h2>
      <p class="paragraph">Create a new Director account for a funeral home. The credentials will be displayed below for you to share securely.</p>
      
      <form id="invite-form">
        <div class="form-row">
          <div>
            <label for="director-email" class="field-label">Email Address*</label>
            <input 
              class="text-field w-input" 
              type="email" 
              id="director-email" 
              placeholder="director@funeralhome.com" 
              required>
          </div>
          
          <div>
            <label for="director-name" class="field-label">Full Name*</label>
            <input 
              class="text-field w-input" 
              type="text" 
              id="director-name" 
              placeholder="John Director" 
              required>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="director-phone" class="field-label">Phone Number</label>
            <input 
              class="text-field w-input" 
              type="tel" 
              id="director-phone" 
              placeholder="+1-555-0123">
          </div>
          
          <div>
            <label for="org-id" class="field-label">Organization ID*</label>
            <input 
              class="text-field w-input" 
              type="text" 
              id="org-id" 
              placeholder="00000000-0000-0000-0000-000000000001" 
              required>
          </div>
        </div>
        
        <div class="form-button" style="margin-top: 20px;">
          <button type="submit" class="button-primary w-button" id="invite-btn">
            CREATE DIRECTOR ACCOUNT
          </button>
        </div>
      </form>
      
      <!-- Success Box -->
      <div id="success-box" class="success-box">
        <h3>✅ Director Account Created Successfully!</h3>
        <p>Share these credentials with the Director securely. They should change their password after first login.</p>
        
        <div class="credential-box">
          <div class="credential-label">Email Address</div>
          <div class="credential-value" id="created-email"></div>
          <button class="copy-btn" onclick="copyToClipboard('created-email')">Copy</button>
        </div>
        
        <div class="credential-box">
          <div class="credential-label">Temporary Password</div>
          <div class="credential-value" id="created-password"></div>
          <button class="copy-btn" onclick="copyToClipboard('created-password')">Copy</button>
        </div>
        
        <div class="credential-box">
          <div class="credential-label">Login URL</div>
          <div class="credential-value">https://memorio.ai/m-director-9m6z/login.html</div>
          <button class="copy-btn" onclick="copyToClipboard('login-url')">Copy</button>
        </div>
      </div>
      
      <!-- Error Box -->
      <div id="error-box" class="error-box"></div>
    </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmation-modal" class="confirmation-modal">
    <div class="confirmation-content">
      <div class="confirmation-icon">⚠️</div>
      <h2 class="confirmation-title" id="confirmation-title">Confirm Deletion</h2>
      <p class="confirmation-message" id="confirmation-message">Are you sure you want to delete this organization?</p>
      <div class="confirmation-warning" id="confirmation-warning">
        This action cannot be undone and will permanently remove all related data.
      </div>
      <div class="confirmation-buttons">
        <button class="btn-cancel" onclick="closeConfirmationModal()">Cancel</button>
        <button class="btn-confirm-delete" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Custom Success Modal -->
  <div id="success-modal" class="success-modal">
    <div class="success-content">
      <div class="success-icon">✅</div>
      <h2 class="success-title">Success!</h2>
      <p class="success-message" id="success-message">The organization has been successfully deleted.</p>
      <button class="btn-success-ok" onclick="closeSuccessModal()">OK</button>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://gkabtvqwwuvigcdubwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrYWJ0dnF3d3V2aWdjZHVid3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDE5MjUsImV4cCI6MjA3NTQ3NzkyNX0.O1DfOR5FBm6r3Pg-tjEE5CkzRr3WlWqGU1xUYKrhtnU';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Check if user is logged in and is admin
    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      
      // Verify admin role
      const { data: userData, error } = await supabaseClient
        .from('users')
        .select('role')
        .eq('id', session.user.id)
        .single();
      
      if (error || !userData || userData.role !== 'admin') {
        await supabaseClient.auth.signOut();
        window.location.href = 'login.html';
      }
    }
    
    // Run auth check on page load
    checkAuth();
    
    // Load organizations on page load
    loadOrganizations();
    
    // Logout handler
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    });
    
    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`${tabName}-tab`).classList.add('active');
      event.target.classList.add('active');
      
      // Load organizations if switching to organizations tab
      if (tabName === 'organizations') {
        loadOrganizations();
      }
    }
    
    // Make switchTab global
    window.switchTab = switchTab;
    
    // Handle invite form submission
    document.getElementById('invite-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('director-email').value;
      const name = document.getElementById('director-name').value;
      const phone = document.getElementById('director-phone').value;
      const orgId = document.getElementById('org-id').value;
      
      const inviteBtn = document.getElementById('invite-btn');
      const successBox = document.getElementById('success-box');
      const errorBox = document.getElementById('error-box');
      const inviteSection = document.querySelector('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      inviteSection.classList.add('loading');
      inviteBtn.disabled = true;
      inviteBtn.textContent = 'CREATING ACCOUNT...';
      
      try {
        // Get current session token
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session) {
          throw new Error('Not authenticated');
        }
        
        // Call invite-director Edge Function
        const response = await fetch(`${SUPABASE_URL}/functions/v1/invite-director`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            email,
            name,
            org_id: orgId,
            phone: phone || undefined
          })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create director account');
        }
        
        // Display success with credentials
        document.getElementById('created-email').textContent = result.data.email;
        document.getElementById('created-password').textContent = result.data.temp_password;
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('invite-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        inviteSection.classList.remove('loading');
        inviteBtn.disabled = false;
        inviteBtn.textContent = 'CREATE DIRECTOR ACCOUNT';
      }
    });
    
    // Handle create organization form submission
    document.getElementById('create-org-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('org-name').value;
      const email = document.getElementById('org-email').value;
      const phone = document.getElementById('org-phone').value;
      const region = document.getElementById('org-region').value;
      
      const createBtn = document.getElementById('create-org-btn');
      const successBox = document.getElementById('org-success-box');
      const errorBox = document.getElementById('org-error-box');
      const section = e.target.closest('.invite-section');
      
      // Hide previous messages
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      // Disable form during submission
      section.classList.add('loading');
      createBtn.disabled = true;
      createBtn.textContent = 'CREATING ORGANIZATION...';
      
      try {
        // Insert organization into database
        const { data, error } = await supabaseClient
          .from('organizations')
          .insert({
            name: name,
            contact_email: email,
            contact_phone: phone || null,
            region: region || null,
            status: 'active'
          })
          .select()
          .single();
        
        if (error) {
          throw new Error(error.message);
        }
        
        // Display success with organization ID
        document.getElementById('created-org-name').textContent = data.name;
        document.getElementById('created-org-id').textContent = data.id;
        successBox.style.display = 'block';
        
        // Reset form
        document.getElementById('create-org-form').reset();
        
        // Reload organizations list
        loadOrganizations();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        createBtn.disabled = false;
        createBtn.textContent = 'CREATE ORGANIZATION';
      }
    });
    
    // Load organizations list
    async function loadOrganizations() {
      const orgsList = document.getElementById('organizations-list');
      const errorBox = document.getElementById('org-list-error-box');
      
      errorBox.style.display = 'none';
      orgsList.innerHTML = '<p class="paragraph">Loading organizations...</p>';
      
      try {
        const { data: orgs, error } = await supabaseClient
          .from('organizations')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!orgs || orgs.length === 0) {
          orgsList.innerHTML = '<p class="paragraph">No organizations found. Create your first one above!</p>';
          return;
        }
        
        orgsList.innerHTML = orgs.map(org => `
          <div class="org-card">
            <div class="org-card-name">${org.name}</div>
            <div class="org-card-detail">📧 ${org.contact_email}</div>
            ${org.contact_phone ? `<div class="org-card-detail">📞 ${org.contact_phone}</div>` : ''}
            ${org.region ? `<div class="org-card-detail">📍 ${org.region}</div>` : ''}
            <div class="org-card-detail" style="margin-top: 10px;">Created: ${new Date(org.created_at).toLocaleDateString()}</div>
            <div class="org-card-id">
              <div class="credential-label">Organization ID (copy this when inviting Directors)</div>
              <div class="credential-value" id="org-${org.id}" style="color: #32343a; margin-top: 5px;">${org.id}</div>
              <button class="copy-btn" onclick="copyOrgId('org-${org.id}')">Copy ID</button>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button class="btn-secondary" onclick="deleteOrganization('${org.id}', '${org.name}')" style="padding: 6px 12px; font-size: 12px;">
                Delete Organization
              </button>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        errorBox.textContent = `Error loading organizations: ${error.message}`;
        errorBox.style.display = 'block';
        orgsList.innerHTML = '';
      }
    }
    
    // Copy organization ID
    function copyOrgId(elementId) {
      const text = document.getElementById(elementId).textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      });
    }
    
    // Make copyOrgId global
    window.copyOrgId = copyOrgId;
    window.deleteOrganization = deleteOrganization;
    window.closeConfirmationModal = closeConfirmationModal;
    window.closeSuccessModal = closeSuccessModal;
    
    // Modal Control Functions
    function closeConfirmationModal() {
      document.getElementById('confirmation-modal').style.display = 'none';
    }
    
    function closeSuccessModal() {
      document.getElementById('success-modal').style.display = 'none';
    }
    
    function showConfirmationModal(title, message, warning, onConfirm) {
      document.getElementById('confirmation-title').textContent = title;
      document.getElementById('confirmation-message').textContent = message;
      document.getElementById('confirmation-warning').textContent = warning;
      
      // Set up confirm button
      const confirmBtn = document.getElementById('confirm-delete-btn');
      confirmBtn.onclick = () => {
        closeConfirmationModal();
        onConfirm();
      };
      
      document.getElementById('confirmation-modal').style.display = 'flex';
    }
    
    function showSuccessModal(message) {
      document.getElementById('success-message').textContent = message;
      document.getElementById('success-modal').style.display = 'flex';
    }
    
    // Delete Organization Function
    async function deleteOrganization(orgId, orgName) {
      showConfirmationModal(
        'Delete Organization',
        `Are you sure you want to delete the organization "${orgName}"?`,
        'This action cannot be undone and will permanently remove:\n• Organization details\n• All associated cases\n• All user accounts\n• All form submissions\n• All uploaded assets\n• All related data\n\nThis should only be done if the funeral home is leaving Memorio permanently.',
        async () => {
          try {
            // Delete the organization (this will cascade delete related records due to foreign key constraints)
            const { error } = await supabaseClient
              .from('organizations')
              .delete()
              .eq('id', orgId);
            
            if (error) throw error;
            
            showSuccessModal(`Organization "${orgName}" has been successfully deleted.`);
            
            // Reload the organizations list
            await loadOrganizations();
            
          } catch (error) {
            console.error('Error deleting organization:', error);
            showSuccessModal(`Failed to delete organization: ${error.message}`);
          }
        }
      );
    }
    
    // Copy to clipboard function
    function copyToClipboard(elementId) {
      let text;
      if (elementId === 'login-url') {
        text = 'https://memorio.ai/m-director-9m6z/login.html';
      } else {
        text = document.getElementById(elementId).textContent;
      }
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      });
    }
    
    // Make copy function global
    window.copyToClipboard = copyToClipboard;
  </script>
</body>
</html>

