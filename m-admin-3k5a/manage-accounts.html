<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Manage Accounts - Memorio Admin</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Preload Dosis font -->
  <link rel="preload" href="../fonts/Dosis-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/memorio-forms.webflow.css" rel="stylesheet" type="text/css">
  <link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  
  <style>
    /* ============================================================================
       MEMORIO ADMIN MANAGE ACCOUNTS PAGE
       ============================================================================ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      background-color: #f4e8de;
      min-height: 100vh;
    }
    
    /* ============================================================================
       SIDEBAR
       ============================================================================ */
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background-color: #fff3e9;
      border-right: 3px solid #436481;
      box-shadow: 4px 0 15px rgba(67, 100, 129, 0.1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-logo {
      height: 70px;
      padding: 0;
      border-bottom: 2px solid #436481;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar-logo img {
      width: 140px;
      height: auto;
      max-height: 60px;
      object-fit: contain;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }
    
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 24px;
      margin: 4px 12px;
      color: #32343a;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      border: 1.5px solid transparent;
    }
    
    .sidebar-nav-item:hover {
      background-color: #f4e8de;
      border-color: #6ca7d3;
      color: #436481;
    }
    
    .sidebar-nav-item.active {
      background-color: #f4e8de;
      border-color: #436481;
      color: #436481;
    }
    
    /* ============================================================================
       TOPBAR
       ============================================================================ */
    
    .topbar {
      position: fixed;
      top: 0;
      left: 280px;
      right: 0;
      height: 70px;
      background-color: #fff3e9;
      border-bottom: 2px solid #436481;
      box-shadow: 0 2px 8px rgba(67, 100, 129, 0.1);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
    }
    
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .topbar-title {
      color: #32343a;
      font-size: 26px;
      font-weight: 600;
    }
    
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background-color: #f4e8de;
      border: 1.5px solid #436481;
      border-radius: 60px;
    }
    
    .topbar-user-email {
      font-size: 14px;
      color: #32343a;
      font-weight: 500;
    }
    
    .logout-btn {
      padding: 10px 20px;
      background-color: #436481;
      color: #fff3e9;
      border: none;
      border-radius: 60px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .logout-btn:hover {
      background-color: #32343a;
    }
    
    /* ============================================================================
       MAIN CONTENT
       ============================================================================ */
    
    .main-content {
      margin-left: 280px;
      margin-top: 70px;
      padding: 32px;
      min-height: calc(100vh - 70px);
    }
    
    .content-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ============================================================================
       STATS CARDS
       ============================================================================ */
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background-color: #fff3e9;
      border: 2px solid #436481;
      border-radius: 12px;
      padding: 24px;
    }
    
    .stat-label {
      font-size: 14px;
      color: rgba(50, 52, 58, 0.6);
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #436481;
    }
    
    /* ============================================================================
       ACCOUNTS TABLE
       ============================================================================ */
    
    .section {
      background-color: #fff3e9;
      border: 2px solid #436481;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #436481;
    }
    
    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: #32343a;
    }
    
    .filter-buttons {
      display: flex;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 8px 16px;
      background-color: #f4e8de;
      border: 1.5px solid #436481;
      border-radius: 60px;
      color: #436481;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .filter-btn:hover {
      background-color: #436481;
      color: #fff3e9;
    }
    
    .filter-btn.active {
      background-color: #436481;
      color: #fff3e9;
    }
    
    .accounts-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .accounts-table thead {
      background-color: #f4e8de;
    }
    
    .accounts-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 14px;
      font-weight: 600;
      color: #32343a;
      border-bottom: 2px solid #436481;
    }
    
    .accounts-table td {
      padding: 16px;
      border-bottom: 1px solid rgba(67, 100, 129, 0.2);
      font-size: 14px;
      color: #32343a;
    }
    
    .accounts-table tr:hover {
      background-color: #f4e8de;
    }
    
    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 60px;
      font-size: 12px;
      font-weight: 600;
      border: 1.5px solid;
    }
    
    .role-badge.editor {
      background-color: #d4f4dd;
      color: #2d7738;
      border-color: #2d7738;
    }
    
    .role-badge.qc {
      background-color: #cce5ff;
      color: #004085;
      border-color: #004085;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 60px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-badge.active {
      background-color: #d4f4dd;
      color: #2d7738;
    }
    
    .status-badge.invited {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-badge.suspended {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-view {
      padding: 6px 14px;
      background-color: #f4e8de;
      border: 1.5px solid #436481;
      border-radius: 60px;
      color: #436481;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .btn-view:hover {
      background-color: #436481;
      color: #fff3e9;
    }
    
    .btn-delete {
      padding: 6px 14px;
      background-color: #f8d7da;
      border: 1.5px solid #d9534f;
      border-radius: 60px;
      color: #d9534f;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .btn-delete:hover {
      background-color: #d9534f;
      color: #fff3e9;
    }
    
    /* ============================================================================
       MODAL
       ============================================================================ */
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: #fff3e9;
      border: 2px solid #436481;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #32343a;
      margin-bottom: 20px;
    }
    
    .modal-section {
      margin-bottom: 16px;
    }
    
    .modal-label {
      font-size: 13px;
      color: rgba(50, 52, 58, 0.6);
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }
    
    .modal-value {
      font-size: 16px;
      color: #32343a;
      font-weight: 600;
      display: block;
    }
    
    .modal-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px 16px;
      border: 1.5px solid #436481;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
      background-color: #fff3e9;
      color: #32343a;
      resize: vertical;
      margin-top: 8px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 60px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Dosis Variablefont Wght', Arial, sans-serif;
    }
    
    .modal-btn.danger {
      background-color: #d9534f;
      color: #fff3e9;
    }
    
    .modal-btn.danger:hover {
      background-color: #c9302c;
    }
    
    .modal-btn.secondary {
      background-color: #f4e8de;
      color: #436481;
      border: 1.5px solid #436481;
    }
    
    .modal-btn.secondary:hover {
      background-color: #fff3e9;
    }
    
    /* ============================================================================
       LOADING & EMPTY STATES
       ============================================================================ */
    
    .loading {
      text-align: center;
      padding: 48px;
      color: #436481;
      font-size: 18px;
      font-weight: 600;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px;
      color: rgba(50, 52, 58, 0.5);
      font-size: 16px;
    }
    
    /* ============================================================================
       TOAST NOTIFICATIONS
       ============================================================================ */
    
    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background-color: #436481;
      color: #fff3e9;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.error {
      background-color: #d9534f;
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <img src="../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png" alt="Memorio Logo">
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-nav-item">
        <span>üè†</span>
        <span>Dashboard</span>
      </a>
      <a href="cases.html" class="sidebar-nav-item">
        <span>üìã</span>
        <span>All Cases</span>
      </a>
      <a href="manage-accounts.html" class="sidebar-nav-item active">
        <span>üë•</span>
        <span>Manage Accounts</span>
      </a>
    </nav>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <h1 class="topbar-title">Manage Accounts</h1>
    </div>
    <div class="topbar-right">
      <div class="topbar-user">
        <span class="topbar-user-email" id="userEmail">Loading...</span>
      </div>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="content-container">
      <!-- STATS -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Editors</div>
          <div class="stat-value" id="totalEditors">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active Editors</div>
          <div class="stat-value" id="activeEditors">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total QC Users</div>
          <div class="stat-value" id="totalQC">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active QC Users</div>
          <div class="stat-value" id="activeQC">0</div>
        </div>
      </div>

      <!-- ACCOUNTS TABLE -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Accounts</h2>
          <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterAccounts('all')">All</button>
            <button class="filter-btn" onclick="filterAccounts('editor')">Editors</button>
            <button class="filter-btn" onclick="filterAccounts('qc')">QC Users</button>
            <button class="filter-btn" onclick="filterAccounts('active')">Active Only</button>
          </div>
        </div>
        
        <div id="tableContainer">
          <div class="loading">Loading accounts...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW ACCOUNT MODAL -->
  <div id="viewAccountModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Account Details</h2>
      <div id="accountDetails">
        <div class="modal-section">
          <span class="modal-label">Email (Login)</span>
          <span class="modal-value" id="detailEmail">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Name</span>
          <span class="modal-value" id="detailName">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Role</span>
          <span class="modal-value" id="detailRole">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Status</span>
          <span class="modal-value" id="detailStatus">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Organization</span>
          <span class="modal-value" id="detailOrg">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Created</span>
          <span class="modal-value" id="detailCreated">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Last Login</span>
          <span class="modal-value" id="detailLastLogin">-</span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('viewAccountModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- DELETE ACCOUNT MODAL -->
  <div id="deleteAccountModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">‚ö†Ô∏è Delete Account</h2>
      <p style="margin-bottom: 20px; color: #d9534f; font-weight: 600;">
        This action cannot be undone. The user will be permanently deleted from Memorio and will no longer be able to log in.
      </p>
      <div id="deleteAccountDetails">
        <div class="modal-section">
          <span class="modal-label">Email</span>
          <span class="modal-value" id="deleteEmail">-</span>
        </div>
        <div class="modal-section">
          <span class="modal-label">Role</span>
          <span class="modal-value" id="deleteRole">-</span>
        </div>
      </div>
      <div class="modal-section">
        <span class="modal-label">Reason for deletion (optional)</span>
        <textarea id="deleteReason" class="modal-textarea" placeholder="Why are you deleting this account?"></textarea>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeModal('deleteAccountModal')">Cancel</button>
        <button class="modal-btn danger" onclick="confirmDelete()">Delete Account</button>
      </div>
    </div>
  </div>

  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ============================================================================
    // SUPABASE INITIALIZATION
    // ============================================================================
    
    const SUPABASE_URL = 'https://gkabtvqwwuvigcdubwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrYWJ0dnF3d3V2aWdjZHVid3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDE5MjUsImV4cCI6MjA3NTQ3NzkyNX0.O1DfOR5FBm6r3Pg-tjEE5CkzRr3WlWqGU1xUYKrhtnU';
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        storageKey: 'memorio-admin-auth'
      }
    });

    // ============================================================================
    // GLOBAL STATE
    // ============================================================================
    
    let allAccounts = [];
    let filteredAccounts = [];
    let currentFilter = 'all';
    let currentUser = null;
    let accountToDelete = null;

    // ============================================================================
    // AUTH
    // ============================================================================
    
    async function checkAuth() {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (error || !session) {
        window.location.href = 'login.html';
        return false;
      }
      
      const role = session.user.app_metadata?.role;
      if (role !== 'admin') {
        alert('Access denied. Admin only.');
        window.location.href = '../index.html';
        return false;
      }
      
      currentUser = session.user;
      document.getElementById('userEmail').textContent = currentUser.email;
      
      return true;
    }
    
    async function getValidSession() {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      if (error || !session) {
        window.location.href = 'login.html';
        return null;
      }
      return session;
    }
    
    async function handleLogout() {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    }
    
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'TOKEN_REFRESHED') {
        console.log('‚úÖ Session refreshed successfully');
      }
    });

    // ============================================================================
    // LOAD ACCOUNTS
    // ============================================================================
    
    async function loadAccounts() {
      try {
        const { data: accounts, error } = await supabaseClient
          .from('admin_users_view')  // Use view to bypass RLS
          .select(`
            *,
            organizations (name)
          `)
          .in('role', ['editor', 'qc'])
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allAccounts = accounts || [];
        filteredAccounts = allAccounts;
        
        updateStats();
        renderTable();
        
      } catch (error) {
        console.error('Error loading accounts:', error);
        showToast('Error loading accounts', true);
      }
    }
    
    function updateStats() {
      const editors = allAccounts.filter(a => a.role === 'editor');
      const qcUsers = allAccounts.filter(a => a.role === 'qc');
      
      document.getElementById('totalEditors').textContent = editors.length;
      document.getElementById('activeEditors').textContent = editors.filter(e => e.status === 'active').length;
      document.getElementById('totalQC').textContent = qcUsers.length;
      document.getElementById('activeQC').textContent = qcUsers.filter(q => q.status === 'active').length;
    }

    // ============================================================================
    // FILTERING
    // ============================================================================
    
    function filterAccounts(filter) {
      currentFilter = filter;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Apply filter
      if (filter === 'all') {
        filteredAccounts = allAccounts;
      } else if (filter === 'editor') {
        filteredAccounts = allAccounts.filter(a => a.role === 'editor');
      } else if (filter === 'qc') {
        filteredAccounts = allAccounts.filter(a => a.role === 'qc');
      } else if (filter === 'active') {
        filteredAccounts = allAccounts.filter(a => a.status === 'active');
      }
      
      renderTable();
    }

    // ============================================================================
    // RENDER TABLE
    // ============================================================================
    
    function renderTable() {
      const container = document.getElementById('tableContainer');
      
      if (filteredAccounts.length === 0) {
        container.innerHTML = '<div class="empty-state">No accounts found</div>';
        return;
      }
      
      const tableHTML = `
        <table class="accounts-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th>Organization</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filteredAccounts.map(account => `
              <tr>
                <td>${account.email}</td>
                <td>${account.metadata?.name || '-'}</td>
                <td><span class="role-badge ${account.role}">${account.role.toUpperCase()}</span></td>
                <td>${account.organizations?.name || (account.role === 'qc' ? 'üåç Global' : 'N/A')}</td>
                <td><span class="status-badge ${account.status}">${account.status}</span></td>
                <td>${new Date(account.created_at).toLocaleDateString()}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-view" onclick='viewAccount(${JSON.stringify(account).replace(/'/g, "&apos;")})'>View Details</button>
                    <button class="btn-delete" onclick='openDeleteModal(${JSON.stringify(account).replace(/'/g, "&apos;")})'>Delete</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // ============================================================================
    // VIEW ACCOUNT DETAILS
    // ============================================================================
    
    function viewAccount(account) {
      document.getElementById('detailEmail').textContent = account.email;
      document.getElementById('detailName').textContent = account.metadata?.name || 'Not set';
      document.getElementById('detailRole').textContent = account.role.toUpperCase();
      document.getElementById('detailStatus').textContent = account.status;
      document.getElementById('detailOrg').textContent = account.organizations?.name || (account.role === 'qc' ? 'üåç Global Access' : 'None');
      document.getElementById('detailCreated').textContent = new Date(account.created_at).toLocaleString();
      document.getElementById('detailLastLogin').textContent = account.last_login_at ? new Date(account.last_login_at).toLocaleString() : 'Never';
      
      document.getElementById('viewAccountModal').classList.add('active');
    }

    // ============================================================================
    // DELETE ACCOUNT
    // ============================================================================
    
    function openDeleteModal(account) {
      accountToDelete = account;
      
      document.getElementById('deleteEmail').textContent = account.email;
      document.getElementById('deleteRole').textContent = account.role.toUpperCase();
      document.getElementById('deleteReason').value = '';
      
      document.getElementById('deleteAccountModal').classList.add('active');
    }
    
    async function confirmDelete() {
      if (!accountToDelete) return;
      
      try {
        const reason = document.getElementById('deleteReason').value.trim();
        const session = await getValidSession();
        if (!session) return;
        
        // Call delete-user Edge Function
        const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            user_id: accountToDelete.id,
            reason: reason
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to delete user');
        }
        
        closeModal('deleteAccountModal');
        showToast(`Account ${accountToDelete.email} deleted successfully`);
        
        // Reload accounts
        await loadAccounts();
        
        accountToDelete = null;
        
      } catch (error) {
        console.error('Error deleting account:', error);
        showToast('Error: ' + error.message, true);
      }
    }

    // ============================================================================
    // MODAL CONTROLS
    // ============================================================================
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });

    // ============================================================================
    // TOAST NOTIFICATIONS
    // ============================================================================
    
    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    async function init() {
      const authenticated = await checkAuth();
      if (authenticated) {
        await loadAccounts();
      }
    }
    
    init();
  </script>
</body>
</html>

