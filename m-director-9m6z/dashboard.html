<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Director Dashboard - Memorio</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Preload Dosis font -->
  <link rel="preload" href="../fonts/Dosis-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/memorio-forms.webflow.css" rel="stylesheet" type="text/css">
  <link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  
  <!-- i18n (Internationalization) Support -->
  <script src="../js/i18n.js"></script>
  
  <style>
    /* ============================================================================
       DESIGN SYSTEM - MEMORIO ENTERPRISE
       Apple-inspired, shadcn aesthetic
       ============================================================================ */
    :root {
      /* Colors - Memorio Brand Palette */
      --color-primary: #436481;
      --color-primary-hover: #1e3a52;
      --color-primary-light: #6ca7d3;
      --color-background: #f2eadd;
      --color-surface: #fff3e9;
      --color-surface-hover: #f4e8de;
      --color-text: #32343a;
      --color-text-muted: rgba(50, 52, 58, 0.6);
      --color-border: #436481;
      --color-border-light: rgba(67, 100, 129, 0.2);
      
      /* Spacing System (4px base) */
      --space-1: 0.25rem;  /* 4px */
      --space-2: 0.5rem;   /* 8px */
      --space-3: 0.75rem;  /* 12px */
      --space-4: 1rem;     /* 16px */
      --space-5: 1.25rem;  /* 20px */
      --space-6: 1.5rem;   /* 24px */
      --space-8: 2rem;     /* 32px */
      --space-10: 2.5rem;  /* 40px */
      --space-12: 3rem;    /* 48px */
      --space-16: 4rem;    /* 64px */
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Shadows (Apple-style subtle) */
      --shadow-sm: 0 1px 2px 0 rgba(67, 100, 129, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(67, 100, 129, 0.08), 0 2px 4px -1px rgba(67, 100, 129, 0.04);
      --shadow-lg: 0 10px 15px -3px rgba(67, 100, 129, 0.1), 0 4px 6px -2px rgba(67, 100, 129, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(67, 100, 129, 0.1), 0 10px 10px -5px rgba(67, 100, 129, 0.04);
      
      /* Typography (Apple System Fonts) */
      --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
      --font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Z-index Scale */
      --z-base: 1;
      --z-dropdown: 1000;
      --z-sticky: 1020;
      --z-fixed: 1030;
      --z-modal-backdrop: 1040;
      --z-modal: 1050;
      --z-toast: 1060;
    }
    
    /* ============================================================================
       GLOBAL RESETS
       ============================================================================ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-sans);
      background-color: var(--color-background);
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 15px;
      line-height: 1.6;
    }
    
    /* ============================================================================
       TOP NAVBAR - MODERN ENTERPRISE DESIGN
       ============================================================================ */
    .topbar {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      height: 64px;
      background-color: rgba(255, 243, 233, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--color-border-light);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-8);
      z-index: var(--z-fixed);
    }
    
    .topbar-left {
      display: flex;
      align-items: center;
      gap: var(--space-10);
    }
    
    .topbar-logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      text-decoration: none;
    }
    
    .topbar-logo img {
      height: 32px;
      width: auto;
    }
    
    .topbar-logo-text {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text);
      letter-spacing: -0.5px;
    }
    
    .topbar-nav {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .topbar-nav-item {
      padding: var(--space-2) var(--space-4);
      color: var(--color-text-muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      cursor: pointer;
      background: transparent;
      border: none;
    }
    
    .topbar-nav-item:hover {
      color: var(--color-text);
      background-color: var(--color-surface-hover);
    }
    
    .topbar-nav-item.active {
      color: var(--color-primary);
      background-color: var(--color-surface);
    }
    
    .topbar-center {
      flex: 1;
      max-width: 480px;
      margin: 0 auto;
    }
    
    .topbar-search {
      position: relative;
      width: 100%;
    }
    
    .topbar-search-icon {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      opacity: 0.5;
      pointer-events: none;
    }
    
    .topbar-search-input {
      width: 100%;
      padding: var(--space-2) var(--space-4) var(--space-2) var(--space-10);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-full);
      background-color: var(--color-surface);
      font-family: var(--font-sans);
      font-size: 14px;
      transition: all var(--transition-fast);
      color: var(--color-text);
    }
    
    .topbar-search-input:focus {
      outline: none;
      border-color: var(--color-primary);
      background-color: #ffffff;
      box-shadow: 0 0 0 3px rgba(67, 100, 129, 0.1);
    }
    
    .topbar-search-input::placeholder {
      color: var(--color-text-muted);
    }
    
    .topbar-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .funeral-home-badge {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
      color: var(--color-primary);
    }
    
    .topbar-profile {
      position: relative;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-3) var(--space-1) var(--space-1);
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .topbar-profile:hover {
      background-color: var(--color-surface-hover);
      border-color: var(--color-primary-light);
    }
    
    .topbar-profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      color: white;
    }
    
    .topbar-profile-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .topbar-profile-chevron {
      width: 16px;
      height: 16px;
      opacity: 0.5;
      transition: transform var(--transition-fast);
    }
    
    .topbar-profile.open .topbar-profile-chevron {
      transform: rotate(180deg);
    }
    
    .topbar-profile-dropdown {
      position: absolute;
      top: calc(100% + var(--space-2));
      right: 0;
      width: 100%;
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all var(--transition-base);
      z-index: var(--z-dropdown);
      overflow: hidden;
    }
    
    /* ============================================================================
       LANGUAGE TOGGLE - MODERN PILL DESIGN
       ============================================================================ */
    .language-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-full);
      padding: var(--space-1);
      box-shadow: var(--shadow-sm);
    }
    
    .language-toggle-btn {
      padding: var(--space-2) var(--space-4);
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      background: transparent;
      border: none;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .language-toggle-btn:hover {
      background-color: rgba(67, 100, 129, 0.1);
    }
    
    .language-toggle-btn.active {
      background-color: var(--color-primary);
      color: white;
      font-weight: 600;
    }
    
    .topbar-profile.open .topbar-profile-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .topbar-profile-dropdown-item {
      padding: var(--space-3) var(--space-4);
      color: var(--color-text);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }
    
    .topbar-profile-dropdown-item:hover {
      background-color: var(--color-surface-hover);
      color: var(--color-primary);
    }
    
    .topbar-profile-dropdown-item svg {
      width: 16px;
      height: 16px;
      opacity: 0.6;
    }
    
    .topbar-profile-dropdown-divider {
      height: 1px;
      background-color: var(--color-border-light);
      margin: var(--space-2) 0;
    }
    
    
    /* ============================================================================
       MAIN CONTENT AREA
       ============================================================================ */
    .main-content {
      margin-top: 64px;
      padding: var(--space-8);
      min-height: calc(100vh - 64px);
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .page-header {
      margin-bottom: var(--space-8);
    }
    
    .page-title {
      font-size: 32px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 var(--space-2) 0;
      letter-spacing: -0.5px;
    }
    
    .page-description {
      font-size: 15px;
      color: var(--color-text-muted);
      margin: 0;
    }
    
    /* ============================================================================
       COMPONENT LIBRARY - shadcn/ui inspired
       ============================================================================ */
    
    /* Card Component */
    .card {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: all var(--transition-base);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .card-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0;
      letter-spacing: -0.3px;
    }
    
    .card-description {
      font-size: 14px;
      color: var(--color-text-muted);
      margin: var(--space-1) 0 0 0;
      line-height: 1.5;
    }
    
    .card-content {
      padding: var(--space-6);
    }
    
    .card-footer {
      padding: var(--space-6);
      border-top: 1px solid var(--color-border-light);
      background-color: rgba(67, 100, 129, 0.02);
    }
    
    /* Button Component */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 500;
      line-height: 1;
      white-space: nowrap;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      cursor: pointer;
      border: 1px solid transparent;
      text-decoration: none;
      min-height: 40px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* Button Sizes */
    .btn-sm {
      height: 32px;
      padding: 0 var(--space-3);
      font-size: 13px;
    }
    
    .btn-md {
      height: 40px;
      padding: 0 var(--space-4);
    }
    
    .btn-lg {
      height: 48px;
      padding: 0 var(--space-6);
      font-size: 15px;
    }
    
    /* Button Variants */
    .btn-primary {
      background-color: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: var(--color-primary-hover);
      border-color: var(--color-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-secondary {
      background-color: transparent;
      color: var(--color-text);
      border-color: var(--color-border);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: var(--color-surface-hover);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    .btn-ghost {
      background-color: transparent;
      color: var(--color-text);
      border-color: transparent;
    }
    
    .btn-ghost:hover:not(:disabled) {
      background-color: var(--color-surface-hover);
      color: var(--color-primary);
    }
    
    .btn-danger {
      background-color: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    
    .btn-danger:hover:not(:disabled) {
      background-color: #b91c1c;
      border-color: #b91c1c;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    /* Badge Component */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 500;
      line-height: 1;
      white-space: nowrap;
    }
    
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    
    /* Badge Variants */
    .badge-default {
      background-color: var(--color-surface-hover);
      color: var(--color-text);
      border: 1px solid var(--color-border-light);
    }
    
    .badge-primary {
      background-color: rgba(67, 100, 129, 0.1);
      color: var(--color-primary);
      border: 1px solid rgba(67, 100, 129, 0.2);
    }
    
    .badge-success {
      background-color: rgba(34, 197, 94, 0.1);
      color: #15803d;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .badge-warning {
      background-color: rgba(251, 146, 60, 0.1);
      color: #c2410c;
      border: 1px solid rgba(251, 146, 60, 0.2);
    }
    
    .badge-danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .badge-info {
      background-color: rgba(59, 130, 246, 0.1);
      color: #1d4ed8;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    /* Input Component */
    .input {
      width: 100%;
      height: 40px;
      padding: 0 var(--space-3);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      background-color: var(--color-surface);
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text);
      transition: all var(--transition-fast);
    }
    
    .input:focus {
      outline: none;
      border-color: var(--color-primary);
      background-color: white;
      box-shadow: 0 0 0 3px rgba(67, 100, 129, 0.1);
    }
    
    .input::placeholder {
      color: var(--color-text-muted);
    }
    
    .input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Select Component */
    .select {
      width: 100%;
      height: 40px;
      padding: 0 var(--space-3);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      background-color: var(--color-surface);
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--color-text);
      transition: all var(--transition-fast);
      cursor: pointer;
    }
    
    .select:focus {
      outline: none;
      border-color: var(--color-primary);
      background-color: white;
      box-shadow: 0 0 0 3px rgba(67, 100, 129, 0.1);
    }
    
    /* Label Component */
    .label {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-2);
      display: block;
    }
    
    /* Separator */
    .separator {
      height: 1px;
      background-color: var(--color-border-light);
      border: none;
      margin: var(--space-6) 0;
    }
    
    /* ============================================================================
       CONTENT SECTIONS
       ============================================================================ */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    /* Action Cards - Enhanced Design */
    .action-card {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-base);
    }
    
    .action-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    /* ============================================================================
       FORMS - MODERN DESIGN
       ============================================================================ */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .form-row-single {
      margin-bottom: var(--space-4);
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }
    
    .form-input {
      height: 40px;
      padding: 0 var(--space-3);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 14px;
      background-color: var(--color-surface);
      color: var(--color-text);
      transition: all var(--transition-fast);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      background-color: white;
      box-shadow: 0 0 0 3px rgba(67, 100, 129, 0.1);
    }
    
    .form-input::placeholder {
      color: var(--color-text-muted);
    }
    
    select.form-input {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2332343a' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
      background-position: right var(--space-2) center;
      background-repeat: no-repeat;
      background-size: 20px;
      padding-right: var(--space-8);
    }
    
    /* ============================================================================
       SUCCESS/ERROR BOXES - MODERN DESIGN
       ============================================================================ */
    .success-box {
      background-color: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-top: var(--space-5);
      display: none;
    }
    
    .success-box h3 {
      color: #15803d;
      margin: 0 0 var(--space-3) 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .success-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2315803d'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .success-box p {
      color: #15803d;
      margin: 0 0 var(--space-4) 0;
      font-size: 14px;
    }
    
    .credential-box {
      background-color: var(--color-surface-hover);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
    }
    
    .credential-label {
      font-size: 11px;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-1);
      font-weight: 500;
    }
    
    .credential-value {
      color: var(--color-text);
      font-size: 14px;
      font-weight: 600;
      word-break: break-all;
      font-family: var(--font-mono);
    }
    
    .copy-btn {
      background-color: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: var(--space-1) var(--space-3);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      margin-top: var(--space-2);
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .copy-btn:hover {
      background-color: var(--color-primary-hover);
    }
    
    .error-box {
      background-color: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      color: #dc2626;
      margin-top: var(--space-5);
      display: none;
      font-weight: 500;
      font-size: 14px;
    }
    
    /* ============================================================================
       CASES LIST VIEW - MODERN DESIGN
       ============================================================================ */
    .cases-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .case-row {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      cursor: pointer;
      transition: all var(--transition-base);
    }
    
    .case-row:hover {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .case-row-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .case-row-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0;
    }
    
    .case-row-meta {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      font-size: 13px;
      color: var(--color-text-muted);
    }
    
    .case-row-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .case-row-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .case-row-date {
      font-size: 13px;
      color: var(--color-text-muted);
      min-width: 100px;
      text-align: right;
    }
    
    .case-empty-state {
      text-align: center;
      padding: var(--space-16) var(--space-8);
    }
    
    .case-empty-state-icon {
      width: 48px;
      height: 48px;
      margin-bottom: var(--space-4);
      opacity: 0.3;
      color: var(--color-text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .case-empty-state-icon svg {
      width: 100%;
      height: 100%;
    }
    
    .case-empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 var(--space-2) 0;
    }
    
    .case-empty-state-description {
      font-size: 14px;
      color: var(--color-text-muted);
      margin: 0;
    }
    
    /* Legacy grid styles (keeping for backwards compat) */
    .cases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .case-card {
      background-color: #f4e8de;
      border: 2px solid #436481;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .case-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(67, 100, 129, 0.2);
      border-color: #6ca7d3;
    }
    
    .case-name {
      color: #32343a;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .case-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    
    .status-created {
      background-color: #fff3e0;
      color: #e65100;
      border: 1px solid #e65100;
    }
    
    .status-waiting {
      background-color: #e3f2fd;
      color: #01579b;
      border: 1px solid #01579b;
    }
    
    .status-submitted {
      background-color: #e8f5e9;
      color: #1b5e20;
      border: 1px solid #1b5e20;
    }
    
    .case-meta {
      font-size: 13px;
      color: #32343a;
      opacity: 0.6;
      margin: 8px 0;
    }
    
    /* ============================================================================
       SLA BADGES
       ============================================================================ */
    .sla-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      white-space: nowrap;
    }
    
    .sla-badge.green {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #66bb6a;
    }
    
    .sla-badge.orange {
      background-color: #fff3e0;
      color: #e65100;
      border: 1px solid #ff9800;
    }
    
    .sla-badge.red {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    
    .sla-badge.black {
      background-color: #212121;
      color: #ffffff;
      border: 1px solid #000000;
      font-weight: 700;
    }
    
    .sla-badge.waiting {
      background-color: #f5f5f5;
      color: #757575;
      border: 1px solid #e0e0e0;
    }
    
    /* ============================================================================
       MODALS - MODERN DESIGN WITH BACKDROP BLUR
       ============================================================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: var(--z-modal-backdrop);
      opacity: 0;
      transition: opacity var(--transition-base);
    }
    
    .modal-overlay.show {
      opacity: 1;
    }
    
    .modal-content {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      max-width: 1200px;
      width: 92%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      transform: scale(0.95) translateY(20px);
      transition: transform var(--transition-base);
    }
    
    .modal-overlay.show .modal-content {
      transform: scale(1) translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-6);
      border-bottom: 1px solid var(--color-border-light);
      background-color: rgba(67, 100, 129, 0.02);
    }
    
    .modal-title {
      color: var(--color-text);
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.3px;
    }
    
    .modal-close {
      background: transparent;
      border: 1px solid var(--color-border-light);
      font-size: 20px;
      color: var(--color-text-muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      font-weight: 400;
    }
    
    .modal-close:hover {
      background-color: var(--color-surface-hover);
      color: var(--color-text);
      border-color: var(--color-primary);
    }
    
    .modal-body {
      padding: var(--space-8);
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    /* Custom scrollbar for modal */
    .modal-body::-webkit-scrollbar {
      width: 8px;
    }
    
    .modal-body::-webkit-scrollbar-track {
      background: var(--color-surface-hover);
      border-radius: var(--radius-sm);
    }
    
    .modal-body::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: var(--radius-sm);
    }
    
    .modal-body::-webkit-scrollbar-thumb:hover {
      background: var(--color-primary-dark);
    }
    
    .modal-footer {
      padding: var(--space-6);
      border-top: 1px solid var(--color-border-light);
      background-color: rgba(67, 100, 129, 0.02);
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
    }
    
    .modal-section {
      margin-bottom: var(--space-6);
    }
    
    .modal-section:last-child {
      margin-bottom: 0;
    }
    
    .modal-section-title {
      color: var(--color-text);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .modal-info-item {
      background-color: var(--color-surface-hover);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-light);
    }
    
    .modal-info-label {
      font-size: 11px;
      color: var(--color-text-muted);
      font-weight: 500;
      text-transform: uppercase;
      margin-bottom: var(--space-1);
      letter-spacing: 0.5px;
    }
    
    .modal-info-value {
      font-size: 14px;
      color: var(--color-text);
      font-weight: 600;
    }
    
    #modal-case-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    #modal-case-status svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    
    .credentials-section {
      background-color: var(--color-surface-hover);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-top: var(--space-4);
    }
    
    .credentials-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    
    .credentials-title {
      color: var(--color-text);
      font-size: 15px;
      font-weight: 600;
      margin: 0;
    }
    
    .reveal-btn {
      background-color: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: var(--space-2) var(--space-3);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .reveal-btn:hover {
      background-color: var(--color-primary-hover);
      transform: translateY(-1px);
    }
    
    .credentials-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-3);
    }
    
    .credential-item {
      background-color: white;
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      padding: var(--space-3);
    }
      border-radius: 8px;
      padding: 12px;
    }
    
    .credential-value.blurred {
      filter: blur(8px);
      user-select: none;
    }
    
    /* ============================================================================
       TOAST NOTIFICATIONS
       ============================================================================ */
    .toast {
      position: fixed;
      top: 90px;
      right: 20px;
      background-color: #28a745;
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 3000;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.error {
      background-color: #dc3545;
    }
    
    /* ============================================================================
       RESPONSIVE DESIGN
       ============================================================================ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .topbar {
        left: 0;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .modal-info-grid {
        grid-template-columns: 1fr;
      }
      
      .credentials-grid {
        grid-template-columns: 1fr;
      }
      
      .cases-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Loading state */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Security: Hide content until auth verified (prevents page flash) */
    body.auth-pending {
      opacity: 0;
      pointer-events: none;
    }
    
    body.auth-verified {
      opacity: 1;
      pointer-events: auto;
      transition: opacity 0.2s ease-in;
    }
  </style>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="auth-pending">
  <!-- ============================================================================
       TOP NAVBAR - MODERN DESIGN
       ============================================================================ -->
  <div class="topbar">
    <div class="topbar-left">
      <a href="#" class="topbar-logo">
        <img src="../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png" alt="Memorio">
      </a>
      
      <nav class="topbar-nav">
        <button class="topbar-nav-item active" onclick="switchSection('create-case')" data-i18n="director.createCase">Create Case</button>
        <button class="topbar-nav-item" onclick="switchSection('invite-family')" data-i18n="director.inviteFamily">Invite Family</button>
        <button class="topbar-nav-item" onclick="switchSection('my-cases')" data-i18n="director.myCases">My Cases</button>
      </nav>
    </div>
    
    <div class="topbar-center">
      <div class="topbar-search">
        <svg class="topbar-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input type="text" class="topbar-search-input" placeholder="Search cases..." id="search-input">
      </div>
    </div>
    
    <div class="topbar-right">
      <div class="funeral-home-badge">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
        </svg>
        <span id="funeral-home-name">Loading...</span>
      </div>
      
      <!-- Language Toggle -->
      <div class="language-toggle">
        <button class="language-toggle-btn active" data-lang-btn="en" title="English">EN</button>
        <button class="language-toggle-btn" data-lang-btn="es" title="EspaÃ±ol">ES</button>
      </div>
      
      <div class="topbar-profile" id="profile-toggle">
        <div class="topbar-profile-avatar">D</div>
        <span class="topbar-profile-name">Director</span>
        <svg class="topbar-profile-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7 10l5 5 5-5z"/>
        </svg>
        <div class="topbar-profile-dropdown">
          <button class="topbar-profile-dropdown-item" id="logout-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            <span data-i18n="common.logout">Logout</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       MAIN CONTENT
       ============================================================================ -->
  <div class="main-content">
    
    <!-- CREATE CASE SECTION -->
    <div id="create-case-section" class="content-section active">
      <div class="page-header">
        <h1 class="page-title" data-i18n="director.createCase">Create New Case</h1>
        <p class="page-description" data-i18n="director.createCaseDesc">Start a new memorial tribute case by providing the loved one's information.</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Loved One's Information</h3>
          <p class="card-description">All fields are required to ensure complete obituary generation</p>
        </div>
        <div class="card-content">
          <form id="create-case-form">
            <!-- Full Name -->
            <div class="form-row-single">
              <div class="form-group">
                <label for="deceased-name" class="label">Full Name of Loved One</label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-name" 
                  placeholder="John Michael Doe" 
                  required>
              </div>
            </div>
            
            <!-- Gender -->
            <div class="form-row-single">
              <div class="form-group">
                <label for="deceased-gender" class="label" data-i18n="director.gender">Gender</label>
                <select class="select" id="deceased-gender" required>
                  <option value="" data-i18n="director.gender.select">Select Gender</option>
                  <option value="male" data-i18n="director.gender.male">Male</option>
                  <option value="female" data-i18n="director.gender.female">Female</option>
                  <option value="other" data-i18n="director.gender.other">Other</option>
                </select>
              </div>
            </div>
            
            <!-- Custom Gender Input (shown when "Other" is selected) -->
            <div class="form-row-single" id="custom-gender-container" style="display: none;">
              <div class="form-group">
                <label for="deceased-gender-custom" class="label" data-i18n="director.gender.specify">Please Specify Gender/Pronouns</label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-gender-custom" 
                  placeholder="e.g., Non-binary, They/Them, etc.">
                <small style="color: rgba(50, 52, 58, 0.6); font-size: 12px; display: block; margin-top: 4px;" data-i18n="director.gender.specifyHelper">
                  This will be used in the memorial tribute
                </small>
              </div>
            </div>
            
            <!-- Date of Birth & Date of Death -->
            <div class="form-row">
              <div class="form-group">
                <label for="deceased-dob" class="label" data-i18n="director.dateOfBirth">Date of Birth</label>
                <input 
                  class="input" 
                  type="date" 
                  id="deceased-dob" 
                  required>
              </div>
              <div class="form-group">
                <label for="deceased-dod" class="label" data-i18n="director.dateOfPassing">Date of Passing</label>
                <input 
                  class="input" 
                  type="date" 
                  id="deceased-dod" 
                  required>
              </div>
            </div>
            
            <!-- Birth Location -->
            <div class="form-row" style="display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: var(--space-4);">
              <div class="form-group">
                <label for="deceased-birth-city" class="label" data-i18n="director.cityOfBirth">City of Birth</label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-birth-city" 
                  placeholder="New York" 
                  required>
              </div>
              <div class="form-group">
                <label for="deceased-birth-state" class="label" data-i18n="director.stateOfBirth">State/Province of Birth <span style="font-weight:400; color: rgba(50,52,58,0.5); font-size: 13px;">(optional)</span></label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-birth-state" 
                  placeholder="e.g. New York, Greater Manchester (leave blank if N/A)">
              </div>
              <div class="form-group">
                <label for="deceased-birth-country" class="label" data-i18n="director.countryOfBirth">Country of Birth</label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-birth-country" 
                  value="United States" 
                  placeholder="United States" 
                  required>
              </div>
            </div>
            
            <!-- Death Location -->
            <div class="form-row" style="display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: var(--space-4);">
              <div class="form-group">
                <label for="deceased-death-city" class="label" data-i18n="director.cityOfDeath">City of Passing</label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-death-city" 
                  placeholder="Los Angeles" 
                  required>
              </div>
              <div class="form-group">
                <label for="deceased-death-state" class="label" data-i18n="director.stateOfDeath">State/Province of Passing <span style="font-weight:400; color: rgba(50,52,58,0.5); font-size: 13px;">(optional)</span></label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-death-state" 
                  placeholder="e.g. California, Greater Manchester (leave blank if N/A)">
              </div>
              <div class="form-group">
                <label for="deceased-death-country" class="label" data-i18n="director.countryOfDeath">Country of Passing</label>
                <input 
                  class="input" 
                  type="text" 
                  id="deceased-death-country" 
                  value="United States" 
                  placeholder="United States" 
                  required>
              </div>
            </div>
            
            <!-- Service Date -->
          <div class="form-row-single">
            <div class="form-group">
              <label for="deceased-service-date" class="label">Service Date</label>
              <input 
                class="input" 
                type="date" 
                id="deceased-service-date" 
                required>
            </div>
          </div>
        </form>
      </div>
      
      <div class="card-footer">
        <button type="submit" form="create-case-form" class="btn btn-primary btn-lg" id="create-case-btn" data-i18n="director.createCaseBtn">
          CREATE CASE
        </button>
      </div>
    </div>
      
      <!-- Success Message -->
      <div id="case-success-box" class="success-box">
        <h3><span class="success-icon"></span><span data-i18n="director.caseCreatedSuccess">Case Created Successfully!</span></h3>
        <p data-i18n="director.caseCreatedDesc">Case ID has been generated. You can now invite the family to complete the tribute form.</p>
        
        <div class="credential-box">
          <div class="credential-label" data-i18n="director.caseID">Case ID</div>
          <div class="credential-value" id="created-case-id"></div>
          <button class="copy-btn" onclick="copyToClipboard('created-case-id')" data-i18n="director.copyBtn">Copy</button>
        </div>
      </div>
      
      <!-- Error Message -->
      <div id="case-error-box" class="error-box"></div>
    </div>

    <!-- INVITE FAMILY SECTION -->
    <div id="invite-family-section" class="content-section">
      <div class="page-header">
        <h1 class="page-title" data-i18n="director.inviteFamilyTitle">Invite Family Member</h1>
        <p class="page-description" data-i18n="director.inviteFamilyDesc">Send a secure invitation to a family member to complete the tribute form for their case.</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title" data-i18n="director.familyMemberDetails">Family Member Details</h3>
          <p class="card-description" data-i18n="director.familyMemberDetailsDesc">Provide contact information and associate with a case ID</p>
        </div>
        <div class="card-content">
          <form id="invite-family-form">
            <div class="form-row">
              <div class="form-group">
                <label for="family-email" class="label" data-i18n="director.emailAddress">Email Address</label>
                <input 
                  class="input" 
                  type="email" 
                  id="family-email" 
                  placeholder="family@example.com" 
                  required>
              </div>
              
              <div class="form-group">
                <label for="family-name" class="label" data-i18n="director.fullName">Full Name</label>
                <input 
                  class="input" 
                  type="text" 
                  id="family-name" 
                  placeholder="Jane Doe" 
                  required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="family-phone" class="label" data-i18n="director.phoneNumber">Phone Number (Optional)</label>
                <input 
                  class="input" 
                  type="tel" 
                  id="family-phone" 
                  placeholder="+1-555-0123">
              </div>
              
              <div class="form-group">
                <label for="case-id" class="label" data-i18n="director.caseID">Case ID</label>
                <input 
                  class="input" 
                  type="text" 
                  id="case-id" 
                  placeholder="Paste Case ID here" 
                  required>
              </div>
            </div>
          </form>
        </div>
        
        <div class="card-footer">
          <button type="submit" form="invite-family-form" class="btn btn-primary btn-lg" id="invite-family-btn" data-i18n="director.sendInvitation">
            Send Invitation
          </button>
        </div>
      </div>
      
      <!-- Success Message -->
      <div id="family-success-box" class="success-box">
        <h3><span class="success-icon"></span>Family Member Invited Successfully!</h3>
        <p>Share these credentials with the family member. They will need them to access the tribute form.</p>
        
        <div class="credential-box">
          <div class="credential-label">Email Address</div>
          <div class="credential-value" id="invited-email"></div>
          <button class="copy-btn" onclick="copyToClipboard('invited-email')">Copy</button>
        </div>
        
        <div class="credential-box">
          <div class="credential-label">Temporary Password</div>
          <div class="credential-value" id="family-password"></div>
          <button class="copy-btn" onclick="copyToClipboard('family-password')">Copy</button>
        </div>
      </div>
      
      <!-- Error Message -->
      <div id="family-error-box" class="error-box"></div>
    </div>

    <!-- MY CASES SECTION -->
    <div id="my-cases-section" class="content-section">
      <div class="page-header">
        <h1 class="page-title" data-i18n="director.myCases">My Cases</h1>
        <p class="page-description" data-i18n="director.myCasesDesc">View and manage all memorial tribute cases for your organization.</p>
      </div>
      
      <div id="cases-list" class="cases-list">
        <!-- Cases will be loaded here dynamically -->
      </div>
      
      <div id="cases-error-box" class="error-box"></div>
    </div>
  </div>

  <!-- ============================================================================
       PASSWORD CHANGE MODAL (First Login)
       ============================================================================ -->
  <div id="password-change-modal" class="modal-overlay" style="display: none; z-index: 9999;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" style="border-bottom: 2px solid #436481;">
        <h2 class="modal-title" data-i18n="director.changePassword">Change Your Password</h2>
      </div>
      
      <div style="padding: 24px;">
        <p style="margin-bottom: 20px; color: #32343a; font-size: 15px;" data-i18n="director.changePasswordDesc">
          For security reasons, you must change your temporary password before accessing the dashboard.
        </p>
        
        <form id="password-change-form">
          <div class="form-group">
            <label for="new-password" class="form-label" data-i18n="director.newPassword">New Password*</label>
            <input 
              class="form-input" 
              type="password" 
              id="new-password" 
              placeholder="Enter new password" 
              minlength="8"
              required>
            <small style="color: rgba(50, 52, 58, 0.6); font-size: 12px; display: block; margin-top: 4px;" data-i18n="director.passwordMinLength">
              Must be at least 8 characters
            </small>
          </div>
          
          <div class="form-group">
            <label for="confirm-password" class="form-label" data-i18n="director.confirmPassword">Confirm New Password*</label>
            <input 
              class="form-input" 
              type="password" 
              id="confirm-password" 
              placeholder="Confirm new password" 
              minlength="8"
              required>
          </div>
          
          <div id="password-error" class="error-box" style="display: none; margin-bottom: 16px;"></div>
          
          <button type="submit" class="btn-primary" id="change-password-btn" style="
            width: 100%;
            border-radius: 9999px;
            padding: 14px 28px;
            margin-top: 8px;
            font-weight: 600;
            letter-spacing: 0.5px;
          " data-i18n="director.changePasswordBtn">
            CHANGE PASSWORD
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       CASE DETAILS MODAL
       ============================================================================ -->
  <div id="case-details-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-case-name">Case Details</h2>
        <button class="modal-close" onclick="closeCaseModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="modal-section">
        <h3 class="modal-section-title">Case Information</h3>
        <div class="modal-info-grid">
          <div class="modal-info-item">
            <div class="modal-info-label">Case ID</div>
            <div class="modal-info-value" id="modal-case-id" style="font-size: 11px; word-break: break-all;">-</div>
            <button class="copy-btn" onclick="copyToClipboard('modal-case-id')">Copy Full ID</button>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Status</div>
            <div class="modal-info-value" id="modal-case-status">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Created</div>
            <div class="modal-info-value" id="modal-case-created">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Service Date</div>
            <div class="modal-info-value" id="modal-case-service-date">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Last Updated</div>
            <div class="modal-info-value" id="modal-case-updated">-</div>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">Family Information</h3>
        <div class="modal-info-grid">
          <div class="modal-info-item">
            <div class="modal-info-label">Family Member</div>
            <div class="modal-info-value" id="modal-family-name">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Email</div>
            <div class="modal-info-value" id="modal-family-email">-</div>
          </div>
        </div>
        
        <div class="credentials-section">
          <div class="credentials-header">
            <h4 class="credentials-title">Family Login Credentials</h4>
            <button class="reveal-btn" id="reveal-credentials-btn" onclick="revealCredentials()">Reveal</button>
          </div>
          <div class="credentials-grid">
            <div class="credential-item">
              <div class="credential-label">Email</div>
              <div class="credential-value blurred" id="modal-family-login-email">Click Reveal</div>
              <button class="copy-btn" onclick="copyToClipboard('modal-family-login-email')">Copy</button>
            </div>
            <div class="credential-item">
              <div class="credential-label">Password</div>
              <div class="credential-value blurred" id="modal-family-password">Click Reveal</div>
              <button class="copy-btn" onclick="copyToClipboard('modal-family-password')">Copy</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">Form Status</h3>
        <div class="modal-info-grid">
          <div class="modal-info-item">
            <div class="modal-info-label">Form Status</div>
            <div class="modal-info-value" id="modal-form-status">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Submitted At</div>
            <div class="modal-info-value" id="modal-form-submitted">-</div>
          </div>
        </div>
      </div>
      
      <!-- Obituary Section (Only shown when draft exists) -->
      <div class="modal-section" id="obituary-section" style="display: none;">
        <h3 class="modal-section-title" id="obituary-section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          Obituary Draft
        </h3>
        <div style="
          background-color: #f4e8de;
          border: 1.5px solid #436481;
          border-radius: 8px;
          padding: 20px;
          max-height: 400px;
          overflow-y: auto;
        ">
          <div id="obituary-content" style="
            font-size: 15px;
            line-height: 1.8;
            color: #32343a;
          ">
            <!-- Obituary HTML will be inserted here -->
          </div>
        </div>
        <div style="margin-top: 12px; font-size: 13px; color: rgba(50, 52, 58, 0.6);">
          Last updated: <span id="obituary-updated">-</span>
        </div>
      </div>
      
      <!-- Photos & Assets Section -->
      <div class="modal-section" id="photos-section" style="display: none;">
        <h3 class="modal-section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21,15 16,10 5,21"></polyline>
          </svg>
          Photos & Assets
        </h3>
        
        <!-- Upload Timer Banner -->
        <div id="director-upload-timer-banner" style="display: none; margin-bottom: 16px;">
          <!-- Timer will be populated here -->
        </div>
        
        <!-- Upload Area -->
        <div id="director-upload-area" style="margin-bottom: 20px;">
          <div style="
            border: 2px dashed #436481;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background-color: #f4e8de;
          ">
            <input type="file" id="director-photo-input" accept="image/*" multiple style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('director-photo-input').click()" id="director-upload-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              Upload Photos
            </button>
            <p style="margin-top: 12px; color: #666; font-size: 14px;">
              Click to select photos (JPEG, PNG, GIF)
            </p>
          </div>
        </div>
        
        <!-- Photos Grid -->
        <div id="director-photos-grid" style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 12px;
          max-height: 400px;
          overflow-y: auto;
        ">
          <!-- Photos will be populated here -->
        </div>
        
        <div id="director-no-photos" style="text-align: center; padding: 20px; color: #666;">
          No photos uploaded yet
        </div>
      </div>
      
      <!-- Delivered Banner (Only shown when case is delivered) -->
      <div id="delivered-banner" style="display: none; margin-bottom: 24px;">
        <div style="
          background: linear-gradient(135deg, #28a745 0%, #218838 100%);
          border-radius: 12px;
          padding: 24px;
          text-align: center;
          color: white;
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        ">
          <h3 style="font-size: 22px; font-weight: 700; margin: 0 0 8px 0;">
            Memorial Complete
          </h3>
          <p style="font-size: 16px; margin: 0; opacity: 0.95;">
            The obituary and video have been delivered to the family
          </p>
        </div>
      </div>
      
      <!-- Downloads Section (Only shown when delivered) -->
      <div class="modal-section" id="downloads-section" style="display: none;">
        <h3 class="modal-section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Downloads
        </h3>
        <div style="display: flex; flex-direction: column; gap: var(--space-3); align-items: flex-start;">
          <button class="btn btn-primary" onclick="directorDownloadVideo()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Download Memorial Video
          </button>
          <button class="btn btn-primary" onclick="directorDownloadObituaryPDF()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10,9 9,9 8,9"/>
            </svg>
            Download Obituary PDF
          </button>
        </div>
      </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeCaseModal()">Close</button>
        <button class="btn btn-danger" onclick="deleteCase(currentCaseDetails.id, currentCaseDetails.deceased_name)">
          Delete Case
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 460px;">
      <div class="modal-header" style="border-bottom: 1px solid var(--color-border); padding: 24px 28px 20px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: #fee2e2; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          <h2 class="modal-title" id="confirm-modal-title" style="font-size: 17px; font-weight: 600; margin: 0;">Confirm Action</h2>
        </div>
      </div>
      
      <div style="padding: 24px 28px;">
        <p id="confirm-modal-message" style="color: var(--color-text-secondary); font-size: 14px; line-height: 1.7; margin: 0; white-space: pre-line;"></p>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 28px 24px; border-top: 1px solid var(--color-border);">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
        <button id="confirm-modal-action-btn" class="btn btn-danger">Delete Case</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://gkabtvqwwuvigcdubwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrYWJ0dnF3d3V2aWdjZHVid3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDE5MjUsImV4cCI6MjA3NTQ3NzkyNX0.O1DfOR5FBm6r3Pg-tjEE5CkzRr3WlWqGU1xUYKrhtnU';
    
    const { createClient } = supabase;
    
    // Initialize Supabase client with proper session persistence
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,           // Automatically refresh token before expiry
        persistSession: true,              // Persist session to localStorage
        detectSessionInUrl: true,          // Detect OAuth sessions in URL
        storage: window.localStorage,      // Use localStorage for session persistence
        storageKey: 'memorio-director-auth', // Unique key per portal
      }
    });
    
    // Global auth state
    let isAuthenticated = false;
    let currentSession = null;
    let currentCaseDetails = null;
    let credentialsRevealed = false;
    let allCases = []; // Store all cases for filtering
    let directorUploadTimerInterval = null;
    let directorPhotosAccessLocked = false;
    let currentCaseAssets = [];
    
    // Set up automatic token refresh and session monitoring
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      console.log('ð Auth state changed:', event, session?.user?.email);
      
      // Update session state but DON'T redirect (let checkAuth handle redirects)
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        currentSession = session;
        isAuthenticated = !!session;
        console.log('â Session updated/refreshed successfully');
      }
      
      if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
        isAuthenticated = false;
        currentSession = null;
        console.log('â ï¸ User signed out');
        // Don't redirect here - it causes loops. Let checkAuth handle redirects.
      }
      
      if (event === 'TOKEN_REFRESHED') {
        console.log('ð Access token auto-refreshed - no action needed');
      }
    });
    
    // Enhanced auth check with proper session handling
    async function checkAuth() {
      console.log('=== DIRECTOR AUTHENTICATION CHECK ===');
      
      try {
        // Get session from localStorage (persisted)
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          console.error('Session error:', sessionError);
          throw new Error('Session retrieval failed');
        }
        
        if (!session) {
          console.error('No session found - redirecting to login');
          window.location.href = '/director/login';
          return false;
        }
        
        console.log('Session exists:', !!session);
        console.log('User Email:', session.user.email);
        console.log('JWT app_metadata:', session.user.app_metadata);
        
        // Store session globally
        currentSession = session;
        
        // Verify director role from database and fetch organization name
        const { data: userData, error } = await supabaseClient
          .from('users')
          .select('role, org_id, metadata, organizations (name)')
          .eq('id', session.user.id)
          .single();
        
        console.log('Database user data:', userData);
        
        if (error || !userData || userData.role !== 'director') {
          console.error('â Not a director or user not found');
          await supabaseClient.auth.signOut();
          window.location.href = '/director/login';
          return false;
        }
        
        // Check if user needs to change password (first login)
        if (userData.metadata?.requires_password_change === true) {
          console.log('â ï¸ First login detected - forcing password change');
          
          // CRITICAL FIX: Make page visible BEFORE showing password modal
          // Otherwise the modal appears but the page stays hidden (blank screen)
          document.body.classList.remove('auth-pending');
          document.body.classList.add('auth-verified');
          
          showPasswordChangeModal();
          return false; // Block dashboard access
        }
        
        // Display funeral home name in topbar
        const funeralHomeElement = document.getElementById('funeral-home-name');
        if (userData.organizations && userData.organizations.name) {
          funeralHomeElement.textContent = userData.organizations.name;
        } else {
          funeralHomeElement.textContent = 'Funeral Home';
        }
        
        // Check JWT role (secondary check)
        const jwtRole = session.user.app_metadata?.role;
        const jwtOrgId = session.user.app_metadata?.org_id;
        
        console.log('JWT Role from app_metadata:', jwtRole);
        console.log('JWT Org ID from app_metadata:', jwtOrgId);
        
        if (!jwtRole || !jwtOrgId) {
          console.warn('â ï¸ WARNING: app_metadata missing in JWT - refreshing session...');
          // Refresh session to get updated JWT
          const { data: refreshData } = await supabaseClient.auth.refreshSession();
          if (refreshData?.session) {
            currentSession = refreshData.session;
            console.log('â Session refreshed, JWT updated');
          }
        } else {
          console.log('â JWT app_metadata role and org_id are correct');
        }
        
        isAuthenticated = true;
        // Show content now that auth is verified
        document.body.classList.remove('auth-pending');
        document.body.classList.add('auth-verified');
        console.log('â Director authentication successful');
        console.log('Director Org ID:', userData.org_id);
        console.log('=== END AUTH CHECK ===\n');
        return true;
        
      } catch (error) {
        console.error('â Auth check failed:', error);
        window.location.href = '/director/login';
        return false;
      }
    }
    
    // Helper function to get valid session (with auto-refresh if needed)
    async function getValidSession() {
      if (!currentSession) {
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentSession = session;
      }
      
      // If session is close to expiry, refresh it
      if (currentSession) {
        const expiresAt = currentSession.expires_at;
        const now = Math.floor(Date.now() / 1000);
        const timeUntilExpiry = expiresAt - now;
        
        // Refresh if less than 5 minutes until expiry
        if (timeUntilExpiry < 300) {
          console.log('ð Session expiring soon, refreshing...');
          const { data: refreshData, error } = await supabaseClient.auth.refreshSession();
          if (!error && refreshData.session) {
            currentSession = refreshData.session;
            console.log('â Session refreshed successfully');
          }
        }
      }
      
      if (!currentSession) {
        throw new Error('No valid session - please log in again');
      }
      
      return currentSession;
    }
    
    // Initialize app - authenticate FIRST, then load data
    async function initializeApp() {
      const authSuccess = await checkAuth();
      
      if (authSuccess) {
        // Only load data after successful authentication
        console.log('ð Loading cases...');
        await loadCases();
        console.log('â App initialization complete');
      }
    }
    
    // Run initialization on page load
    initializeApp();
    
    // Profile dropdown toggle
    document.getElementById('profile-toggle').addEventListener('click', function(e) {
      e.stopPropagation();
      this.classList.toggle('open');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      document.getElementById('profile-toggle').classList.remove('open');
    });
    
    // Logout handler
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = '/director/login';
    });
    
    // Section switching
    function switchSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.topbar-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(`${sectionName}-section`).classList.add('active');
      
      // Add active class to clicked nav item
      event.target.closest('.topbar-nav-item').classList.add('active');
      
      // Load cases if switching to my-cases
      if (sectionName === 'my-cases') {
        loadCases();
      }
    }
    
    // ============================================================================
    // PASSWORD CHANGE (First Login)
    // ============================================================================
    
    // ============================================================================
    //  MODAL UTILITIES - SMOOTH ANIMATIONS
    // ============================================================================
    
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      
      modal.style.display = 'flex';
      // Trigger reflow for animation
      modal.offsetHeight;
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }, 200); // Match transition duration
    }
    
    function showPasswordChangeModal() {
      openModal('password-change-modal');
      
      // Disable navigation (keep this for security)
      const topbar = document.querySelector('.topbar');
      if (topbar) topbar.style.pointerEvents = 'none';
    }
    
    // Password change form handler
    document.getElementById('password-change-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const errorBox = document.getElementById('password-error');
      const submitBtn = document.getElementById('change-password-btn');
      
      errorBox.style.display = 'none';
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        errorBox.textContent = 'Passwords do not match';
        errorBox.style.display = 'block';
        return;
      }
      
      // Validate password length
      if (newPassword.length < 8) {
        errorBox.textContent = 'Password must be at least 8 characters';
        errorBox.style.display = 'block';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'CHANGING PASSWORD...';
      
      try {
        // Update password in Supabase Auth
        const { error: passwordError } = await supabaseClient.auth.updateUser({
          password: newPassword
        });
        
        if (passwordError) throw passwordError;
        
        // Clear the requires_password_change flag in user metadata
        const session = await getValidSession();
        if (!session) throw new Error('Session expired');
        
        // CRITICAL FIX: Fetch existing metadata from database first
        // Don't use user_metadata from JWT - they're different!
        const { data: existingUser } = await supabaseClient
          .from('users')
          .select('metadata')
          .eq('id', session.user.id)
          .single();
        
        const { error: metadataError } = await supabaseClient
          .from('users')
          .update({
            metadata: {
              ...(existingUser?.metadata || {}),  // Preserve existing metadata
              requires_password_change: false,
              password_changed_at: new Date().toISOString()
            }
          })
          .eq('id', session.user.id);
        
        if (metadataError) throw metadataError;
        
        // Success! Hide modal and enable UI
        closeModal('password-change-modal');
        const topbar = document.querySelector('.topbar');
        if (topbar) topbar.style.pointerEvents = 'auto';
        
        showToast('Password changed successfully! Welcome to Memorio.');
        
        // Re-run checkAuth to proceed with dashboard
        await checkAuth();
        
      } catch (error) {
        console.error('Error changing password:', error);
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'CHANGE PASSWORD';
      }
    });
    
    // Make functions global
    window.switchSection = switchSection;
    window.openCaseModal = openCaseModal;
    window.closeCaseModal = closeCaseModal;
    window.revealCredentials = revealCredentials;
    window.copyToClipboard = copyToClipboard;
    window.deleteCase = deleteCase;
    
    // Toast notification
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Confirmation modal
    function showConfirmModal(title, message, onConfirm, confirmLabel = 'Confirm') {
      const modal = document.getElementById('confirm-modal');
      const modalTitle = document.getElementById('confirm-modal-title');
      const modalMessage = document.getElementById('confirm-modal-message');
      const actionBtn = document.getElementById('confirm-modal-action-btn');
      
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      actionBtn.textContent = confirmLabel;
      openModal('confirm-modal');
      
      // Set up the confirm action
      actionBtn.onclick = () => {
        closeConfirmModal();
        onConfirm();
      };
    }
    
    function closeConfirmModal() {
      closeModal('confirm-modal');
    }
    
    // Close modal when clicking outside
    document.getElementById('confirm-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'confirm-modal') {
        closeConfirmModal();
      }
    });
    
    // Copy to clipboard
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) {
        console.error('Element not found:', elementId);
        showToast('Element not found', true);
        return;
      }
      
      const text = element.textContent;
      const btn = event && event.target;
      
      navigator.clipboard.writeText(text).then(() => {
        console.log('Successfully copied to clipboard:', text);
        
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          btn.style.backgroundColor = '#28a745';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.backgroundColor = '';
          }, 2000);
        }
        
        showToast('Copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        showToast('Failed to copy to clipboard', true);
      });
    }
    
    // Case modal functions
    async function openCaseModal(caseId) {
      openModal('case-details-modal');
      
      credentialsRevealed = false;
      document.getElementById('reveal-credentials-btn').textContent = 'Reveal';
      document.getElementById('modal-family-login-email').textContent = 'Click Reveal';
      document.getElementById('modal-family-password').textContent = 'Click Reveal';
      document.getElementById('modal-family-login-email').classList.add('blurred');
      document.getElementById('modal-family-password').classList.add('blurred');
      
      try {
        // Use admin_cases_view instead of cases table
        // This view includes family user info and respects RLS policies
        const { data: caseData, error: caseError } = await supabaseClient
          .from('admin_cases_view')
          .select('*')
          .eq('id', caseId)
          .single();
        
        if (caseError) throw caseError;
        
        currentCaseDetails = caseData;
        
        // Family data is already included in admin_cases_view
        const familyEmail = caseData.family_email;
        const familyMetadata = caseData.family_metadata;
        const familyPassword = familyMetadata?.temp_password || null;
        
        const { data: formData, error: formError } = await supabaseClient
          .from('forms')
          .select('*')
          .eq('case_id', caseId)
          .single();
        
        const stage = getCaseStage(caseData.status);
        
        document.getElementById('modal-case-name').textContent = caseData.deceased_name;
        document.getElementById('modal-case-id').textContent = caseData.id;
        const statusElement = document.getElementById('modal-case-status');
        statusElement.innerHTML = `${stage.icon} <span>${stage.label}</span>`;
        statusElement.style.color = stage.color;
        document.getElementById('modal-case-created').textContent = new Date(caseData.created_at).toLocaleDateString();
        
        // Display service date from metadata
        const serviceDate = caseData.case_metadata?.service_date;
        if (serviceDate) {
          document.getElementById('modal-case-service-date').textContent = new Date(serviceDate).toLocaleDateString();
        } else {
          document.getElementById('modal-case-service-date').textContent = 'Not specified';
        }
        
        document.getElementById('modal-case-updated').textContent = new Date(caseData.updated_at).toLocaleDateString();
        
        if (familyEmail) {
          document.getElementById('modal-family-name').textContent = familyMetadata?.name || 'Family Member';
          document.getElementById('modal-family-email').textContent = familyEmail;
          document.getElementById('modal-family-login-email').textContent = familyEmail;
        } else {
          document.getElementById('modal-family-name').textContent = 'Not assigned';
          document.getElementById('modal-family-email').textContent = 'Not assigned';
          document.getElementById('modal-family-login-email').textContent = 'Not assigned';
        }
        
        if (formData && formData.submitted_at) {
          document.getElementById('modal-form-status').textContent = 'Submitted';
          document.getElementById('modal-form-submitted').textContent = new Date(formData.submitted_at).toLocaleDateString();
        } else {
          document.getElementById('modal-form-status').textContent = 'Not submitted';
          document.getElementById('modal-form-submitted').textContent = '-';
        }
        
        if (familyPassword) {
          document.getElementById('modal-family-password').textContent = familyPassword;
        } else {
          document.getElementById('modal-family-password').textContent = 'Not available';
        }
        
        // Fetch obituary content if it exists
        const { data: obituaryData, error: obituaryError } = await supabaseClient
          .from('obituary_content')
          .select('content_html, updated_at')
          .eq('case_id', caseId)
          .single();
        
        console.log('ð Obituary query result:', { obituaryData, obituaryError });
        
        const obituarySection = document.getElementById('obituary-section');
        const obituaryContent = document.getElementById('obituary-content');
        const obituaryUpdated = document.getElementById('obituary-updated');
        const obituarySectionTitle = document.getElementById('obituary-section-title');
        
        if (!obituaryError && obituaryData && obituaryData.content_html) {
          // Show obituary section
          console.log('â Showing obituary section');
          obituarySection.style.display = 'block';
          obituaryContent.innerHTML = obituaryData.content_html;
          obituaryUpdated.textContent = new Date(obituaryData.updated_at).toLocaleString();
          
          // Update title based on case status
          if (caseData.status === 'delivered') {
            // Change title to "Completed Obituary" when delivered
            const titleIcon = obituarySectionTitle.querySelector('svg').outerHTML;
            obituarySectionTitle.innerHTML = titleIcon + ' Completed Obituary';
          } else {
            // Keep as "Obituary Draft" for other statuses
            const titleIcon = obituarySectionTitle.querySelector('svg').outerHTML;
            obituarySectionTitle.innerHTML = titleIcon + ' Obituary Draft';
          }
        } else {
          // Hide obituary section if no content
          console.log('â Hiding obituary section:', obituaryError?.message || 'No content');
          obituarySection.style.display = 'none';
        }
        
        // Handle sections based on case status
        if (caseData.status === 'delivered') {
          // Case is delivered - show banner and downloads, hide photos
          document.getElementById('delivered-banner').style.display = 'block';
          document.getElementById('downloads-section').style.display = 'block';
          document.getElementById('photos-section').style.display = 'none';
        } else if (formData && formData.submitted_at) {
          // Form is submitted but not delivered - show photos section and initialize timer
          document.getElementById('delivered-banner').style.display = 'none';
          document.getElementById('downloads-section').style.display = 'none';
          document.getElementById('photos-section').style.display = 'block';
          await loadDirectorAssets(caseId);
          initializeDirectorUploadTimer(formData.submitted_at);
        } else {
          // Form not submitted - hide all sections
          document.getElementById('delivered-banner').style.display = 'none';
          document.getElementById('downloads-section').style.display = 'none';
          document.getElementById('photos-section').style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error loading case details:', error);
        showToast('Error loading case details', true);
        closeCaseModal();
      }
    }
    
    function closeCaseModal() {
      closeModal('case-details-modal');
      currentCaseDetails = null;
      credentialsRevealed = false;
      
      // Clear upload timer
      if (directorUploadTimerInterval) {
        clearInterval(directorUploadTimerInterval);
        directorUploadTimerInterval = null;
      }
    }
    
    // Load assets (photos) for director
    async function loadDirectorAssets(caseId) {
      try {
        const { data: assets, error } = await supabaseClient
          .from('assets')
          .select('*')
          .eq('case_id', caseId)
          .order('uploaded_at', { ascending: false });
        
        if (error) throw error;
        
        currentCaseAssets = assets || [];
        displayDirectorPhotos();
        
      } catch (error) {
        console.error('Error loading assets:', error);
        showToast('Error loading photos', true);
      }
    }
    
    // Display photos in grid
    function displayDirectorPhotos() {
      const photosGrid = document.getElementById('director-photos-grid');
      const noPhotos = document.getElementById('director-no-photos');
      
      if (currentCaseAssets.length === 0) {
        photosGrid.style.display = 'none';
        noPhotos.style.display = 'block';
        return;
      }
      
      photosGrid.style.display = 'grid';
      noPhotos.style.display = 'none';
      photosGrid.innerHTML = '';
      
      currentCaseAssets.forEach(asset => {
        const photoDiv = document.createElement('div');
        photoDiv.style.cssText = `
          position: relative;
          aspect-ratio: 1;
          border-radius: 8px;
          overflow: hidden;
          border: 2px solid #436481;
          background-color: #f4e8de;
        `;
        
        const img = document.createElement('img');
        // Handle both Supabase Storage and Uploadcare URLs
        if (asset.file_key && asset.file_key.startsWith('http')) {
          img.src = asset.file_key;
        } else {
          img.src = `${SUPABASE_URL}/storage/v1/object/public/case-assets/${asset.file_key}`;
        }
        img.alt = 'Photo';
        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        img.onerror = () => {
          img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
        };
        
        photoDiv.appendChild(img);
        photosGrid.appendChild(photoDiv);
      });
    }
    
    // Initialize 12-hour upload timer
    function initializeDirectorUploadTimer(submittedAt) {
      const UPLOAD_WINDOW_HOURS = 12;
      const timerBanner = document.getElementById('director-upload-timer-banner');
      const uploadBtn = document.getElementById('director-upload-btn');
      
      if (!submittedAt) {
        timerBanner.style.display = 'none';
        return;
      }
      
      function updateTimer() {
        const now = new Date();
        const submittedDate = new Date(submittedAt);
        const windowEndTime = new Date(submittedDate.getTime() + (UPLOAD_WINDOW_HOURS * 60 * 60 * 1000));
        const timeRemaining = windowEndTime - now;
        
        if (timeRemaining <= 0) {
          // Window expired
          directorPhotosAccessLocked = true;
          timerBanner.innerHTML = `
            <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">â° Upload Window Closed</div>
              <div style="font-size: 14px;">The 12-hour upload window has expired</div>
            </div>
          `;
          timerBanner.style.display = 'block';
          uploadBtn.disabled = true;
          uploadBtn.style.opacity = '0.5';
          uploadBtn.style.cursor = 'not-allowed';
          
          if (directorUploadTimerInterval) {
            clearInterval(directorUploadTimerInterval);
            directorUploadTimerInterval = null;
          }
        } else {
          // Window active
          directorPhotosAccessLocked = false;
          const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
          const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
          
          timerBanner.innerHTML = `
            <div style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">â° Upload Window Active</div>
              <div style="font-size: 24px; font-weight: 700; font-family: 'Courier New', monospace; margin: 8px 0;">
                ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
              </div>
              <div style="font-size: 14px;">Time remaining to upload additional photos</div>
            </div>
          `;
          timerBanner.style.display = 'block';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          uploadBtn.style.cursor = 'pointer';
        }
      }
      
      updateTimer();
      directorUploadTimerInterval = setInterval(updateTimer, 1000);
    }
    
    // Handle photo upload
    document.getElementById('director-photo-input')?.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      
      if (directorPhotosAccessLocked) {
        showToast('Upload window has expired', true);
        return;
      }
      
      if (files.length === 0) return;
      
      if (!currentCaseDetails) {
        showToast('No case selected', true);
        return;
      }
      
      showToast(`Uploading ${files.length} photo(s)...`);
      
      try {
        const session = await getValidSession();
        
        for (const file of files) {
          // Upload to Supabase Storage
          const fileName = `${currentCaseDetails.id}/${Date.now()}-${file.name}`;
          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('case-assets')
            .upload(fileName, file);
          
          if (uploadError) throw uploadError;
          
          // Save asset record to database
          const { error: dbError } = await supabaseClient
            .from('assets')
            .insert({
              case_id: currentCaseDetails.id,
              uploader_user_id: session.user.id,
              file_key: fileName,
              mime_type: file.type,
              size_bytes: file.size,
              metadata: { uploaded_by: 'director' }
            });
          
          if (dbError) throw dbError;
        }
        
        showToast(`Successfully uploaded ${files.length} photo(s)!`);
        
        // Reload assets
        await loadDirectorAssets(currentCaseDetails.id);
        
        // Clear file input
        e.target.value = '';
        
      } catch (error) {
        console.error('Error uploading photos:', error);
        showToast('Error uploading photos', true);
      }
    });
    
    // Download video
    async function directorDownloadVideo() {
      if (!currentCaseDetails) {
        showToast('No case selected', true);
        return;
      }
      
      try {
        showToast('Preparing download...');
        
        // Get the final approved video
        const { data: videoSubmission, error } = await supabaseClient
          .from('video_submissions')
          .select('*')
          .eq('case_id', currentCaseDetails.id)
          .eq('qc_status', 'approved')
          .order('submitted_at', { ascending: false })
          .limit(1)
          .single();
        
        if (error || !videoSubmission) {
          showToast('No approved video found', true);
          return;
        }
        
        // Fetch video as blob
        const response = await fetch(videoSubmission.video_url);
        if (!response.ok) throw new Error('Failed to fetch video');
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        
        // Trigger download
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentCaseDetails.deceased_name.replace(/\s+/g, '_')}_Memorial_Tribute.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Video downloaded successfully!');
        
      } catch (error) {
        console.error('Error downloading video:', error);
        showToast('Error downloading video', true);
      }
    }
    
    // Download obituary as PDF
    async function directorDownloadObituaryPDF() {
      if (!currentCaseDetails) {
        showToast('No case selected', true);
        return;
      }
      
      try {
        showToast('Preparing PDF...');
        
        // Get obituary content
        const { data: obituary, error } = await supabaseClient
          .from('obituary_content')
          .select('*')
          .eq('case_id', currentCaseDetails.id)
          .single();
        
        if (error || !obituary) {
          showToast('No obituary found', true);
          return;
        }
        
        // Create a printable HTML page
        const printWindow = window.open('', '_blank');
        const content = obituary.content_html || obituary.content_plain || '';
        
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>${currentCaseDetails.deceased_name} - Obituary</title>
            <style>
              body {
                font-family: 'Times New Roman', serif;
                max-width: 800px;
                margin: 40px auto;
                padding: 20px;
                line-height: 1.8;
                color: #333;
              }
              h1 {
                text-align: center;
                margin-bottom: 30px;
                color: #436481;
              }
              @media print {
                body { margin: 0; padding: 20px; }
              }
            </style>
          </head>
          <body>
            <h1>${currentCaseDetails.deceased_name}</h1>
            ${content}
          </body>
          </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load then trigger print
        setTimeout(() => {
          printWindow.print();
        }, 500);
        
        showToast('PDF print dialog opened!');
        
      } catch (error) {
        console.error('Error downloading obituary:', error);
        showToast('Error downloading obituary', true);
      }
    }
    
    // Make functions globally accessible
    window.directorDownloadVideo = directorDownloadVideo;
    window.directorDownloadObituaryPDF = directorDownloadObituaryPDF;
    
    function revealCredentials() {
      const revealBtn = document.getElementById('reveal-credentials-btn');
      const emailElement = document.getElementById('modal-family-login-email');
      const passwordElement = document.getElementById('modal-family-password');
      
      if (!credentialsRevealed) {
        emailElement.classList.remove('blurred');
        passwordElement.classList.remove('blurred');
        revealBtn.textContent = 'Hide';
        credentialsRevealed = true;
      } else {
        emailElement.classList.add('blurred');
        passwordElement.classList.add('blurred');
        revealBtn.textContent = 'Reveal';
        credentialsRevealed = false;
      }
    }
    
    // Close modal when clicking outside
    document.getElementById('case-details-modal').addEventListener('click', (e) => {
      if (e.target.id === 'case-details-modal') {
        closeCaseModal();
      }
    });
    
    // Delete case function (also deletes associated family user)
    async function deleteCase(caseId, caseName) {
      showConfirmModal(
        'Delete Case',
        `Are you sure you want to delete the case for "${caseName}"?\n\nThis will permanently delete the associated family member's account and all related data.\n\nThis action cannot be undone.`,
        () => performDeleteCase(caseId, caseName),
        'Yes, Delete Case'
      );
    }
    
    // Perform the actual case deletion
    async function performDeleteCase(caseId, caseName) {
      try {
        // First, get the case to find the assigned family user
        const { data: caseData, error: caseError } = await supabaseClient
          .from('cases')
          .select('assigned_family_user_id')
          .eq('id', caseId)
          .single();
        
        if (caseError) throw caseError;
        
        const familyUserId = caseData?.assigned_family_user_id;
        
        // Delete the case first (this will cascade to related records)
        const { error: deleteError } = await supabaseClient
          .from('cases')
          .delete()
          .eq('id', caseId);
        
        if (deleteError) throw deleteError;
        
        // If there was a family user assigned, delete them completely
        if (familyUserId) {
          console.log(`Deleting associated family user: ${familyUserId}`);
          
          const session = await getValidSession();
          const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-user`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json',
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({
              user_id: familyUserId,
              reason: 'Case deleted by director'
            })
          });
          
          const result = await response.json();
          
          if (!response.ok || !result.success) {
            console.warn('Failed to delete family user:', result.error);
            // Don't throw error - case is already deleted, this is cleanup
            showToast(`Case deleted, but failed to delete family account: ${result.error}`, true);
          } else {
            console.log('â Family user deleted successfully');
            showToast(`Case and family account for "${caseName}" deleted successfully`);
          }
        } else {
          showToast(`Case for "${caseName}" deleted successfully`);
        }
        
        closeCaseModal();
        await loadCases();
        
      } catch (error) {
        console.error('Error deleting case:', error);
        showToast(`Failed to delete case: ${error.message}`, true);
      }
    }
    
    // State/Country validation helper
    function validateLocationPair(state, country, fieldType) {
      const usStates = ['alabama', 'alaska', 'arizona', 'arkansas', 'california', 'colorado', 'connecticut', 'delaware', 
        'florida', 'georgia', 'hawaii', 'idaho', 'illinois', 'indiana', 'iowa', 'kansas', 'kentucky', 'louisiana', 
        'maine', 'maryland', 'massachusetts', 'michigan', 'minnesota', 'mississippi', 'missouri', 'montana', 'nebraska', 
        'nevada', 'new hampshire', 'new jersey', 'new mexico', 'new york', 'north carolina', 'north dakota', 'ohio', 
        'oklahoma', 'oregon', 'pennsylvania', 'rhode island', 'south carolina', 'south dakota', 'tennessee', 'texas', 
        'utah', 'vermont', 'virginia', 'washington', 'west virginia', 'wisconsin', 'wyoming', 'district of columbia', 
        'dc', 'washington dc', 'washington d.c.'];
      
      const canadianProvinces = ['alberta', 'british columbia', 'manitoba', 'new brunswick', 'newfoundland and labrador', 
        'northwest territories', 'nova scotia', 'nunavut', 'ontario', 'prince edward island', 'quebec', 'saskatchewan', 
        'yukon', 'ab', 'bc', 'mb', 'nb', 'nl', 'nt', 'ns', 'nu', 'on', 'pe', 'qc', 'sk', 'yt'];
      
      const stateLower = state.toLowerCase().trim();
      const countryLower = country.toLowerCase().trim();
      
      // Check for US state with non-US country
      if (usStates.includes(stateLower) && 
          !['united states', 'usa', 'us', 'u.s.', 'u.s.a.', 'america'].includes(countryLower)) {
        return {
          valid: false,
          message: `"${state}" is a US state but country is set to "${country}". Did you mean "United States"?`
        };
      }
      
      // Check for Canadian province with non-Canadian country
      if (canadianProvinces.includes(stateLower) && 
          !['canada', 'ca'].includes(countryLower)) {
        return {
          valid: false,
          message: `"${state}" is a Canadian province but country is set to "${country}". Did you mean "Canada"?`
        };
      }
      
      // Check for US/USA country with non-US state (warning only for common cases)
      if (['united states', 'usa', 'us', 'u.s.', 'u.s.a.', 'america'].includes(countryLower) && 
          canadianProvinces.includes(stateLower)) {
        return {
          valid: false,
          message: `Country is "United States" but "${state}" is a Canadian province. Did you mean "Canada"?`
        };
      }
      
      return { valid: true };
    }
    
    // Handle gender dropdown change to show/hide custom input
    document.getElementById('deceased-gender').addEventListener('change', function() {
      const customContainer = document.getElementById('custom-gender-container');
      const customInput = document.getElementById('deceased-gender-custom');
      
      if (this.value === 'other') {
        customContainer.style.display = 'block';
        customInput.setAttribute('required', 'required');
      } else {
        customContainer.style.display = 'none';
        customInput.removeAttribute('required');
        customInput.value = ''; // Clear the value when hidden
      }
    });
    
    // Create Case form handler
    document.getElementById('create-case-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Handle custom gender value
      let genderValue = document.getElementById('deceased-gender').value;
      if (genderValue === 'other') {
        const customGender = document.getElementById('deceased-gender-custom').value.trim();
        if (!customGender) {
          const errorBox = document.getElementById('create-case-error-box');
          errorBox.textContent = 'Please specify gender/pronouns when "Other" is selected.';
          errorBox.style.display = 'block';
          return;
        }
        genderValue = customGender; // Use the custom value
      }
      
      // Capture all required loved one's information
      const caseData = {
        deceased_name: document.getElementById('deceased-name').value,
        gender: genderValue,
        date_of_birth: document.getElementById('deceased-dob').value,
        date_of_death: document.getElementById('deceased-dod').value,
        city_of_birth: document.getElementById('deceased-birth-city').value,
        state_of_birth: document.getElementById('deceased-birth-state').value,
        country_of_birth: document.getElementById('deceased-birth-country').value,
        city_of_death: document.getElementById('deceased-death-city').value,
        state_of_death: document.getElementById('deceased-death-state').value,
        country_of_death: document.getElementById('deceased-death-country').value,
        service_date: document.getElementById('deceased-service-date').value
      };
      
      // Validate birth location
      const birthValidation = validateLocationPair(
        caseData.state_of_birth, 
        caseData.country_of_birth, 
        'birth'
      );
      
      if (!birthValidation.valid) {
        showToast(birthValidation.message, true);
        return;
      }
      
      // Validate death location
      const deathValidation = validateLocationPair(
        caseData.state_of_death, 
        caseData.country_of_death, 
        'passing'
      );
      
      if (!deathValidation.valid) {
        showToast(deathValidation.message, true);
        return;
      }
      
      const createBtn = document.getElementById('create-case-btn');
      const successBox = document.getElementById('case-success-box');
      const errorBox = document.getElementById('case-error-box');
      const section = e.target.closest('.card');
      
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      if (section) section.classList.add('loading');
      createBtn.disabled = true;
      createBtn.textContent = 'CREATING CASE...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        console.log('=== CREATING CASE ===');
        console.log('Case Data:', caseData);
        console.log('Session:', session?.user?.email);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/create-case`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify(caseData)
        });
        
        console.log('Response Status:', response.status);
        const result = await response.json();
        console.log('Response Result:', result);
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create case');
        }
        
        console.log('â Case created successfully:', result.data.case_id);
        document.getElementById('created-case-id').textContent = result.data.case_id;
        successBox.style.display = 'block';
        setTimeout(() => successBox.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
        document.getElementById('create-case-form').reset();
        
        // Reset country fields to default
        document.getElementById('deceased-birth-country').value = 'United States';
        document.getElementById('deceased-death-country').value = 'United States';
        
        // Reload cases to show the new case
        await loadCases();
        
      } catch (error) {
        console.error('â Error creating case:', error);
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        createBtn.disabled = false;
        createBtn.textContent = 'CREATE CASE';
      }
    });
    
    // Invite Family form handler
    document.getElementById('invite-family-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('family-email').value;
      const name = document.getElementById('family-name').value;
      const phone = document.getElementById('family-phone').value;
      const caseId = document.getElementById('case-id').value;
      
      const inviteBtn = document.getElementById('invite-family-btn');
      const successBox = document.getElementById('family-success-box');
      const errorBox = document.getElementById('family-error-box');
      const section = e.target.closest('.card');
      
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      if (section) section.classList.add('loading');
      inviteBtn.disabled = true;
      inviteBtn.textContent = 'SENDING INVITATION...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/invite-family`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            email,
            name,
            case_id: caseId,
            phone: phone || undefined
          })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to invite family member');
        }
        
        document.getElementById('invited-email').textContent = result.data.email;
        
        if (result.data.temp_password) {
          document.getElementById('family-password').textContent = result.data.temp_password;
          
          if (result.data.user_id) {
            try {
              // Fetch existing metadata first to preserve requires_password_change flag
              const { data: existingUser } = await supabaseClient
                .from('users')
                .select('metadata')
                .eq('id', result.data.user_id)
                .single();
              
              // Merge new fields with existing metadata (preserve requires_password_change)
              await supabaseClient
                .from('users')
                .update({ 
                  metadata: { 
                    ...(existingUser?.metadata || {}),  // Keep all existing fields
                    temp_password: result.data.temp_password,
                    password_created_at: new Date().toISOString()
                  }
                })
                .eq('id', result.data.user_id);
            } catch (updateError) {
              console.error('Failed to store password in metadata:', updateError);
            }
          }
        } else {
          document.getElementById('family-password').textContent = 'ERROR: No credentials received';
        }
        
        successBox.style.display = 'block';
        setTimeout(() => successBox.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
        document.getElementById('invite-family-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        inviteBtn.disabled = false;
        inviteBtn.textContent = 'SEND INVITATION';
      }
    });
    
    // Load cases
    // Get video/QC status badge HTML
    // Map database status to workflow stage
    function getCaseStage(status, caseId = null) {
      // Waiting on Family: Case created, waiting for family to complete intake
      if (['created', 'waiting_on_family', 'intake_in_progress'].includes(status)) {
        return {
          label: 'Waiting on Family',
          color: '#6b7280', // Grey
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12,6 12,12 16,14"></polyline></svg>'
        };
      }
      
      // In Progress: Family submitted, editor working
      if (['submitted', 'in_production'].includes(status)) {
        return {
          label: 'In Progress',
          color: '#2196f3', // Blue
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline></svg>'
        };
      }
      
      // QC Reviewed + cooldown active: approved by QC, waiting to deliver
      if (status === 'awaiting_review' && cooldownMap[caseId]) {
        return {
          label: 'QC Reviewed',
          color: '#f59e0b', // Amber
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12,6 12,12 16,14"></polyline></svg>'
        };
      }
      
      // Awaiting Review: Video submitted to QC (not yet reviewed)
      if (['awaiting_review', 'revision_requested'].includes(status)) {
        return {
          label: 'Awaiting Review',
          color: '#9c27b0', // Purple
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
        };
      }
      
      // Complete: Delivered to family
      if (['delivered', 'closed'].includes(status)) {
        return {
          label: 'Complete',
          color: '#4caf50', // Green
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><polyline points="20,6 9,17 4,12"></polyline></svg>'
        };
      }
      
      // Fallback
      return {
        label: status.replace(/_/g, ' '),
        color: '#9e9e9e', // Grey
        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>'
      };
    }
    
    function getVideoStatusBadge(status) {
      const statusConfig = {
        'in_production': { 
          text: 'Editor Working', 
          color: '#9c27b0',
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline></svg>'
        },
        'awaiting_review': { 
          text: 'Pending QC', 
          color: '#ff9800',
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12,6 12,12 16,14"></polyline></svg>'
        },
        'revision_requested': { 
          text: 'Revision Needed', 
          color: '#f44336',
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><polyline points="23,4 23,10 17,10"></polyline><polyline points="1,20 1,14 7,14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>'
        },
        'delivered': { 
          text: 'Delivered', 
          color: '#4caf50',
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><polyline points="20,6 9,17 4,12"></polyline></svg>'
        }
      };
      
      const config = statusConfig[status];
      if (!config) return '';
      
      return `
        <div style="
          background-color: ${config.color}15;
          border: 1.5px solid ${config.color};
          color: ${config.color};
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          margin-top: 8px;
          display: inline-flex;
          align-items: center;
          gap: 4px;
        ">
          ${config.icon || ''}${config.text}
        </div>
      `;
    }
    
    // Map of case_id -> cooldown_expires_at for QC-reviewed cases pending delivery
    let cooldownMap = {};
    
    async function loadCases() {
      const casesList = document.getElementById('cases-list');
      const errorBox = document.getElementById('cases-error-box');
      
      errorBox.style.display = 'none';
      casesList.innerHTML = '<p style="color: #32343a; opacity: 0.6;">Loading cases...</p>';
      
      try {
        const { data: cases, error } = await supabaseClient
          .from('admin_cases_view')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allCases = cases || [];
        
        // Fetch cooldown data for any awaiting_review cases
        // (these may be QC-approved but in cooldown period)
        const awaitingIds = allCases
          .filter(c => c.status === 'awaiting_review')
          .map(c => c.id);
        
        cooldownMap = {};
        if (awaitingIds.length > 0) {
          const { data: cooldownRows } = await supabaseClient
            .from('video_submissions')
            .select('case_id, cooldown_expires_at')
            .in('case_id', awaitingIds)
            .eq('qc_status', 'approved')
            .not('cooldown_expires_at', 'is', null);
          
          (cooldownRows || []).forEach(row => {
            cooldownMap[row.case_id] = row.cooldown_expires_at;
          });
        }
        
        renderCases(allCases);
        startCooldownTimers();
        
      } catch (error) {
        errorBox.textContent = `Error loading cases: ${error.message}`;
        errorBox.style.display = 'block';
        casesList.innerHTML = '';
      }
    }
    
    // Tick all active countdown timers in case cards every second
    let cooldownTimerInterval = null;
    function startCooldownTimers() {
      if (cooldownTimerInterval) clearInterval(cooldownTimerInterval);
      
      const hasCooldowns = Object.keys(cooldownMap).length > 0;
      if (!hasCooldowns) return;
      
      cooldownTimerInterval = setInterval(() => {
        Object.entries(cooldownMap).forEach(([caseId, expiresAt]) => {
          const el = document.getElementById(`cooldown-timer-${caseId}`);
          if (!el) return;
          
          const msLeft = new Date(expiresAt) - Date.now();
          if (msLeft <= 0) {
            // Cooldown expired â reload cases to pick up delivered status
            clearInterval(cooldownTimerInterval);
            loadCases();
            return;
          }
          
          const h = Math.floor(msLeft / 3600000);
          const m = Math.floor((msLeft % 3600000) / 60000);
          const s = Math.floor((msLeft % 60000) / 1000);
          el.textContent = `Delivering in ${h}h ${m}m ${s}s`;
        });
      }, 1000);
    }
    
    // Helper function to generate SLA badge HTML
    function getSLABadge(caseData) {
      // If case is delivered or closed, show completion badge
      if (caseData.status === 'delivered' || caseData.status === 'closed') {
        return '<span class="badge badge-success"><span class="badge-dot" style="background-color: #15803d;"></span>Delivered</span>';
      }
      
      // If no submission yet (waiting on family), show waiting badge
      if (!caseData.first_submission_at || caseData.status === 'waiting_on_family') {
        return '<span class="badge" style="background-color: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.2);"><span class="badge-dot" style="background-color: #6b7280;"></span>Waiting</span>';
      }
      
      // Calculate hours elapsed since submission
      const submissionTime = new Date(caseData.first_submission_at);
      const now = new Date();
      const hoursElapsed = (now - submissionTime) / (1000 * 60 * 60);
      
      // Determine badge based on thresholds
      let badgeVariant, badgeText, dotColor;
      const hours = Math.floor(hoursElapsed);
      
      if (hoursElapsed < 24) {
        // Success: < 24 hours
        badgeVariant = 'success';
        badgeText = `${hours} Hour(s)`;
        dotColor = '#15803d';
      } else if (hoursElapsed < 36) {
        // Warning: 24-36 hours
        badgeVariant = 'warning';
        badgeText = `${hours} Hour(s)`;
        dotColor = '#c2410c';
      } else if (hoursElapsed < 48) {
        // Danger: 36-48 hours
        badgeVariant = 'danger';
        badgeText = `${hours} Hour(s)`;
        dotColor = '#dc2626';
      } else {
        // Danger: 48+ hours (BREACH)
        badgeVariant = 'danger';
        badgeText = `${hours} Hour(s) â¢ BREACH`;
        dotColor = '#dc2626';
      }
      
      return `<span class="badge badge-${badgeVariant}"><span class="badge-dot" style="background-color: ${dotColor};"></span>${badgeText}</span>`;
    }
    
    // Render cases to the list
    function renderCases(cases) {
      const casesList = document.getElementById('cases-list');
      
      if (!cases || cases.length === 0) {
        casesList.innerHTML = `
          <div class="case-empty-state">
            <div class="case-empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
              </svg>
            </div>
            <h3 class="case-empty-state-title" data-i18n="director.noCases">No cases found</h3>
            <p class="case-empty-state-description" data-i18n="director.noCasesDesc">Create your first case to get started!</p>
          </div>
        `;
        i18n.translatePage();
        return;
      }
      
      casesList.innerHTML = cases.map(c => {
        const stage = getCaseStage(c.status, c.id);
        const slaBadge = getSLABadge(c);
        const serviceDate = c.case_metadata?.service_date 
          ? new Date(c.case_metadata.service_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : null;
        const hasCooldown = cooldownMap[c.id];
        
        return `
          <div class="case-row" onclick="openCaseModal('${c.id}')">
            <div class="case-row-left">
              <h4 class="case-row-name">${c.deceased_name}</h4>
              <div class="case-row-meta">
                <div class="case-row-meta-item" style="color: ${stage.color};">
                  ${stage.icon} <span>${stage.label}</span>
                </div>
                ${hasCooldown ? `
                  <div class="case-row-meta-item" style="
                    color: #f59e0b;
                    font-size: 12px;
                    font-weight: 600;
                    background: #fef3c7;
                    border: 1px solid #f59e0b;
                    border-radius: 12px;
                    padding: 2px 10px;
                  ">
                    <span id="cooldown-timer-${c.id}">Calculating...</span>
                  </div>
                ` : ''}
                ${serviceDate ? `
                  <div class="case-row-meta-item">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM5 8V6h14v2H5zm2 4h5v5H7v-5z"/>
                    </svg>
                    <span>Service: ${serviceDate}</span>
                  </div>
                ` : ''}
              </div>
            </div>
            <div class="case-row-right">
              ${slaBadge}
              <div class="case-row-date">${new Date(c.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" opacity="0.3">
                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
              </svg>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Search functionality - filters by name or case ID
    function filterCases(searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        renderCases(allCases);
        return;
      }
      
      const term = searchTerm.toLowerCase().trim();
      const filtered = allCases.filter(c => {
        const name = c.deceased_name.toLowerCase();
        const caseId = c.id.toLowerCase();
        return name.includes(term) || caseId.includes(term);
      });
      
      renderCases(filtered);
    }
    
    // Attach search event listener
    document.getElementById('search-input').addEventListener('input', (e) => {
      filterCases(e.target.value);
    });
  </script>
</body>
</html>
