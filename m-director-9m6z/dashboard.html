<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Director Dashboard - Memorio</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Preload Dosis font -->
  <link rel="preload" href="../fonts/Dosis-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/memorio-forms.webflow.css" rel="stylesheet" type="text/css">
  <link href="../images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
  
  <style>
    /* ============================================================================
       GLOBAL RESETS & MEMORIO THEME
       ============================================================================ */
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Dosis', sans-serif;
      background-color: #f2eadd;
      color: #32343a;
    }
    
    /* ============================================================================
       SIDEBAR - MEMORIO THEMED (CREAM BG + BLUE BORDERS)
       ============================================================================ */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background-color: #fff3e9; /* Cream background */
      border-right: 3px solid #436481; /* Blue border */
      box-shadow: 4px 0 15px rgba(67, 100, 129, 0.1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }
    
    .sidebar-logo {
      height: 70px;
      padding: 0;
      border-bottom: 2px solid #436481;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar-logo img {
      width: 140px;
      height: auto;
      max-height: 60px;
      object-fit: contain;
    }
    
    .sidebar-funeral-home {
      padding: 20px 16px;
      border-bottom: 2px solid #436481;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
      padding-bottom: 20px;
      overflow-y: auto;
    }
    
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 24px;
      margin: 4px 12px;
      color: #32343a;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      border: 1.5px solid transparent;
    }
    
    .sidebar-nav-item:hover {
      background-color: #f4e8de;
      border-color: #6ca7d3;
      color: #436481;
    }
    
    .sidebar-nav-item.active {
      background-color: #f4e8de;
      border-color: #436481;
      color: #436481;
    }
    
    .sidebar-nav-item svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    /* ============================================================================
       TOP NAVBAR - MEMORIO THEMED
       ============================================================================ */
    .topbar {
      position: fixed;
      left: 280px;
      top: 0;
      right: 0;
      height: 70px;
      background-color: #fff3e9;
      border-bottom: 2px solid #436481;
      box-shadow: 0 2px 10px rgba(67, 100, 129, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 999;
    }
    
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .topbar-title {
      font-size: 26px;
      font-weight: 600;
      color: #32343a;
      margin: 0;
    }
    
    .topbar-search {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .topbar-search-icon {
      position: absolute;
      left: 12px;
      width: 18px;
      height: 18px;
      fill: #436481;
      pointer-events: none;
    }
    
    .topbar-search-input {
      padding: 10px 16px 10px 40px;
      border: 1.5px solid #436481;
      border-radius: 60px;
      background-color: #f2eadd;
      font-family: 'Dosis', sans-serif;
      font-size: 14px;
      width: 280px;
      transition: all 0.2s ease;
      color: #32343a;
    }
    
    .topbar-search-input:focus {
      outline: none;
      border-color: #6ca7d3;
      background-color: #ffffff;
    }
    
    .topbar-search-input::placeholder {
      color: #32343a;
      opacity: 0.5;
    }
    
    .funeral-home-name {
      font-size: 16px;
      color: #436481;
      font-weight: 700;
      white-space: nowrap;
      letter-spacing: 0.3px;
      text-align: center;
      width: 100%;
    }
    
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .topbar-profile {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 20px;
      background-color: #f4e8de;
      border: 1.5px solid #436481;
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .topbar-profile:hover {
      background-color: #e8dccf;
      border-color: #6ca7d3;
    }
    
    .topbar-profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #436481;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: #f2eadd;
    }
    
    .topbar-profile-name {
      font-size: 15px;
      font-weight: 600;
      color: #32343a;
    }
    
    .topbar-profile-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      width: 100%; /* Same width as parent */
      background-color: #fff3e9;
      border: 1.5px solid #436481;
      border-radius: 60px; /* Pill shape */
      box-shadow: 0 4px 12px rgba(67, 100, 129, 0.2);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 9999;
      overflow: hidden;
    }
    
    .topbar-profile.open .topbar-profile-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .topbar-profile-dropdown-item {
      padding: 12px 20px;
      color: #32343a;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .topbar-profile-dropdown-item:hover {
      background-color: #f4e8de;
      color: #436481;
    }
    
    .topbar-profile-dropdown-item svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    
    /* ============================================================================
       MAIN CONTENT AREA
       ============================================================================ */
    .main-content {
      margin-left: 280px;
      margin-top: 70px;
      padding: 32px;
      min-height: calc(100vh - 70px);
    }
    
    /* ============================================================================
       SECTIONS & CARDS - MEMORIO THEMED
       ============================================================================ */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .action-card {
      background-color: #fff3e9;
      border: 3px solid #436481;
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(67, 100, 129, 0.1);
    }
    
    .card-title {
      font-size: 24px;
      font-weight: 600;
      color: #32343a;
      margin: 0 0 12px 0;
    }
    
    .card-description {
      font-size: 15px;
      color: #32343a;
      opacity: 0.7;
      margin: 0 0 24px 0;
      line-height: 1.6;
    }
    
    /* ============================================================================
       FORMS - MEMORIO THEMED
       ============================================================================ */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-row-single {
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #32343a;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-input {
      padding: 12px 16px;
      border: 1.5px solid #436481;
      border-radius: 8px;
      font-family: 'Dosis', sans-serif;
      font-size: 15px;
      background-color: #f2eadd;
      color: #32343a;
      transition: all 0.2s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #6ca7d3;
      background-color: #ffffff;
    }
    
    .form-input::placeholder {
      color: #32343a;
      opacity: 0.4;
    }
    
    .btn-primary {
      background-color: #32343a;
      color: #f2eadd;
      border: 1.5px solid #32343a;
      border-radius: 60px;
      padding: 14px 32px;
      font-family: 'Dosis', sans-serif;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 8px;
    }
    
    .btn-primary:hover {
      background-color: #6ca7d3;
      border-color: #6ca7d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108, 167, 211, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background-color: transparent;
      color: #32343a;
      border: 1.5px solid #32343a;
      border-radius: 60px;
      padding: 8px 16px;
      font-family: 'Dosis', sans-serif;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background-color: #32343a;
      color: #f2eadd;
    }
    
    /* ============================================================================
       SUCCESS/ERROR BOXES - MEMORIO THEMED
       ============================================================================ */
    .success-box {
      background-color: #e8f5e9;
      border: 2px solid #66bb6a;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .success-box h3 {
      color: #2e7d32;
      margin: 0 0 12px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .success-icon {
      width: 24px;
      height: 24px;
      display: inline-block;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .success-box p {
      color: #2e7d32;
      margin: 0 0 16px 0;
      font-size: 14px;
    }
    
    .credential-box {
      background-color: #f4e8de;
      border: 1.5px solid #436481;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .credential-label {
      font-size: 11px;
      color: #32343a;
      opacity: 0.6;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .credential-value {
      color: #32343a;
      font-size: 16px;
      font-weight: 600;
      word-break: break-all;
      font-family: monospace;
    }
    
    .copy-btn {
      background-color: #436481;
      color: #f2eadd;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .copy-btn:hover {
      background-color: #6ca7d3;
    }
    
    .error-box {
      background-color: #ffebee;
      border: 2px solid #ef5350;
      border-radius: 12px;
      padding: 15px;
      color: #c62828;
      margin-top: 20px;
      display: none;
      font-weight: 500;
    }
    
    /* ============================================================================
       CASES GRID - MEMORIO THEMED
       ============================================================================ */
    .cases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .case-card {
      background-color: #f4e8de;
      border: 2px solid #436481;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .case-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(67, 100, 129, 0.2);
      border-color: #6ca7d3;
    }
    
    .case-name {
      color: #32343a;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .case-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    
    .status-created {
      background-color: #fff3e0;
      color: #e65100;
      border: 1px solid #e65100;
    }
    
    .status-waiting {
      background-color: #e3f2fd;
      color: #01579b;
      border: 1px solid #01579b;
    }
    
    .status-submitted {
      background-color: #e8f5e9;
      color: #1b5e20;
      border: 1px solid #1b5e20;
    }
    
    .case-meta {
      font-size: 13px;
      color: #32343a;
      opacity: 0.6;
      margin: 8px 0;
    }
    
    /* ============================================================================
       SLA BADGES
       ============================================================================ */
    .sla-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      white-space: nowrap;
    }
    
    .sla-badge.green {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #66bb6a;
    }
    
    .sla-badge.orange {
      background-color: #fff3e0;
      color: #e65100;
      border: 1px solid #ff9800;
    }
    
    .sla-badge.red {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    
    .sla-badge.black {
      background-color: #212121;
      color: #ffffff;
      border: 1px solid #000000;
      font-weight: 700;
    }
    
    .sla-badge.waiting {
      background-color: #f5f5f5;
      color: #757575;
      border: 1px solid #e0e0e0;
    }
    
    /* ============================================================================
       MODAL - MEMORIO THEMED
       ============================================================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .modal-content {
      background-color: #fff3e9;
      border: 3px solid #436481;
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(67, 100, 129, 0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #436481;
    }
    
    .modal-title {
      color: #32343a;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: #f4e8de;
      border: 1.5px solid #436481;
      font-size: 24px;
      color: #32343a;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      font-weight: 300;
    }
    
    .modal-close:hover {
      background-color: #6ca7d3;
      color: #ffffff;
      border-color: #6ca7d3;
    }
    
    .modal-section {
      margin-bottom: 24px;
    }
    
    .modal-section-title {
      color: #32343a;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .modal-info-item {
      background-color: #f4e8de;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #436481;
    }
    
    .modal-info-label {
      font-size: 11px;
      color: #32343a;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 4px;
      opacity: 0.6;
      letter-spacing: 0.5px;
    }
    
    .modal-info-value {
      font-size: 14px;
      color: #32343a;
      font-weight: 600;
    }
    
    .credentials-section {
      background-color: #f4e8de;
      border: 2px solid #436481;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    
    .credentials-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .credentials-title {
      color: #32343a;
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    
    .reveal-btn {
      background-color: #436481;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .reveal-btn:hover {
      background-color: #6ca7d3;
    }
    
    .credentials-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .credential-item {
      background-color: #ffffff;
      border: 1px solid #436481;
      border-radius: 8px;
      padding: 12px;
    }
    
    .credential-value.blurred {
      filter: blur(8px);
      user-select: none;
    }
    
    /* ============================================================================
       TOAST NOTIFICATIONS
       ============================================================================ */
    .toast {
      position: fixed;
      top: 90px;
      right: 20px;
      background-color: #28a745;
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 3000;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.error {
      background-color: #dc3545;
    }
    
    /* ============================================================================
       RESPONSIVE DESIGN
       ============================================================================ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .topbar {
        left: 0;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .modal-info-grid {
        grid-template-columns: 1fr;
      }
      
      .credentials-grid {
        grid-template-columns: 1fr;
      }
      
      .cases-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Loading state */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <!-- ============================================================================
       SIDEBAR
       ============================================================================ -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <img src="../images/Screenshot_2025-03-29_at_6.43.40_PM-removebg-preview.png" alt="Memorio Logo">
    </div>
    
    <div class="sidebar-funeral-home">
      <div id="funeral-home-name" class="funeral-home-name">
        Loading funeral home...
      </div>
    </div>
    
    <div class="sidebar-nav">
      <div class="sidebar-nav-item active" onclick="switchSection('create-case')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        <span>Create Case</span>
      </div>
      
      <div class="sidebar-nav-item" onclick="switchSection('invite-family')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span>Invite Family</span>
      </div>
      
      <div class="sidebar-nav-item" onclick="switchSection('my-cases')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-5 3c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm4 8h-8v-1c0-1.33 2.67-2 4-2s4 .67 4 2v1z"/>
        </svg>
        <span>My Cases</span>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       TOP NAVBAR
       ============================================================================ -->
  <div class="topbar">
    <div class="topbar-left">
      <div>
        <h1 class="topbar-title" id="topbar-page-title">Create Case</h1>
      </div>
      <div class="topbar-search">
        <svg class="topbar-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input type="text" class="topbar-search-input" placeholder="Search cases..." id="search-input">
      </div>
    </div>
    
    <div class="topbar-right">
      <div class="topbar-profile" id="profile-toggle">
        <div class="topbar-profile-avatar">D</div>
        <span class="topbar-profile-name">Director</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7 10l5 5 5-5z"/>
        </svg>
        <div class="topbar-profile-dropdown">
          <div class="topbar-profile-dropdown-item" id="logout-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            <span>Logout</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       MAIN CONTENT
       ============================================================================ -->
  <div class="main-content">
    
    <!-- CREATE CASE SECTION -->
    <div id="create-case-section" class="content-section active">
      <div class="action-card">
        <h2 class="card-title">Create New Case</h2>
        <p class="card-description">Start a new memorial tribute case by providing the decedent's core information. This ensures we can create a complete obituary even if the family doesn't complete their portion.</p>
        
        <form id="create-case-form">
          <!-- Full Name -->
          <div class="form-row-single">
            <div class="form-group">
              <label for="deceased-name" class="form-label">Full Name (Loved One)*</label>
              <input 
                class="form-input" 
                type="text" 
                id="deceased-name" 
                placeholder="John Michael Doe" 
                required>
            </div>
          </div>
          
          <!-- Gender -->
          <div class="form-row-single">
            <div class="form-group">
              <label for="deceased-gender" class="form-label">Gender*</label>
              <select class="form-input" id="deceased-gender" required>
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
                <option value="prefer_not_to_say">Prefer not to say</option>
              </select>
            </div>
          </div>
          
          <!-- Date of Birth & Date of Death -->
          <div class="form-row">
            <div class="form-group">
              <label for="deceased-dob" class="form-label">Date of Birth*</label>
              <input 
                class="form-input" 
                type="date" 
                id="deceased-dob" 
                required>
            </div>
            <div class="form-group">
              <label for="deceased-dod" class="form-label">Date of Death*</label>
              <input 
                class="form-input" 
                type="date" 
                id="deceased-dod" 
                required>
            </div>
          </div>
          
          <!-- City of Birth & City of Death -->
          <div class="form-row">
            <div class="form-group">
              <label for="deceased-birth-city" class="form-label">City of Birth*</label>
              <input 
                class="form-input" 
                type="text" 
                id="deceased-birth-city" 
                placeholder="New York, NY" 
                required>
            </div>
            <div class="form-group">
              <label for="deceased-death-city" class="form-label">City of Death*</label>
              <input 
                class="form-input" 
                type="text" 
                id="deceased-death-city" 
                placeholder="Los Angeles, CA" 
                required>
            </div>
          </div>
          
          <!-- Service Date -->
          <div class="form-row-single">
            <div class="form-group">
              <label for="deceased-service-date" class="form-label">Service Date*</label>
              <input 
                class="form-input" 
                type="date" 
                id="deceased-service-date" 
                required>
            </div>
          </div>
          
          <button type="submit" class="btn-primary" id="create-case-btn">
            CREATE CASE
          </button>
        </form>
        
        <div id="case-success-box" class="success-box">
          <h3><span class="success-icon"></span>Case Created Successfully!</h3>
          <p>Case ID has been generated. You can now invite the family to complete the tribute form.</p>
          
          <div class="credential-box">
            <div class="credential-label">Case ID</div>
            <div class="credential-value" id="created-case-id"></div>
            <button class="copy-btn" onclick="copyToClipboard('created-case-id')">Copy</button>
          </div>
        </div>
        
        <div id="case-error-box" class="error-box"></div>
      </div>
    </div>

    <!-- INVITE FAMILY SECTION -->
    <div id="invite-family-section" class="content-section">
      <div class="action-card">
        <h2 class="card-title">Invite Family Member</h2>
        <p class="card-description">Send a secure invitation to a family member to complete the tribute form for their case.</p>
        
        <form id="invite-family-form">
          <div class="form-row">
            <div class="form-group">
              <label for="family-email" class="form-label">Email Address*</label>
              <input 
                class="form-input" 
                type="email" 
                id="family-email" 
                placeholder="family@example.com" 
                required>
            </div>
            
            <div class="form-group">
              <label for="family-name" class="form-label">Full Name*</label>
              <input 
                class="form-input" 
                type="text" 
                id="family-name" 
                placeholder="Jane Doe" 
                required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="family-phone" class="form-label">Phone Number</label>
              <input 
                class="form-input" 
                type="tel" 
                id="family-phone" 
                placeholder="+1-555-0123">
            </div>
            
            <div class="form-group">
              <label for="case-id" class="form-label">Case ID*</label>
              <input 
                class="form-input" 
                type="text" 
                id="case-id" 
                placeholder="Paste Case ID here" 
                required>
            </div>
          </div>
          
          <button type="submit" class="btn-primary" id="invite-family-btn">
            SEND INVITATION
          </button>
        </form>
        
        <div id="family-success-box" class="success-box">
          <h3><span class="success-icon"></span>Family Member Invited Successfully!</h3>
          <p>Share these credentials with the family member. They will need them to access the tribute form.</p>
          
          <div class="credential-box">
            <div class="credential-label">Email Address</div>
            <div class="credential-value" id="invited-email"></div>
            <button class="copy-btn" onclick="copyToClipboard('invited-email')">Copy</button>
          </div>
          
          <div class="credential-box">
            <div class="credential-label">Password</div>
            <div class="credential-value" id="family-password"></div>
            <button class="copy-btn" onclick="copyToClipboard('family-password')">Copy</button>
          </div>
        </div>
        
        <div id="family-error-box" class="error-box"></div>
      </div>
    </div>

    <!-- MY CASES SECTION -->
    <div id="my-cases-section" class="content-section">
      <div class="action-card">
        <h2 class="card-title">My Cases</h2>
        <p class="card-description">View and manage all memorial tribute cases for your organization.</p>
        
        <div id="cases-list" class="cases-grid">
          <!-- Cases will be loaded here dynamically -->
        </div>
        
        <div id="cases-error-box" class="error-box"></div>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       PASSWORD CHANGE MODAL (First Login)
       ============================================================================ -->
  <div id="password-change-modal" class="modal-overlay" style="display: none; z-index: 9999;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" style="border-bottom: 2px solid #436481;">
        <h2 class="modal-title">üîí Change Your Password</h2>
      </div>
      
      <div style="padding: 24px;">
        <p style="margin-bottom: 20px; color: #32343a; font-size: 15px;">
          For security reasons, you must change your temporary password before accessing the dashboard.
        </p>
        
        <form id="password-change-form">
          <div class="form-group">
            <label for="new-password" class="form-label">New Password*</label>
            <input 
              class="form-input" 
              type="password" 
              id="new-password" 
              placeholder="Enter new password" 
              minlength="8"
              required>
            <small style="color: rgba(50, 52, 58, 0.6); font-size: 12px; display: block; margin-top: 4px;">
              Must be at least 8 characters
            </small>
          </div>
          
          <div class="form-group">
            <label for="confirm-password" class="form-label">Confirm New Password*</label>
            <input 
              class="form-input" 
              type="password" 
              id="confirm-password" 
              placeholder="Confirm new password" 
              minlength="8"
              required>
          </div>
          
          <div id="password-error" class="error-box" style="display: none; margin-bottom: 16px;"></div>
          
          <button type="submit" class="btn-primary" id="change-password-btn" style="width: 100%;">
            CHANGE PASSWORD
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- ============================================================================
       CASE DETAILS MODAL
       ============================================================================ -->
  <div id="case-details-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-case-name">Case Details</h2>
        <button class="modal-close" onclick="closeCaseModal()">&times;</button>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">Case Information</h3>
        <div class="modal-info-grid">
          <div class="modal-info-item">
            <div class="modal-info-label">Case ID</div>
            <div class="modal-info-value" id="modal-case-id" style="font-size: 11px; word-break: break-all;">-</div>
            <button class="copy-btn" onclick="copyToClipboard('modal-case-id')">Copy Full ID</button>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Status</div>
            <div class="modal-info-value" id="modal-case-status">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Created</div>
            <div class="modal-info-value" id="modal-case-created">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Last Updated</div>
            <div class="modal-info-value" id="modal-case-updated">-</div>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">Family Information</h3>
        <div class="modal-info-grid">
          <div class="modal-info-item">
            <div class="modal-info-label">Family Member</div>
            <div class="modal-info-value" id="modal-family-name">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Email</div>
            <div class="modal-info-value" id="modal-family-email">-</div>
          </div>
        </div>
        
        <div class="credentials-section">
          <div class="credentials-header">
            <h4 class="credentials-title">Family Login Credentials</h4>
            <button class="reveal-btn" id="reveal-credentials-btn" onclick="revealCredentials()">Reveal</button>
          </div>
          <div class="credentials-grid">
            <div class="credential-item">
              <div class="credential-label">Email</div>
              <div class="credential-value blurred" id="modal-family-login-email">Click Reveal</div>
              <button class="copy-btn" onclick="copyToClipboard('modal-family-login-email')">Copy</button>
            </div>
            <div class="credential-item">
              <div class="credential-label">Password</div>
              <div class="credential-value blurred" id="modal-family-password">Click Reveal</div>
              <button class="copy-btn" onclick="copyToClipboard('modal-family-password')">Copy</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 class="modal-section-title">Form Status</h3>
        <div class="modal-info-grid">
          <div class="modal-info-item">
            <div class="modal-info-label">Form Status</div>
            <div class="modal-info-value" id="modal-form-status">-</div>
          </div>
          <div class="modal-info-item">
            <div class="modal-info-label">Submitted At</div>
            <div class="modal-info-value" id="modal-form-submitted">-</div>
          </div>
        </div>
      </div>
      
      <!-- Obituary Draft Section (Only shown when draft exists) -->
      <div class="modal-section" id="obituary-section" style="display: none;">
        <h3 class="modal-section-title">üìù Obituary Draft</h3>
        <div style="
          background-color: #f4e8de;
          border: 1.5px solid #436481;
          border-radius: 8px;
          padding: 20px;
          max-height: 400px;
          overflow-y: auto;
        ">
          <div id="obituary-content" style="
            font-size: 15px;
            line-height: 1.8;
            color: #32343a;
          ">
            <!-- Obituary HTML will be inserted here -->
          </div>
        </div>
        <div style="margin-top: 12px; font-size: 13px; color: rgba(50, 52, 58, 0.6);">
          Last updated: <span id="obituary-updated">-</span>
        </div>
      </div>
      
      <div style="margin-top: 24px; display: flex; gap: 12px;">
        <button class="btn-secondary" onclick="deleteCase(currentCaseDetails.id, currentCaseDetails.deceased_name)">
          Delete Case
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://gkabtvqwwuvigcdubwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrYWJ0dnF3d3V2aWdjZHVid3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDE5MjUsImV4cCI6MjA3NTQ3NzkyNX0.O1DfOR5FBm6r3Pg-tjEE5CkzRr3WlWqGU1xUYKrhtnU';
    
    const { createClient } = supabase;
    
    // Initialize Supabase client with proper session persistence
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,           // Automatically refresh token before expiry
        persistSession: true,              // Persist session to localStorage
        detectSessionInUrl: true,          // Detect OAuth sessions in URL
        storage: window.localStorage,      // Use localStorage for session persistence
        storageKey: 'memorio-director-auth', // Unique key per portal
      }
    });
    
    // Global auth state
    let isAuthenticated = false;
    let currentSession = null;
    let currentCaseDetails = null;
    let credentialsRevealed = false;
    let allCases = []; // Store all cases for filtering
    
    // Set up automatic token refresh and session monitoring
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      console.log('üîê Auth state changed:', event, session?.user?.email);
      
      // Update session state but DON'T redirect (let checkAuth handle redirects)
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        currentSession = session;
        isAuthenticated = !!session;
        console.log('‚úÖ Session updated/refreshed successfully');
      }
      
      if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
        isAuthenticated = false;
        currentSession = null;
        console.log('‚ö†Ô∏è User signed out');
        // Don't redirect here - it causes loops. Let checkAuth handle redirects.
      }
      
      if (event === 'TOKEN_REFRESHED') {
        console.log('üîÑ Access token auto-refreshed - no action needed');
      }
    });
    
    // Enhanced auth check with proper session handling
    async function checkAuth() {
      console.log('=== DIRECTOR AUTHENTICATION CHECK ===');
      
      try {
        // Get session from localStorage (persisted)
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          console.error('Session error:', sessionError);
          throw new Error('Session retrieval failed');
        }
        
        if (!session) {
          console.error('No session found - redirecting to login');
          window.location.href = 'login.html';
          return false;
        }
        
        console.log('Session exists:', !!session);
        console.log('User Email:', session.user.email);
        console.log('JWT app_metadata:', session.user.app_metadata);
        
        // Store session globally
        currentSession = session;
        
        // Verify director role from database and fetch organization name
        const { data: userData, error } = await supabaseClient
          .from('users')
          .select('role, org_id, metadata, organizations (name)')
          .eq('id', session.user.id)
          .single();
        
        console.log('Database user data:', userData);
        
        if (error || !userData || userData.role !== 'director') {
          console.error('‚ùå Not a director or user not found');
          await supabaseClient.auth.signOut();
          window.location.href = 'login.html';
          return false;
        }
        
        // Check if user needs to change password (first login)
        if (userData.metadata?.requires_password_change === true) {
          console.log('‚ö†Ô∏è First login detected - forcing password change');
          showPasswordChangeModal();
          return false; // Block dashboard access
        }
        
        // Display funeral home name in topbar
        const funeralHomeElement = document.getElementById('funeral-home-name');
        if (userData.organizations && userData.organizations.name) {
          funeralHomeElement.textContent = userData.organizations.name;
        } else {
          funeralHomeElement.textContent = 'Funeral Home';
        }
        
        // Check JWT role (secondary check)
        const jwtRole = session.user.app_metadata?.role;
        const jwtOrgId = session.user.app_metadata?.org_id;
        
        console.log('JWT Role from app_metadata:', jwtRole);
        console.log('JWT Org ID from app_metadata:', jwtOrgId);
        
        if (!jwtRole || !jwtOrgId) {
          console.warn('‚ö†Ô∏è WARNING: app_metadata missing in JWT - refreshing session...');
          // Refresh session to get updated JWT
          const { data: refreshData } = await supabaseClient.auth.refreshSession();
          if (refreshData?.session) {
            currentSession = refreshData.session;
            console.log('‚úÖ Session refreshed, JWT updated');
          }
        } else {
          console.log('‚úÖ JWT app_metadata role and org_id are correct');
        }
        
        isAuthenticated = true;
        console.log('‚úÖ Director authentication successful');
        console.log('Director Org ID:', userData.org_id);
        console.log('=== END AUTH CHECK ===\n');
        return true;
        
      } catch (error) {
        console.error('‚ùå Auth check failed:', error);
        window.location.href = 'login.html';
        return false;
      }
    }
    
    // Helper function to get valid session (with auto-refresh if needed)
    async function getValidSession() {
      if (!currentSession) {
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentSession = session;
      }
      
      // If session is close to expiry, refresh it
      if (currentSession) {
        const expiresAt = currentSession.expires_at;
        const now = Math.floor(Date.now() / 1000);
        const timeUntilExpiry = expiresAt - now;
        
        // Refresh if less than 5 minutes until expiry
        if (timeUntilExpiry < 300) {
          console.log('üîÑ Session expiring soon, refreshing...');
          const { data: refreshData, error } = await supabaseClient.auth.refreshSession();
          if (!error && refreshData.session) {
            currentSession = refreshData.session;
            console.log('‚úÖ Session refreshed successfully');
          }
        }
      }
      
      if (!currentSession) {
        throw new Error('No valid session - please log in again');
      }
      
      return currentSession;
    }
    
    // Initialize app - authenticate FIRST, then load data
    async function initializeApp() {
      const authSuccess = await checkAuth();
      
      if (authSuccess) {
        // Only load data after successful authentication
        console.log('üöÄ Loading cases...');
        await loadCases();
        console.log('‚úÖ App initialization complete');
      }
    }
    
    // Run initialization on page load
    initializeApp();
    
    // Profile dropdown toggle
    document.getElementById('profile-toggle').addEventListener('click', function(e) {
      e.stopPropagation();
      this.classList.toggle('open');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      document.getElementById('profile-toggle').classList.remove('open');
    });
    
    // Logout handler
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    });
    
    // Section switching
    function switchSection(sectionName) {
      // Update topbar title
      const titles = {
        'create-case': 'Create Case',
        'invite-family': 'Invite Family',
        'my-cases': 'My Cases'
      };
      document.getElementById('topbar-page-title').textContent = titles[sectionName];
      
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.sidebar-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(`${sectionName}-section`).classList.add('active');
      
      // Add active class to clicked nav item
      event.target.closest('.sidebar-nav-item').classList.add('active');
      
      // Load cases if switching to my-cases
      if (sectionName === 'my-cases') {
        loadCases();
      }
    }
    
    // ============================================================================
    // PASSWORD CHANGE (First Login)
    // ============================================================================
    
    function showPasswordChangeModal() {
      const modal = document.getElementById('password-change-modal');
      modal.style.display = 'flex';
      
      // Disable all other UI elements
      document.querySelector('.sidebar').style.pointerEvents = 'none';
      document.querySelector('.topbar').style.pointerEvents = 'none';
      document.querySelector('.main-content').style.pointerEvents = 'none';
    }
    
    // Password change form handler
    document.getElementById('password-change-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const errorBox = document.getElementById('password-error');
      const submitBtn = document.getElementById('change-password-btn');
      
      errorBox.style.display = 'none';
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        errorBox.textContent = 'Passwords do not match';
        errorBox.style.display = 'block';
        return;
      }
      
      // Validate password length
      if (newPassword.length < 8) {
        errorBox.textContent = 'Password must be at least 8 characters';
        errorBox.style.display = 'block';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'CHANGING PASSWORD...';
      
      try {
        // Update password in Supabase Auth
        const { error: passwordError } = await supabaseClient.auth.updateUser({
          password: newPassword
        });
        
        if (passwordError) throw passwordError;
        
        // Clear the requires_password_change flag in user metadata
        const session = await getValidSession();
        if (!session) throw new Error('Session expired');
        
        const { error: metadataError } = await supabaseClient
          .from('users')
          .update({
            metadata: {
              ...currentSession.user.user_metadata,
              requires_password_change: false,
              password_changed_at: new Date().toISOString()
            }
          })
          .eq('id', session.user.id);
        
        if (metadataError) throw metadataError;
        
        // Success! Hide modal and enable UI
        document.getElementById('password-change-modal').style.display = 'none';
        document.querySelector('.sidebar').style.pointerEvents = 'auto';
        document.querySelector('.topbar').style.pointerEvents = 'auto';
        document.querySelector('.main-content').style.pointerEvents = 'auto';
        
        showToast('Password changed successfully! Welcome to Memorio.');
        
        // Re-run checkAuth to proceed with dashboard
        await checkAuth();
        
      } catch (error) {
        console.error('Error changing password:', error);
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'CHANGE PASSWORD';
      }
    });
    
    // Make functions global
    window.switchSection = switchSection;
    window.openCaseModal = openCaseModal;
    window.closeCaseModal = closeCaseModal;
    window.revealCredentials = revealCredentials;
    window.copyToClipboard = copyToClipboard;
    window.deleteCase = deleteCase;
    
    // Toast notification
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Copy to clipboard
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) {
        console.error('Element not found:', elementId);
        showToast('Element not found', true);
        return;
      }
      
      const text = element.textContent;
      const btn = event && event.target;
      
      navigator.clipboard.writeText(text).then(() => {
        console.log('Successfully copied to clipboard:', text);
        
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          btn.style.backgroundColor = '#28a745';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.backgroundColor = '';
          }, 2000);
        }
        
        showToast('Copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        showToast('Failed to copy to clipboard', true);
      });
    }
    
    // Case modal functions
    async function openCaseModal(caseId) {
      const modal = document.getElementById('case-details-modal');
      modal.style.display = 'flex';
      
      credentialsRevealed = false;
      document.getElementById('reveal-credentials-btn').textContent = 'Reveal';
      document.getElementById('modal-family-login-email').textContent = 'Click Reveal';
      document.getElementById('modal-family-password').textContent = 'Click Reveal';
      document.getElementById('modal-family-login-email').classList.add('blurred');
      document.getElementById('modal-family-password').classList.add('blurred');
      
      try {
        const { data: caseData, error: caseError } = await supabaseClient
          .from('cases')
          .select('*')
          .eq('id', caseId)
          .single();
        
        if (caseError) throw caseError;
        
        currentCaseDetails = caseData;
        
        let familyData = null;
        let familyPassword = null;
        if (caseData.assigned_family_user_id) {
          const { data: familyUser, error: familyError } = await supabaseClient
            .from('users')
            .select('email, metadata')
            .eq('id', caseData.assigned_family_user_id)
            .single();
          
          if (!familyError) {
            familyData = familyUser;
            familyPassword = familyUser.metadata?.temp_password || null;
          }
        }
        
        const { data: formData, error: formError } = await supabaseClient
          .from('forms')
          .select('*')
          .eq('case_id', caseId)
          .single();
        
        const stage = getCaseStage(caseData.status);
        
        document.getElementById('modal-case-name').textContent = caseData.deceased_name;
        document.getElementById('modal-case-id').textContent = caseData.id;
        document.getElementById('modal-case-status').textContent = `${stage.emoji} ${stage.label}`;
        document.getElementById('modal-case-created').textContent = new Date(caseData.created_at).toLocaleDateString();
        document.getElementById('modal-case-updated').textContent = new Date(caseData.updated_at).toLocaleDateString();
        
        if (familyData) {
          document.getElementById('modal-family-name').textContent = familyData.metadata?.name || 'Family Member';
          document.getElementById('modal-family-email').textContent = familyData.email;
          document.getElementById('modal-family-login-email').textContent = familyData.email;
        } else {
          document.getElementById('modal-family-name').textContent = 'Not assigned';
          document.getElementById('modal-family-email').textContent = 'Not assigned';
          document.getElementById('modal-family-login-email').textContent = 'Not assigned';
        }
        
        if (formData && formData.submitted_at) {
          document.getElementById('modal-form-status').textContent = 'Submitted';
          document.getElementById('modal-form-submitted').textContent = new Date(formData.submitted_at).toLocaleDateString();
        } else {
          document.getElementById('modal-form-status').textContent = 'Not submitted';
          document.getElementById('modal-form-submitted').textContent = '-';
        }
        
        if (familyPassword) {
          document.getElementById('modal-family-password').textContent = familyPassword;
        } else {
          document.getElementById('modal-family-password').textContent = 'Password not available';
        }
        
        // Fetch obituary content if it exists
        const { data: obituaryData, error: obituaryError } = await supabaseClient
          .from('obituary_content')
          .select('content_html, updated_at')
          .eq('case_id', caseId)
          .single();
        
        console.log('üìù Obituary query result:', { obituaryData, obituaryError });
        
        const obituarySection = document.getElementById('obituary-section');
        const obituaryContent = document.getElementById('obituary-content');
        const obituaryUpdated = document.getElementById('obituary-updated');
        
        if (!obituaryError && obituaryData && obituaryData.content_html) {
          // Show obituary section
          console.log('‚úÖ Showing obituary section');
          obituarySection.style.display = 'block';
          obituaryContent.innerHTML = obituaryData.content_html;
          obituaryUpdated.textContent = new Date(obituaryData.updated_at).toLocaleString();
        } else {
          // Hide obituary section if no content
          console.log('‚ùå Hiding obituary section:', obituaryError?.message || 'No content');
          obituarySection.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error loading case details:', error);
        showToast('Error loading case details', true);
        closeCaseModal();
      }
    }
    
    function closeCaseModal() {
      document.getElementById('case-details-modal').style.display = 'none';
      currentCaseDetails = null;
      credentialsRevealed = false;
    }
    
    function revealCredentials() {
      const revealBtn = document.getElementById('reveal-credentials-btn');
      const emailElement = document.getElementById('modal-family-login-email');
      const passwordElement = document.getElementById('modal-family-password');
      
      if (!credentialsRevealed) {
        emailElement.classList.remove('blurred');
        passwordElement.classList.remove('blurred');
        revealBtn.textContent = 'Hide';
        credentialsRevealed = true;
      } else {
        emailElement.classList.add('blurred');
        passwordElement.classList.add('blurred');
        revealBtn.textContent = 'Reveal';
        credentialsRevealed = false;
      }
    }
    
    // Close modal when clicking outside
    document.getElementById('case-details-modal').addEventListener('click', (e) => {
      if (e.target.id === 'case-details-modal') {
        closeCaseModal();
      }
    });
    
    // Delete case function (also deletes associated family user)
    async function deleteCase(caseId, caseName) {
      if (!confirm(`Are you sure you want to delete the case for "${caseName}"?\n\nThis will also permanently delete the associated family member's account.\n\nThis action cannot be undone.`)) {
        return;
      }
      
      try {
        // First, get the case to find the assigned family user
        const { data: caseData, error: caseError } = await supabaseClient
          .from('cases')
          .select('assigned_family_user_id')
          .eq('id', caseId)
          .single();
        
        if (caseError) throw caseError;
        
        const familyUserId = caseData?.assigned_family_user_id;
        
        // Delete the case first (this will cascade to related records)
        const { error: deleteError } = await supabaseClient
          .from('cases')
          .delete()
          .eq('id', caseId);
        
        if (deleteError) throw deleteError;
        
        // If there was a family user assigned, delete them completely
        if (familyUserId) {
          console.log(`Deleting associated family user: ${familyUserId}`);
          
          const session = await getValidSession();
          const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-user`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json',
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({
              user_id: familyUserId,
              reason: 'Case deleted by director'
            })
          });
          
          const result = await response.json();
          
          if (!response.ok || !result.success) {
            console.warn('Failed to delete family user:', result.error);
            // Don't throw error - case is already deleted, this is cleanup
            showToast(`Case deleted, but failed to delete family account: ${result.error}`, true);
          } else {
            console.log('‚úÖ Family user deleted successfully');
            showToast(`Case and family account for "${caseName}" deleted successfully`);
          }
        } else {
          showToast(`Case for "${caseName}" deleted successfully`);
        }
        
        closeCaseModal();
        await loadCases();
        
      } catch (error) {
        console.error('Error deleting case:', error);
        showToast(`Failed to delete case: ${error.message}`, true);
      }
    }
    
    // Create Case form handler
    document.getElementById('create-case-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Capture all required decedent information
      const caseData = {
        deceased_name: document.getElementById('deceased-name').value,
        gender: document.getElementById('deceased-gender').value,
        date_of_birth: document.getElementById('deceased-dob').value,
        date_of_death: document.getElementById('deceased-dod').value,
        city_of_birth: document.getElementById('deceased-birth-city').value,
        city_of_death: document.getElementById('deceased-death-city').value,
        service_date: document.getElementById('deceased-service-date').value
      };
      
      const createBtn = document.getElementById('create-case-btn');
      const successBox = document.getElementById('case-success-box');
      const errorBox = document.getElementById('case-error-box');
      const section = e.target.closest('.action-card');
      
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      section.classList.add('loading');
      createBtn.disabled = true;
      createBtn.textContent = 'CREATING CASE...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        console.log('=== CREATING CASE ===');
        console.log('Case Data:', caseData);
        console.log('Session:', session?.user?.email);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/create-case`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify(caseData)
        });
        
        console.log('Response Status:', response.status);
        const result = await response.json();
        console.log('Response Result:', result);
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create case');
        }
        
        console.log('‚úÖ Case created successfully:', result.data.case_id);
        document.getElementById('created-case-id').textContent = result.data.case_id;
        successBox.style.display = 'block';
        document.getElementById('create-case-form').reset();
        
        // Reload cases to show the new case
        await loadCases();
        
      } catch (error) {
        console.error('‚ùå Error creating case:', error);
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        createBtn.disabled = false;
        createBtn.textContent = 'CREATE CASE';
      }
    });
    
    // Invite Family form handler
    document.getElementById('invite-family-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('family-email').value;
      const name = document.getElementById('family-name').value;
      const phone = document.getElementById('family-phone').value;
      const caseId = document.getElementById('case-id').value;
      
      const inviteBtn = document.getElementById('invite-family-btn');
      const successBox = document.getElementById('family-success-box');
      const errorBox = document.getElementById('family-error-box');
      const section = e.target.closest('.action-card');
      
      successBox.style.display = 'none';
      errorBox.style.display = 'none';
      
      section.classList.add('loading');
      inviteBtn.disabled = true;
      inviteBtn.textContent = 'SENDING INVITATION...';
      
      try {
        // Get valid session (will auto-refresh if needed)
        const session = await getValidSession();
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/invite-family`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            email,
            name,
            case_id: caseId,
            phone: phone || undefined
          })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to invite family member');
        }
        
        document.getElementById('invited-email').textContent = result.data.email;
        
        if (result.data.temp_password) {
          document.getElementById('family-password').textContent = result.data.temp_password;
          
          if (result.data.user_id) {
            try {
              // Fetch existing metadata first to preserve requires_password_change flag
              const { data: existingUser } = await supabaseClient
                .from('users')
                .select('metadata')
                .eq('id', result.data.user_id)
                .single();
              
              // Merge new fields with existing metadata (preserve requires_password_change)
              await supabaseClient
                .from('users')
                .update({ 
                  metadata: { 
                    ...(existingUser?.metadata || {}),  // Keep all existing fields
                    temp_password: result.data.temp_password,
                    password_created_at: new Date().toISOString()
                  }
                })
                .eq('id', result.data.user_id);
            } catch (updateError) {
              console.error('Failed to store password in metadata:', updateError);
            }
          }
        } else {
          document.getElementById('family-password').textContent = 'ERROR: No credentials received';
        }
        
        successBox.style.display = 'block';
        document.getElementById('invite-family-form').reset();
        
      } catch (error) {
        errorBox.textContent = `Error: ${error.message}`;
        errorBox.style.display = 'block';
      } finally {
        section.classList.remove('loading');
        inviteBtn.disabled = false;
        inviteBtn.textContent = 'SEND INVITATION';
      }
    });
    
    // Load cases
    // Get video/QC status badge HTML
    // Map database status to workflow stage
    function getCaseStage(status) {
      // Waiting on Family: Case created, waiting for family to complete intake
      if (['created', 'waiting_on_family', 'intake_in_progress'].includes(status)) {
        return {
          label: 'Waiting on Family',
          color: '#ff9800', // Orange
          emoji: '‚è≥'
        };
      }
      
      // In Progress: Family submitted, editor working
      if (['submitted', 'in_production'].includes(status)) {
        return {
          label: 'In Progress',
          color: '#2196f3', // Blue
          emoji: 'üé¨'
        };
      }
      
      // Awaiting Review: Video submitted to QC
      if (['awaiting_review', 'revision_requested'].includes(status)) {
        return {
          label: 'Awaiting Review',
          color: '#9c27b0', // Purple
          emoji: 'üîç'
        };
      }
      
      // Complete: Delivered to family
      if (['delivered', 'closed'].includes(status)) {
        return {
          label: 'Complete',
          color: '#4caf50', // Green
          emoji: '‚úÖ'
        };
      }
      
      // Fallback
      return {
        label: status.replace(/_/g, ' '),
        color: '#9e9e9e', // Grey
        emoji: 'üìù'
      };
    }
    
    function getVideoStatusBadge(status) {
      const statusConfig = {
        'in_production': { text: 'üé¨ Editor Working', color: '#9c27b0' },
        'awaiting_review': { text: '‚è≥ Pending QC', color: '#ff9800' },
        'revision_requested': { text: 'üîÑ Revision Needed', color: '#f44336' },
        'delivered': { text: '‚úÖ Delivered', color: '#4caf50' }
      };
      
      const config = statusConfig[status];
      if (!config) return '';
      
      return `
        <div style="
          background-color: ${config.color}15;
          border: 1.5px solid ${config.color};
          color: ${config.color};
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          margin-top: 8px;
          display: inline-block;
        ">
          ${config.text}
        </div>
      `;
    }
    
    async function loadCases() {
      const casesList = document.getElementById('cases-list');
      const errorBox = document.getElementById('cases-error-box');
      
      errorBox.style.display = 'none';
      casesList.innerHTML = '<p style="color: #32343a; opacity: 0.6;">Loading cases...</p>';
      
      try {
        const { data: cases, error } = await supabaseClient
          .from('cases')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allCases = cases || [];
        renderCases(allCases);
        
      } catch (error) {
        errorBox.textContent = `Error loading cases: ${error.message}`;
        errorBox.style.display = 'block';
        casesList.innerHTML = '';
      }
    }
    
    // Helper function to generate SLA badge HTML
    function getSLABadge(caseData) {
      // If case is delivered or closed, show completion badge
      if (caseData.status === 'delivered' || caseData.status === 'closed') {
        return '<span class="sla-badge green">‚úì Delivered</span>';
      }
      
      // If no submission yet (waiting on family), show waiting badge
      if (!caseData.first_submission_at || caseData.status === 'waiting_on_family') {
        return '<span class="sla-badge waiting">‚è≥ Waiting on Family</span>';
      }
      
      // Calculate hours elapsed since submission
      const submissionTime = new Date(caseData.first_submission_at);
      const now = new Date();
      const hoursElapsed = (now - submissionTime) / (1000 * 60 * 60);
      
      // Determine badge based on thresholds
      let badgeClass, badgeText;
      
      if (hoursElapsed < 24) {
        // Green: < 24 hours
        badgeClass = 'green';
        badgeText = `${Math.floor(hoursElapsed)}h`;
      } else if (hoursElapsed < 36) {
        // Orange: 24-36 hours
        badgeClass = 'orange';
        badgeText = `${Math.floor(hoursElapsed)}h`;
      } else if (hoursElapsed < 48) {
        // Red: 36-48 hours
        badgeClass = 'red';
        badgeText = `${Math.floor(hoursElapsed)}h`;
      } else {
        // Black: 48+ hours (BREACH)
        badgeClass = 'black';
        badgeText = `${Math.floor(hoursElapsed)}h BREACH`;
      }
      
      return `<span class="sla-badge ${badgeClass}">${badgeText}</span>`;
    }
    
    // Render cases to the list
    function renderCases(cases) {
      const casesList = document.getElementById('cases-list');
      
      if (!cases || cases.length === 0) {
        casesList.innerHTML = '<p style="color: #32343a; opacity: 0.6;">No cases found. Create your first case to get started!</p>';
        return;
      }
      
      casesList.innerHTML = cases.map(c => {
        const stage = getCaseStage(c.status);
        const slaBadge = getSLABadge(c);
        return `
          <div class="case-card" onclick="openCaseModal('${c.id}')">
            <div class="case-name">${c.deceased_name}</div>
            ${slaBadge}
            <div style="
              background-color: ${stage.color}15;
              border: 1.5px solid ${stage.color};
              color: ${stage.color};
              padding: 8px 14px;
              border-radius: 20px;
              font-size: 13px;
              font-weight: 600;
              margin-top: 8px;
              display: inline-block;
            ">
              ${stage.emoji} ${stage.label}
            </div>
            ${getVideoStatusBadge(c.status)}
            <p class="case-meta">Created: ${new Date(c.created_at).toLocaleDateString()}</p>
            <div class="credential-box" style="margin-top: 12px;">
              <div class="credential-label">Case ID</div>
              <div class="credential-value" id="case-id-${c.id}" style="font-size: 11px; word-break: break-all;">${c.id}</div>
              <button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard('case-id-${c.id}')">Copy</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Search functionality - filters by name or case ID
    function filterCases(searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        renderCases(allCases);
        return;
      }
      
      const term = searchTerm.toLowerCase().trim();
      const filtered = allCases.filter(c => {
        const name = c.deceased_name.toLowerCase();
        const caseId = c.id.toLowerCase();
        return name.includes(term) || caseId.includes(term);
      });
      
      renderCases(filtered);
    }
    
    // Attach search event listener
    document.getElementById('search-input').addEventListener('input', (e) => {
      filterCases(e.target.value);
    });
  </script>
</body>
</html>
